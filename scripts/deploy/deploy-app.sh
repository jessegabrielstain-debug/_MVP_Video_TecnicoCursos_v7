#!/bin/bash
# ============================================
# MVP Video TÃ©cnicoCursos v7 - Deploy App
# Execute com: curl -fsSL https://raw.githubusercontent.com/jessegabrielstain-debug/_MVP_Video_TecnicoCursos_v7/main/scripts/deploy/deploy-app.sh | bash
# ============================================

set -e

echo ""
echo "ğŸš€ ============================================"
echo "ğŸš€ Iniciando Deploy da AplicaÃ§Ã£o"
echo "ğŸš€ ============================================"
echo ""

# VariÃ¡veis
REPO_URL="https://github.com/jessegabrielstain-debug/_MVP_Video_TecnicoCursos_v7.git"
APP_DIR="/opt/mvp"
PROJECT_DIR="$APP_DIR/_MVP_Video_TecnicoCursos_v7"

# 1. Criar diretÃ³rio
echo "ğŸ“ Criando diretÃ³rio da aplicaÃ§Ã£o..."
mkdir -p $APP_DIR
cd $APP_DIR

# 2. Clonar ou atualizar repositÃ³rio
if [ -d "$PROJECT_DIR" ]; then
    echo "ğŸ“¦ Atualizando repositÃ³rio existente..."
    cd $PROJECT_DIR
    git fetch origin
    git reset --hard origin/main
else
    echo "ğŸ“¦ Clonando repositÃ³rio..."
    git clone $REPO_URL
    cd $PROJECT_DIR
fi

# 3. Criar diretÃ³rios necessÃ¡rios
echo "ğŸ“ Criando diretÃ³rios necessÃ¡rios..."
mkdir -p redis nginx/ssl logs/nginx nginx/snippets

# 4. Criar redis.conf
echo "âš™ï¸ Configurando Redis..."
cat > redis/redis.conf <<'REDIS_EOF'
bind 0.0.0.0
protected-mode no
port 6379
save 60 1000
appendonly yes
appendfsync everysec
maxmemory 512mb
maxmemory-policy allkeys-lru
loglevel notice
REDIS_EOF

# 5. Criar snippets do Nginx
echo "âš™ï¸ Configurando Nginx snippets..."
cat > nginx/snippets/security-headers.conf <<'NGINX_SECURITY'
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
NGINX_SECURITY

cat > nginx/snippets/proxy-params.conf <<'NGINX_PROXY'
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection 'upgrade';
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_cache_bypass $http_upgrade;
NGINX_PROXY

# 6. Criar docker-compose.override.yml
echo "âš™ï¸ Configurando Docker Compose override..."
cat > docker-compose.override.yml <<'OVERRIDE_EOF'
services:
  nginx:
    volumes:
      - ./nginx/snippets:/etc/nginx/snippets:ro
OVERRIDE_EOF

# 7. Ajustar Nginx para aceitar qualquer host
echo "âš™ï¸ Ajustando Nginx server_name..."
if [ -f nginx/conf.d/app.conf ]; then
    sed -i 's/server_name tecnicocursos.com www.tecnicocursos.com;/server_name _;/' nginx/conf.d/app.conf
    echo "âœ… Nginx configurado para aceitar qualquer host"
else
    echo "âš ï¸ nginx/conf.d/app.conf nÃ£o encontrado"
fi

# 8. Criar .env.production se nÃ£o existir
if [ ! -f .env.production ]; then
    echo "âš™ï¸ Criando .env.production..."
    cat > .env.production <<'ENV_EOF'
# ============================================
# Production Environment Variables
# Generated by deploy-app.sh
# ============================================

NODE_ENV=production

# Redis
REDIS_URL=redis://redis:6379

# Logging
LOG_LEVEL=info

# Admin Panel
ADMIN_EMAIL=admin@tecnicocursos.com
ADMIN_PASSWORD=Admin@123

# Supabase (preencher depois no painel admin)
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
DIRECT_DATABASE_URL=

# APIs (preencher depois no painel admin)
ELEVENLABS_API_KEY=
HEYGEN_API_KEY=
OPENAI_API_KEY=
ENV_EOF
    echo "âœ… .env.production criado"
else
    echo "âœ… .env.production jÃ¡ existe"
fi

# 9. Verificar Docker
echo ""
echo "ğŸ³ Verificando Docker..."
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker nÃ£o instalado!"
    exit 1
fi

if ! docker info &> /dev/null; then
    echo "âŒ Docker nÃ£o estÃ¡ rodando!"
    exit 1
fi

echo "âœ… Docker OK"

# 10. Parar containers existentes
echo ""
echo "ğŸ›‘ Parando containers existentes..."
docker compose -f docker-compose.prod.yml down 2>/dev/null || true

# 11. Build e Start
echo ""
echo "ğŸ”¨ Construindo e iniciando containers..."
echo "â±ï¸ Isso pode levar 5-15 minutos na primeira vez..."
echo ""

docker compose -f docker-compose.prod.yml up -d --build

# 12. Aguardar containers iniciarem
echo ""
echo "â³ Aguardando containers iniciarem..."
sleep 10

# 13. Verificar status
echo ""
echo "ğŸ“Š Status dos containers:"
docker compose -f docker-compose.prod.yml ps

# 14. Verificar health
echo ""
echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
for i in {1..30}; do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health | grep -q "200"; then
        echo "âœ… AplicaÃ§Ã£o respondendo!"
        break
    fi
    echo "â³ Tentativa $i/30..."
    sleep 5
done

# 15. Resultado final
echo ""
echo "ğŸ‰ ============================================"
echo "ğŸ‰ DEPLOY CONCLUÃDO!"
echo "ğŸ‰ ============================================"
echo ""
echo "ğŸ“ Acesse:"
echo "   â€¢ AplicaÃ§Ã£o:    http://$(curl -s ifconfig.me 2>/dev/null || echo '168.231.90.64')"
echo "   â€¢ Admin Panel:  http://$(curl -s ifconfig.me 2>/dev/null || echo '168.231.90.64')/admin/login"
echo ""
echo "ğŸ” Credenciais Admin:"
echo "   â€¢ Email: admin@tecnicocursos.com"
echo "   â€¢ Senha: Admin@123"
echo ""
echo "ğŸ“ PrÃ³ximo passo:"
echo "   Acesse o painel admin e configure as credenciais:"
echo "   - Supabase URL e Keys"
echo "   - ElevenLabs API Key"
echo "   - HeyGen API Key"
echo ""
echo "ğŸ”§ Comandos Ãºteis:"
echo "   â€¢ Ver logs:     docker compose -f docker-compose.prod.yml logs -f"
echo "   â€¢ Reiniciar:    docker compose -f docker-compose.prod.yml restart"
echo "   â€¢ Parar:        docker compose -f docker-compose.prod.yml down"
echo ""
