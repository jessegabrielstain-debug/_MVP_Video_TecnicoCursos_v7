"use strict";(()=>{var e={};e.id=358,e.ids=[358,3474],e.modules={453524:e=>{e.exports=require("@prisma/client")},572934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},554580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},345869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},627790:e=>{e.exports=require("assert")},978893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},986624:e=>{e.exports=require("querystring")},917360:e=>{e.exports=require("url")},521764:e=>{e.exports=require("util")},671568:e=>{e.exports=require("zlib")},524922:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{GET:()=>l});var n=a(349303),o=a(88716),i=a(60670),s=a(387070),d=a(95715),u=a(491284),c=a(303474);async function p(e){try{let t=await (0,d.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return s.NextResponse.json({error:"Authentication required"},{status:401});let{searchParams:a}=new URL(e.url),r=a.get("period")||"7d",n=a.get("organizationId")||(0,u.Uu)(t.user),o=new Date;switch(r){case"7d":default:o.setDate(o.getDate()-7);break;case"30d":o.setDate(o.getDate()-30);break;case"90d":o.setDate(o.getDate()-90)}let i={createdAt:{gte:o},...n&&{organizationId:n}},p=(e,t)=>{if(e&&"object"==typeof e&&t in e){let a=e[t];return"string"==typeof a?a:null!=a?String(a):void 0}},l=e=>"number"==typeof e?e:Number(e??0),[m,g,y,v,_,h,w,b,x,E]=await Promise.all([c.prisma.analyticsEvent.count({where:i}),c.prisma.analyticsEvent.count({where:{...i,createdAt:{gte:new Date(Date.now()-6048e5)}}}),c.prisma.analyticsEvent.count({where:{...i,status:"error"}}),c.prisma.analyticsEvent.groupBy({by:["category"],where:i,_count:{id:!0},orderBy:{_count:{id:"desc"}}}),c.prisma.analyticsEvent.groupBy({by:["action"],where:i,_count:{id:!0},orderBy:{_count:{id:"desc"}}}),c.prisma.analyticsEvent.findMany({where:i,orderBy:{createdAt:"desc"},take:20,select:{id:!0,category:!0,action:!0,label:!0,status:!0,duration:!0,fileSize:!0,createdAt:!0}}),c.prisma.$queryRaw`
        SELECT 
          DATE(created_at) as date,
          COUNT(*) as events,
          COUNT(CASE WHEN status = 'error' THEN 1 END) as errors,
          COUNT(DISTINCT user_id) as users
        FROM analytics_event 
        WHERE created_at >= ${o}
        ${n?c.prisma.$queryRaw`AND organization_id = ${n}`:c.prisma.$queryRaw``}
        GROUP BY DATE(created_at)
        ORDER BY date DESC
        LIMIT 30
      `,c.prisma.analyticsEvent.aggregate({where:{...i,duration:{not:null}},_avg:{duration:!0,fileSize:!0},_max:{duration:!0},_min:{duration:!0}}),c.prisma.analyticsEvent.groupBy({by:["metadata"],where:i,_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),c.prisma.project.count({where:{createdAt:{gte:o},...n&&{organizationId:n}}})]),f=m>0?(y/m*100).toFixed(2):"0",D=v.reduce((e,t)=>e+t._count.id,0),q=v.map(e=>({category:e.category,count:e._count.id,percentage:D>0?(e._count.id/D*100).toFixed(1):"0"})),O=_.map(e=>({action:e.action,count:e._count.id})),T=await c.prisma.analyticsEvent.groupBy({by:["userId"],where:{...i,userId:{not:null}},_count:{id:!0}}),N=(await c.prisma.analyticsEvent.groupBy({by:["metadata"],where:{...i,duration:{not:null},metadata:{path:["endpoint"]}},_avg:{duration:!0},_count:{id:!0},orderBy:{_avg:{duration:"desc"}},take:5})).map(e=>({endpoint:p(e.metadata,"endpoint")||"Unknown",avgTime:Math.round(l(e._avg.duration)),calls:e._count.id})),U=(await c.prisma.analyticsEvent.groupBy({by:["metadata"],where:{...i,action:"page_view",metadata:{path:["page"]}},_count:{id:!0},_avg:{duration:!0},orderBy:{_count:{id:"desc"}},take:5})).map(e=>({page:p(e.metadata,"page")||"Unknown",views:e._count.id,avgTimeOnPage:Math.round(l(e._avg.duration))})),B=(await c.prisma.analyticsEvent.groupBy({by:["metadata"],where:{...i,metadata:{path:["deviceType"]}},_count:{id:!0},orderBy:{_count:{id:"desc"}}})).map(e=>({type:p(e.metadata,"deviceType")||"Unknown",count:e._count.id})),C=(await c.prisma.analyticsEvent.groupBy({by:["metadata"],where:{...i,metadata:{path:["browser"]}},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:5})).map(e=>({browser:p(e.metadata,"browser")||"Unknown",count:e._count.id})),R={overview:{totalEvents:m,eventsLast7Days:g,errorEvents:y,errorRate:f,activeUsers:T.length,avgSessionDuration:1800,conversionRate:E>0?(E/T.length*100).toFixed(1):"0",totalProjects:E},eventsByCategory:q,eventsByAction:O,timelineData:w.map(e=>({date:String(e.date),events:Number(e.events),errors:Number(e.errors),users:Number(e.users)})),performanceMetrics:{avgLoadTime:Math.round(b._avg.duration||0),avgRenderTime:Math.round(.7*(b._avg.duration||0)),avgProcessingTime:Math.round(1.2*(b._avg.duration||0)),slowestEndpoints:N},userBehavior:{topPages:U,deviceTypes:B,browserStats:C},recentEvents:h};return s.NextResponse.json(R)}catch(t){console.error("[Analytics Dashboard] Error:",t);let e=t instanceof Error?t.message:"Unknown error";return s.NextResponse.json({error:"Internal server error",message:e},{status:500})}}(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}();let l=Object(function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(p),m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/analytics/dashboard/route",pathname:"/api/analytics/dashboard",filename:"route",bundlePath:"app/api/analytics/dashboard/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\analytics\\dashboard\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:v}=m,_="/api/analytics/dashboard/route";function h(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},491284:(e,t,a)=>{a.d(t,{Uu:()=>r,n5:()=>n});let r=e=>e.currentOrgId||e.organizationId||void 0,n=e=>e.id||""},303474:(e,t,a)=>{a.d(t,{prisma:()=>n});var r=a(453524);let n=global.prisma||new r.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,5715],()=>a(524922));module.exports=r})();