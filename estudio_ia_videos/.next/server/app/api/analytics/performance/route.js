"use strict";(()=>{var e={};e.id=1375,e.ids=[1375,3474],e.modules={453524:e=>{e.exports=require("@prisma/client")},572934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},554580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},345869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},627790:e=>{e.exports=require("assert")},978893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},986624:e=>{e.exports=require("querystring")},917360:e=>{e.exports=require("url")},521764:e=>{e.exports=require("util")},671568:e=>{e.exports=require("zlib")},96331:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>E,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>g});var n=r(349303),o=r(88716),i=r(60670),s=r(387070),u=r(95715),c=r(491284),d=r(303474);async function l(e){try{let t=await (0,u.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return s.NextResponse.json({error:"Authentication required"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("period")||"24h",n=r.get("metric")||"all",o=r.get("endpoint"),i=(0,c.Uu)(t.user),l=new Date;switch(a){case"1h":l.setHours(l.getHours()-1);break;case"24h":default:l.setHours(l.getHours()-24);break;case"7d":l.setDate(l.getDate()-7);break;case"30d":l.setDate(l.getDate()-30)}let p={createdAt:{gte:l},duration:{not:null},...i&&{organizationId:i},...o&&{metadata:{path:["path"],string_contains:o}}},m={};if("response_time"===n||"all"===n){let e=await d.prisma.analyticsEvent.aggregate({where:p,_avg:{duration:!0},_max:{duration:!0},_min:{duration:!0},_count:{duration:!0}}),t=await d.prisma.$queryRaw`
        SELECT 
          CASE 
            WHEN duration < 100 THEN '0-100ms'
            WHEN duration < 500 THEN '100-500ms'
            WHEN duration < 1000 THEN '500ms-1s'
            WHEN duration < 2000 THEN '1-2s'
            WHEN duration < 5000 THEN '2-5s'
            ELSE '5s+'
          END as range,
          COUNT(*) as count
        FROM analytics_event 
        WHERE created_at >= ${l} 
        AND duration IS NOT NULL
        ${i?d.prisma.$queryRaw`AND organization_id = ${i}`:d.prisma.$queryRaw``}
        GROUP BY range
        ORDER BY 
          CASE range
            WHEN '0-100ms' THEN 1
            WHEN '100-500ms' THEN 2
            WHEN '500ms-1s' THEN 3
            WHEN '1-2s' THEN 4
            WHEN '2-5s' THEN 5
            WHEN '5s+' THEN 6
          END
      `,r=await d.prisma.analyticsEvent.groupBy({by:["category","action"],where:p,_avg:{duration:!0},_count:{duration:!0},orderBy:{_avg:{duration:"desc"}},take:10});m.responseTime={stats:{avg:Math.round(e._avg.duration||0),max:e._max.duration||0,min:e._min.duration||0,count:e._count.duration||0},distribution:t,byEndpoint:r.map(e=>({endpoint:`${e.category}/${e.action}`,avgTime:Math.round(e._avg.duration||0),requests:e._count.duration}))}}if("throughput"===n||"all"===n){let e=await d.prisma.$queryRaw`
        SELECT 
          DATE_FORMAT(created_at, '%Y-%m-%d %H:%i:00') as minute,
          COUNT(*) as requests
        FROM analytics_event 
        WHERE created_at >= ${l}
        ${i?d.prisma.$queryRaw`AND organization_id = ${i}`:d.prisma.$queryRaw``}
        GROUP BY minute
        ORDER BY minute DESC
        LIMIT 60
      `,t=await d.prisma.analyticsEvent.count({where:p}),r=Math.max(1,(Date.now()-l.getTime())/6e4);m.throughput={avgRequestsPerMinute:Math.round(t/r),timeline:e,totalRequests:t}}if("errors"===n||"all"===n){let e=await d.prisma.analyticsEvent.groupBy({by:["status"],where:{...p,status:{in:["error","warning"]}},_count:{id:!0}}),t=await d.prisma.analyticsEvent.groupBy({by:["category","errorCode"],where:{...p,status:"error",errorCode:{not:null}},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),r=await d.prisma.analyticsEvent.count({where:{createdAt:{gte:l},...i&&{organizationId:i}}}),a=e.reduce((e,t)=>e+t._count.id,0);m.errors={errorRate:r>0?(a/r*100).toFixed(2):"0",totalErrors:a,byStatus:e.map(e=>({status:e.status,count:e._count.id})),byCategory:t.map(e=>({category:e.category,errorCode:e.errorCode,count:e._count.id}))}}if("all"===n){let e=await d.prisma.systemMetrics.findFirst({orderBy:{date:"desc"}}),t=await d.prisma.renderJob.count({where:{status:"pending"}});m.system={cpu:0,memory:0,disk:Number(e?.totalStorage||0)>0?Math.min(100,Math.round(Number(e.videoStorage||0)/Number(e.totalStorage||1)*100)):0,network:{inbound:0,outbound:0},activeConnections:e?.activeUsers||0,queueSize:e?.processingQueue??t}}if("all"===n){let e=await d.prisma.analyticsEvent.findMany({where:{createdAt:{gte:l},category:"cache",...i&&{organizationId:i}},select:{action:!0,metadata:!0}}),t=e.filter(e=>"hit"===e.action).length,r=e.filter(e=>"miss"===e.action).length,a=e.filter(e=>"eviction"===e.action).length,n=t+r,o=n>0?(t/n*100).toFixed(1):"0",s=n>0?(r/n*100).toFixed(1):"0",u=e.find(e=>{let t=e.metadata;return!!(t&&"cacheSize"in t)}),c=u?Number(u.metadata.cacheSize??0):0;m.cache={hitRate:o,missRate:s,totalHits:t,totalMisses:r,evictions:a,size:Math.round(c/1048576)}}return s.NextResponse.json({period:a,metric:n,endpoint:o,generatedAt:new Date().toISOString(),...m})}catch(t){console.error("[Analytics Performance] Error:",t);let e=t instanceof Error?t.message:"Unknown error";return s.NextResponse.json({error:"Failed to fetch performance metrics",message:e},{status:500})}}async function p(e){try{let t=await (0,u.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return s.NextResponse.json({error:"Authentication required"},{status:401});let{endpoint:r,method:a,responseTime:n,statusCode:o,requestSize:i,responseSize:l,userAgent:p,ipAddress:m,metadata:g}=await e.json();if(!r||!n)return s.NextResponse.json({error:"endpoint and responseTime are required"},{status:400});let E=t.user.id,y=(0,c.Uu)(t.user);return await d.prisma.analyticsEvent.create({data:{organizationId:y,userId:E,category:"performance",action:"api_call",label:r,duration:n,fileSize:i,status:o>=400?"error":"success",errorCode:o>=400?o.toString():null,metadata:{endpoint:r,method:a,statusCode:o,requestSize:i,responseSize:l,userAgent:p,ipAddress:m,...g}}}),s.NextResponse.json({success:!0,message:"Performance metric recorded"})}catch(t){console.error("[Analytics Performance POST] Error:",t);let e=t instanceof Error?t.message:"Unknown error";return s.NextResponse.json({error:"Failed to record performance metric",message:e},{status:500})}}(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}();let m=Object(function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(l),g=Object(function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(p),E=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/analytics/performance/route",pathname:"/api/analytics/performance",filename:"route",bundlePath:"app/api/analytics/performance/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\analytics\\performance\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:f}=E,N="/api/analytics/performance/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},491284:(e,t,r)=>{r.d(t,{Uu:()=>a,n5:()=>n});let a=e=>e.currentOrgId||e.organizationId||void 0,n=e=>e.id||""},303474:(e,t,r)=>{r.d(t,{prisma:()=>n});var a=r(453524);let n=global.prisma||new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,5715],()=>r(96331));module.exports=a})();