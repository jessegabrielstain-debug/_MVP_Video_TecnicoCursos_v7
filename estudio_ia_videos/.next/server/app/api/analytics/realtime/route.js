"use strict";(()=>{var e={};e.id=7461,e.ids=[7461,3474],e.modules={453524:e=>{e.exports=require("@prisma/client")},572934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},554580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},345869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},627790:e=>{e.exports=require("assert")},978893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},986624:e=>{e.exports=require("querystring")},917360:e=>{e.exports=require("url")},521764:e=>{e.exports=require("util")},671568:e=>{e.exports=require("zlib")},903300:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>f,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>g});var s=r(349303),n=r(88716),i=r(60670),o=r(387070),u=r(95715),c=r(491284),l=r(303474);async function d(e){try{let t=await (0,u.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return o.NextResponse.json({error:"Authentication required"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("window")||"15m",s=(0,c.Uu)(t.user),n=new Date,i=new Date;switch(a){case"5m":i.setMinutes(n.getMinutes()-5);break;case"15m":default:i.setMinutes(n.getMinutes()-15);break;case"1h":i.setHours(n.getHours()-1)}let d={createdAt:{gte:i},...s&&{organizationId:s}},[p,m,g,h,y,v,w]=await Promise.all([l.prisma.analyticsEvent.groupBy({by:["userId"],where:{...d,userId:{not:null}}}),l.prisma.analyticsEvent.count({where:d}),l.prisma.analyticsEvent.count({where:{...d,status:"error"}}),l.prisma.analyticsEvent.findMany({where:d,orderBy:{createdAt:"desc"},take:20,select:{id:!0,category:!0,action:!0,label:!0,status:!0,duration:!0,createdAt:!0,userId:!0}}),l.prisma.$queryRaw`
        SELECT 
          DATE_FORMAT(created_at, '%H:%i') as minute,
          COUNT(*) as events,
          COUNT(CASE WHEN status = 'error' THEN 1 END) as errors
        FROM analytics_event 
        WHERE created_at >= ${i}
        ${s?l.prisma.$queryRaw`AND organization_id = ${s}`:l.prisma.$queryRaw``}
        GROUP BY minute
        ORDER BY minute DESC
        LIMIT 60
      `,l.prisma.analyticsEvent.groupBy({by:["category"],where:d,_count:{id:!0},orderBy:{_count:{id:"desc"}},take:5}),(async()=>{await l.prisma.systemMetrics.findFirst({orderBy:{date:"desc"}});let e=await l.prisma.analyticsEvent.aggregate({where:{createdAt:{gte:i},duration:{not:null},...s&&{organizationId:s}},_avg:{duration:!0}}),t=(n.getTime()-i.getTime())/1e3,r=Math.round(m/Math.max(1,t)),a=m>0?g/m*100:0;return{cpu:0,memory:0,responseTime:Math.round(e._avg.duration||0),throughput:r,errorRate:a}})()]),x=m/Math.max(1,(n.getTime()-i.getTime())/6e4),f=m>0?(g/m*100).toFixed(2):"0",E=y.map(e=>({time:String(e.minute),events:Number(e.events),errors:Number(e.errors)})),T=new Date(i.getTime()-(n.getTime()-i.getTime())),O=await l.prisma.analyticsEvent.count({where:{createdAt:{gte:T,lt:i},...s&&{organizationId:s}}}),M=await l.prisma.analyticsEvent.groupBy({by:["userId"],where:{createdAt:{gte:T,lt:i},userId:{not:null},...s&&{organizationId:s}}}),_=O>0?((m-O)/O*100).toFixed(1):"0",q=M.length>0?((p.length-M.length)/M.length*100).toFixed(1):"0",N=[];parseFloat(f)>10&&N.push({type:"high_error_rate",severity:"warning",message:`Taxa de erro elevada: ${f}%`,timestamp:new Date().toISOString()}),w.responseTime>2e3&&N.push({type:"slow_response",severity:"warning",message:`Tempo de resposta lento: ${Math.round(w.responseTime)}ms`,timestamp:new Date().toISOString()}),x>100&&N.push({type:"high_traffic",severity:"info",message:`Tr\xe1fego elevado: ${Math.round(x)} eventos/min`,timestamp:new Date().toISOString()});let b={timestamp:new Date().toISOString(),window:a,summary:{activeUsers:p.length,totalEvents:m,errorEvents:g,errorRate:parseFloat(f),eventsPerMinute:Math.round(x),avgResponseTime:Math.round(w.responseTime)},trends:{events:{current:m,previous:O,change:parseFloat(_),direction:parseFloat(_)>=0?"up":"down"},users:{current:p.length,previous:M.length,change:parseFloat(q),direction:parseFloat(q)>=0?"up":"down"}},timeline:E,topCategories:v.map(e=>({category:e.category,count:e._count.id,percentage:m>0?(e._count.id/m*100).toFixed(1):"0"})),systemHealth:{status:w.cpu<80&&w.memory<80&&w.responseTime<2e3?"healthy":"warning",cpu:Math.round(w.cpu),memory:Math.round(w.memory),responseTime:Math.round(w.responseTime),throughput:w.throughput},recentEvents:h.map(e=>({...e,timeAgo:Math.round((n.getTime()-new Date(e.createdAt).getTime())/1e3)})),anomalies:N,alerts:N.filter(e=>"warning"===e.severity||"error"===e.severity)};return o.NextResponse.json(b)}catch(t){console.error("[Analytics Realtime] Error:",t);let e=t instanceof Error?t.message:"Unknown error";return o.NextResponse.json({error:"Failed to fetch realtime metrics",message:e},{status:500})}}async function p(e){try{let t=await (0,u.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e}())),{events:r,source:a,timestamp:s}=await e.json();if(!r||!Array.isArray(r))return o.NextResponse.json({error:"events array is required"},{status:400});let n=t?.user?.id||null,i=t?.user?(0,c.Uu)(t.user):null,d=r.map(e=>({organizationId:i,userId:e.userId||n,category:e.category||"realtime",action:e.action||"event",label:e.label,duration:e.duration,fileSize:e.fileSize,value:e.value,status:e.status||"success",errorCode:e.errorCode,errorMessage:e.errorMessage,metadata:{source:a,originalTimestamp:s,...e.metadata}}));return await l.prisma.analyticsEvent.createMany({data:d}),o.NextResponse.json({success:!0,processed:d.length,message:"Realtime events processed"})}catch(t){console.error("[Analytics Realtime POST] Error:",t);let e=t instanceof Error?t.message:"Unknown error";return o.NextResponse.json({error:"Failed to process realtime events",message:e},{status:500})}}(function(){var e=Error("Cannot find module '@/lib/auth/auth-config'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}();let m=Object(function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(d),g=Object(function(){var e=Error("Cannot find module '@/lib/analytics/api-performance-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(p),h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analytics/realtime/route",pathname:"/api/analytics/realtime",filename:"route",bundlePath:"app/api/analytics/realtime/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\analytics\\realtime\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:v,serverHooks:w}=h,x="/api/analytics/realtime/route";function f(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}},491284:(e,t,r)=>{r.d(t,{Uu:()=>a,n5:()=>s});let a=e=>e.currentOrgId||e.organizationId||void 0,s=e=>e.id||""},303474:(e,t,r)=>{r.d(t,{prisma:()=>s});var a=r(453524);let s=global.prisma||new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,5715],()=>r(903300));module.exports=a})();