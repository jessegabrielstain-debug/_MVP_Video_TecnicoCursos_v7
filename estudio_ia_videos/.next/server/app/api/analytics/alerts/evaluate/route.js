"use strict";(()=>{var e={};e.id=603,e.ids=[603],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},89513:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>A,requestAsyncStorage:()=>w,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{GET:()=>h,POST:()=>v});var n=a(49303),i=a(88716),s=a(60670),o=a(87070),l=a(11299),u=a(20276);let d=process.env.CRON_TOKEN||"default-cron-token";async function c(e){try{let t=e.headers.get("authorization"),a=e.headers.get("x-cron-token");if(!t&&a!==d)return o.NextResponse.json({error:"Unauthorized. Valid authorization or cron token required."},{status:401});let{force:r=!1,organizationId:n,ruleTypes:i=[],dryRun:s=!1}=await e.json().catch(()=>({})),u=new l.U,c=Date.now(),g=await u.evaluateAlerts(),v=Date.now()-c;console.log("[Alert Evaluation] Completed",{force:r,dryRun:s,organizationId:n,ruleTypes:i,evaluated:g.evaluated,triggered:g.triggered,durationMs:v}),g.alerts.length>0&&console.log("[Alert Evaluation] Triggered alerts",{alerts:g.alerts.map(e=>({id:e.id,severity:e.severity,title:e.title}))});let h={success:!0,message:"Alert evaluation completed successfully",execution:{startedAt:new Date(Date.now()-v),completedAt:new Date,durationMs:v,dryRun:s},results:{evaluated:g.evaluated,triggered:g.triggered,alerts:g.alerts.map(e=>({id:e.id,type:e.type,severity:e.severity,title:e.title,value:e.value,threshold:e.threshold,triggeredAt:e.triggeredAt}))},stats:{criticalAlerts:g.alerts.filter(e=>"critical"===e.severity).length,warningAlerts:g.alerts.filter(e=>"warning"===e.severity).length,errorAlerts:g.alerts.filter(e=>"error"===e.severity).length,infoAlerts:g.alerts.filter(e=>"info"===e.severity).length}};return h.stats.criticalAlerts>0&&console.warn("[Alert Evaluation] Critical alerts triggered",{count:h.stats.criticalAlerts}),o.NextResponse.json(h)}catch(e){return console.error("[Alert Evaluation] Critical error",e),o.NextResponse.json({success:!1,error:"Alert evaluation failed",message:e instanceof Error?e.message:"Unknown error",execution:{startedAt:new Date,completedAt:new Date,durationMs:0,failed:!0}},{status:500})}}async function g(e){try{let t=e.headers.get("authorization"),a=e.headers.get("x-cron-token");if(!t&&a!==d)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r={timestamp:new Date,status:"success",evaluated:0,triggered:0,executionTime:0};return o.NextResponse.json({lastExecution:r,systemStatus:"operational",nextScheduledRun:new Date(Date.now()+3e5),configuration:{evaluationInterval:"5 minutes",enabledRules:["render_failures","queue_stalled","high_latency","low_engagement"],notifications:{email:!0,slack:!0,sms:!1},dryRunSupported:!0,defaultThresholds:{render_failures:3,queue_stalled:2,high_latency:5e3,low_engagement:20}}})}catch(e){return console.error("[Alert Evaluation Status] Error",e),o.NextResponse.json({error:"Failed to fetch alert evaluation status",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let v=(0,u.wi)(c),h=(0,u.wi)(g),p=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/analytics/alerts/evaluate/route",pathname:"/api/analytics/alerts/evaluate",filename:"route",bundlePath:"app/api/analytics/alerts/evaluate/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\analytics\\alerts\\evaluate\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:m}=p,f="/api/analytics/alerts/evaluate/route";function A(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:y})}},11299:(e,t,a)=>{a.d(t,{U:()=>n});var r=a(8261);class n{async evaluateAlerts(e){let t=await this.getActiveRules(e),a=[];for(let e of t){let t=await this.evaluateRule(e);t&&a.push(t)}return{evaluated:t.length,triggered:a.length,alerts:a}}async acknowledgeAlert(e,t){let a=await r._.analyticsEvent.findUnique({where:{id:e}});if(!a)return;let n=a.eventData||{};await r._.analyticsEvent.update({where:{id:e},data:{eventData:{...n,status:"acknowledged",acknowledgedBy:t,acknowledgedAt:new Date().toISOString()}}})}async resolveAlert(e,t){let a=await r._.analyticsEvent.findUnique({where:{id:e}});if(!a)return;let n=a.eventData||{};await r._.analyticsEvent.update({where:{id:e},data:{eventData:{...n,status:"resolved",resolvedBy:t,resolvedAt:new Date().toISOString()}}})}async getActiveRules(e){return(await r._.analyticsEvent.findMany({where:{eventType:"alert_rule",eventData:{path:["status"],equals:"active"},...e&&{eventData:{path:["organizationId"],equals:e}}}})).map(e=>{let t=e.eventData;return{id:e.id,name:t.title||"Unnamed Rule",type:t.type||"system",severity:t.severity||"info",condition:t.condition||{metric:"unknown",operator:"gt",threshold:0,timeWindow:15},channels:t.channels||[],cooldown:t.cooldown||15,isActive:"active"===t.status}})}async evaluateRule(e){let t=new Date(Date.now()-6e4*e.condition.timeWindow),a=0;try{if("error_rate"===e.condition.metric)a=await r._.analyticsEvent.count({where:{eventType:"error",createdAt:{gte:t}}});else if("job_failure_rate"===e.condition.metric){let e=await r._.renderJob.count({where:{createdAt:{gte:t}}});e>0&&(a=await r._.renderJob.count({where:{status:"failed",createdAt:{gte:t}}})/e*100)}else"avg_render_duration"===e.condition.metric&&(a=((await r._.renderJob.aggregate({_avg:{durationMs:!0},where:{status:"completed",createdAt:{gte:t}}}))._avg.durationMs||0)/1e3);if(this.checkThreshold(a,e.condition.operator,e.condition.threshold))return await this.createAlertFromRule(e,a)}catch(t){console.error(`Error evaluating rule ${e.id}:`,t)}return null}checkThreshold(e,t,a){switch(t){case"gt":return e>a;case"lt":return e<a;case"gte":return e>=a;case"lte":return e<=a;case"eq":return e===a;default:return!1}}async createAlertFromRule(e,t){let a=await r._.analyticsEvent.findFirst({where:{eventType:"alert",eventData:{path:["ruleId"],equals:e.id}},orderBy:{createdAt:"desc"}});if(a){let t=a.createdAt.getTime(),r=6e4*e.cooldown;if(Date.now()-t<r)return null}let n={ruleId:e.id,type:e.type,severity:e.severity,title:`Alert: ${e.name}`,message:`${e.condition.metric} is ${t} (Threshold: ${e.condition.operator} ${e.condition.threshold})`,value:t,threshold:e.condition.threshold,status:"active",triggeredAt:new Date().toISOString()};return{id:(await r._.analyticsEvent.create({data:{eventType:"alert",eventData:n}})).id,...n,triggeredAt:new Date(n.triggeredAt),status:"active"}}}new n},20276:(e,t,a)=>{a.d(t,{wi:()=>n});let r=[],n=function(e){return async t=>{let a=Date.now(),n=await e(t),i=Date.now()-a;return r.push({path:t.nextUrl.pathname,method:t.method,duration:i,statusCode:n.status,timestamp:new Date}),r.length>1e3&&r.shift(),n}}},8261:(e,t,a)=>{a.d(t,{_:()=>n});var r=a(53524);let n=global.prisma||new r.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(89513));module.exports=r})();