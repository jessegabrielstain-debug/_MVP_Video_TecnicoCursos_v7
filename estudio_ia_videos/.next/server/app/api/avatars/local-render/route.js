"use strict";(()=>{var e={};e.id=2528,e.ids=[2528],e.modules={220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},166223:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>O});var t={};a.r(t),a.d(t,{GET:()=>c,POST:()=>d});var o=a(349303),n=a(88716),i=a(60670),s=a(387070);async function d(e){try{let{text:r,avatarId:a,voiceId:t,resolution:o="HD",fps:n=30,userId:i}=await e.json();if(!r||!a||!t||!i)return s.NextResponse.json({error:"text, avatarId, voiceId e userId s\xe3o obrigat\xf3rios"},{status:400});if(r.length>800)return s.NextResponse.json({error:"Texto muito longo (m\xe1ximo 800 caracteres)"},{status:400});let d=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.create({data:{userId:i,avatarId:a,text:r,audioUrl:"",resolution:o,fps:n,duration:0,status:"queued",progress:0,currentStage:"preparation"}});return u(d.id,r,t,a,o,n).catch(e=>{console.error(`[Job ${d.id}] Erro no processamento:`,e),Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:d.id},data:{status:"error",error:e.message,errorDetails:{stack:e.stack}}}).catch(console.error)}),s.NextResponse.json({success:!0,jobId:d.id,status:"queued",message:"Renderiza\xe7\xe3o iniciada. Use GET /api/avatars/local-render?jobId=<id> para verificar progresso."})}catch(e){return console.error("Erro ao iniciar renderiza\xe7\xe3o local:",e),s.NextResponse.json({error:"Erro ao iniciar renderiza\xe7\xe3o"},{status:500})}}async function c(e){let{searchParams:r}=new URL(e.url),a=r.get("jobId");if(!a)return s.NextResponse.json({error:"jobId \xe9 obrigat\xf3rio"},{status:400});try{let e=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.findUnique({where:{id:a}});if(!e)return s.NextResponse.json({error:"Job n\xe3o encontrado"},{status:404});return s.NextResponse.json({success:!0,jobId:e.id,status:e.status,progress:e.progress,currentStage:e.currentStage,estimatedTime:e.estimatedTime,videoUrl:e.videoUrl,thumbnail:e.thumbnail,error:e.error,createdAt:e.createdAt,updatedAt:e.updatedAt})}catch(e){return console.error("Erro ao consultar status do job:",e),s.NextResponse.json({error:"Erro ao consultar status"},{status:500})}}async function u(e,r,a,t,o,n){let i=Object(function(){var e=Error("Cannot find module '@/lib/s3-upload-engine'");throw e.code="MODULE_NOT_FOUND",e}())(),s=Object(function(){var e=Error("Cannot find module '@/lib/local-avatar-renderer'");throw e.code="MODULE_NOT_FOUND",e}())();try{await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{status:"processing",progress:10,currentStage:"audio"}});let d=await Object(function(){var e=Error("Cannot find module '@/lib/enhanced-tts-service'");throw e.code="MODULE_NOT_FOUND",e}()).synthesizeSpeech({text:r,language:"pt-BR",voice:a,speed:1,pitch:0});if(!d.success||!d.audioUrl)throw Error("Falha ao gerar \xe1udio TTS");let c=r.split(/\s+/).length,u=Math.ceil(c/150*6e4);await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{audioUrl:d.audioUrl,duration:u,progress:25,estimatedTime:Math.ceil(u/100)}}),await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{progress:40,currentStage:"lipsync"}});let l=await s.generateLipSync(d.audioUrl,r,u);await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{progress:60,currentStage:"rendering"}});let p=await s.renderVideo(t,l,{resolution:o,fps:n,duration:u});await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{progress:85,currentStage:"encoding"}});let O=await i.uploadFile(p,`avatar_${e}_${Date.now()}.mp4`);if(!O.success)throw Error(`Falha no upload S3: ${O.error}`);await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).avatar3DRenderJob.update({where:{id:e},data:{status:"completed",progress:100,currentStage:"completed",videoUrl:O.url,fileSize:O.size}}),console.log(`[Job ${e}] ✅ Renderiza\xe7\xe3o conclu\xedda com sucesso`)}catch(r){throw console.error(`[Job ${e}] ❌ Erro:`,r),r}}(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/enhanced-tts-service'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/lib/s3-upload-engine'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/lib/local-avatar-renderer'");throw e.code="MODULE_NOT_FOUND",e}();let l=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/avatars/local-render/route",pathname:"/api/avatars/local-render",filename:"route",bundlePath:"app/api/avatars/local-render/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\avatars\\local-render\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:p,staticGenerationAsyncStorage:O,serverHooks:m}=l,h="/api/avatars/local-render/route";function v(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:O})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[8948,5972],()=>a(166223));module.exports=t})();