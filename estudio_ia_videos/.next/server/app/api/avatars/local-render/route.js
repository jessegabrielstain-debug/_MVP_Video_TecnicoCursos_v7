"use strict";(()=>{var e={};e.id=2528,e.ids=[2528],e.modules={53524:e=>{e.exports=require("@prisma/client")},46718:e=>{e.exports=require("canvas")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},21764:e=>{e.exports=require("util")},36250:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>T,patchFetch:()=>_,requestAsyncStorage:()=>P,routeModule:()=>j,serverHooks:()=>$,staticGenerationAsyncStorage:()=>U});var a={};t.r(a),t.d(a,{GET:()=>b,POST:()=>x});var o=t(49303),s=t(88716),n=t(60670),i=t(87070),l=t(8261),u=t(92048),c=t.n(u),d=t(55315),p=t.n(d),g=t(9576),h=t(61282),m=t(21764);let f=t.n(m)().promisify(h.exec);class w{async synthesize(e){let{text:r,voice:t="pt-BR-AntonioNeural",speed:a=1,format:o="mp3"}=e;console.log(`[TTS] Synthesizing: "${r}" (voice: ${t}, speed: ${a})`);let s=p().join(process.cwd(),"tmp","tts");c().existsSync(s)||c().mkdirSync(s,{recursive:!0});let n=`${(0,g.Z)()}.${o}`,i=p().join(s,n);try{let e="";if(1!==a){let r=Math.round((a-1)*100);e=`--rate="${r>=0?"+":""}${r}%"`}let s=`edge-tts --text "${r.replace(/"/g,'\\"')}" --write-media "${i}" --voice ${t} ${e}`;if(console.log(`[TTS] Executing: ${s}`),await f(s),c().existsSync(i)){let e=c().readFileSync(i),t=r.split(" ").length;try{c().unlinkSync(i)}catch(e){}return{audioBuffer:e,duration:Math.max(1,t/(2.5*a)),format:o}}throw Error("TTS output file not found")}catch(e){return console.error("[TTS] Error using edge-tts:",e),console.warn("[TTS] Falling back to mock buffer due to error."),{audioBuffer:Buffer.from("mock-audio-data"),duration:r.length/10,format:o}}}async synthesizeBatch(e){return Promise.all(e.map(e=>this.synthesize(e)))}listVoices(){return["pt-BR-AntonioNeural","pt-BR-FranciscaNeural","en-US-ChristopherNeural","en-US-JennyNeural"]}}new w;class y{async upload(e){let{bucket:r,key:t,buffer:a,contentType:o="application/octet-stream"}=e;return console.log(`[Upload] Uploading to ${r}/${t} (${a.length} bytes)`),{url:`https://storage.example.com/${r}/${t}`,key:t,size:a.length}}async uploadMultiple(e){return Promise.all(e.map(e=>this.upload(e)))}async delete(e,r){return console.log(`[Upload] Deleting ${e}/${r}`),!0}async exists(e,r){return!1}}new y;var v=t(10607);async function x(e){try{let{text:r,avatarId:t,voiceId:a,resolution:o="HD",fps:s=30,userId:n}=await e.json();if(!r||!t||!a||!n)return i.NextResponse.json({error:"text, avatarId, voiceId e userId s\xe3o obrigat\xf3rios"},{status:400});if(r.length>800)return i.NextResponse.json({error:"Texto muito longo (m\xe1ximo 800 caracteres)"},{status:400});let u={userId:n,avatarId:t,text:r,audioUrl:"",resolution:o,fps:s,duration:0,currentStage:"preparation",estimatedTime:0,videoUrl:"",thumbnail:"",error:null,errorDetails:null},c=await l._.processingQueue.create({data:{jobType:"avatar-3d-render",status:"pending",priority:1,jobData:u}});return S(c.id,r,a,t,o,s).catch(e=>{console.error(`[Job ${c.id}] Erro no processamento:`,e),l._.processingQueue.update({where:{id:c.id},data:{status:"failed",errorMessage:e.message,jobData:{...u,error:e.message,errorDetails:{stack:e.stack}}}}).catch(console.error)}),i.NextResponse.json({success:!0,jobId:c.id,status:"queued",message:"Renderiza\xe7\xe3o iniciada. Use GET /api/avatars/local-render?jobId=<id> para verificar progresso."})}catch(e){return console.error("Erro ao iniciar renderiza\xe7\xe3o local:",e),i.NextResponse.json({error:"Erro ao iniciar renderiza\xe7\xe3o"},{status:500})}}async function b(e){let{searchParams:r}=new URL(e.url),t=r.get("jobId");if(!t)return i.NextResponse.json({error:"jobId \xe9 obrigat\xf3rio"},{status:400});try{let e=await l._.processingQueue.findUnique({where:{id:t}});if(!e)return i.NextResponse.json({error:"Job n\xe3o encontrado"},{status:404});let r=e.jobData;return i.NextResponse.json({success:!0,jobId:e.id,status:e.status,progress:e.progress,currentStage:r.currentStage,estimatedTime:r.estimatedTime,videoUrl:r.videoUrl,thumbnail:r.thumbnail,error:e.errorMessage,createdAt:e.createdAt,updatedAt:e.updatedAt})}catch(e){return console.error("Erro ao consultar status do job:",e),i.NextResponse.json({error:"Erro ao consultar status"},{status:500})}}async function S(e,r,t,a,o,s){let n=new y,i=new v.t;try{let o=await l._.processingQueue.findUnique({where:{id:e}}),u=o?.jobData||{};u={...u,currentStage:"audio"},await l._.processingQueue.update({where:{id:e},data:{status:"processing",progress:10,jobData:u}});let c=await new w().synthesize({text:r,voice:t,speed:1});if(!c.audioBuffer)throw Error("Falha ao gerar \xe1udio TTS");let d=1e3*c.duration;u={...u,audioUrl:"mock-audio-url",duration:d,estimatedTime:Math.ceil(d/100)},await l._.processingQueue.update({where:{id:e},data:{progress:25,jobData:u}}),u={...u,currentStage:"lipsync"},await l._.processingQueue.update({where:{id:e},data:{progress:40,jobData:u}}),u={...u,currentStage:"rendering"},await l._.processingQueue.update({where:{id:e},data:{progress:60,jobData:u}});let p=await i.renderSequence({type:"2d",assetPath:a,dimensions:{width:1280,height:720}},Math.ceil(d/1e3*s)),g=Buffer.concat(p);u={...u,currentStage:"encoding"},await l._.processingQueue.update({where:{id:e},data:{progress:85,jobData:u}});let h=await n.upload({bucket:"avatars",key:`avatar_${e}_${Date.now()}.mp4`,buffer:g});if(!h.url)throw Error("Falha no upload S3");u={...u,currentStage:"completed",videoUrl:h.url,fileSize:h.size},await l._.processingQueue.update({where:{id:e},data:{status:"completed",progress:100,jobData:u}}),console.log(`[Job ${e}] ✅ Renderiza\xe7\xe3o conclu\xedda com sucesso`)}catch(r){throw console.error(`[Job ${e}] ❌ Erro:`,r),r}}let j=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/avatars/local-render/route",pathname:"/api/avatars/local-render",filename:"route",bundlePath:"app/api/avatars/local-render/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\avatars\\local-render\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:U,serverHooks:$}=j,T="/api/avatars/local-render/route";function _(){return(0,n.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:U})}},10607:(e,r,t)=>{t.d(r,{t:()=>n});var a=t(46718),o=t(92048),s=t.n(o);class n{async render(e,r){let{width:t,height:o}=e.dimensions,n=(0,a.createCanvas)(t,o),i=n.getContext("2d");i.clearRect(0,0,t,o);try{if(e.assetPath&&s().existsSync(e.assetPath)){let r=await (0,a.loadImage)(e.assetPath);i.drawImage(r,0,0,t,o)}else this.drawPlaceholderAvatar(i,t,o,r)}catch(e){console.error(`[Avatar] Error rendering frame ${r}:`,e),this.drawPlaceholderAvatar(i,t,o,r)}return n.toBuffer("image/png")}drawPlaceholderAvatar(e,r,t,a){let o=r/2,s=t/2,n=Math.min(r,t)/3;e.fillStyle="#f0f0f0",e.fillRect(0,0,r,t),e.beginPath(),e.arc(o,s,n,0,2*Math.PI),e.fillStyle="#3b82f6",e.fill(),e.beginPath(),e.ellipse(o,s+.3*n,.4*n,10*Math.sin(.5*a)+10,0,0,2*Math.PI),e.fillStyle="#1d4ed8",e.fill(),e.fillStyle="white",e.beginPath(),e.arc(o-.3*n,s-.2*n,.1*n,0,2*Math.PI),e.arc(o+.3*n,s-.2*n,.1*n,0,2*Math.PI),e.fill()}async renderSequence(e,r){let t=[];for(let a=0;a<r;a++)t.push(await this.render(e,a));return t}}new n},8261:(e,r,t)=>{t.d(r,{_:()=>o});var a=t(53524);let o=global.prisma||new a.PrismaClient({log:["error"]})},9576:(e,r,t)=>{t.d(r,{Z:()=>u});var a=t(84770),o=t.n(a);let s={randomUUID:o().randomUUID},n=new Uint8Array(256),i=n.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let u=function(e,r,t){if(s.randomUUID&&!r&&!e)return s.randomUUID();let a=(e=e||{}).random||(e.rng||function(){return i>n.length-16&&(o().randomFillSync(n),i=0),n.slice(i,i+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,r){t=t||0;for(let e=0;e<16;++e)r[t+e]=a[e];return r}return function(e,r=0){return l[e[r+0]]+l[e[r+1]]+l[e[r+2]]+l[e[r+3]]+"-"+l[e[r+4]]+l[e[r+5]]+"-"+l[e[r+6]]+l[e[r+7]]+"-"+l[e[r+8]]+l[e[r+9]]+"-"+l[e[r+10]]+l[e[r+11]]+l[e[r+12]]+l[e[r+13]]+l[e[r+14]]+l[e[r+15]]}(a)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5972],()=>t(36250));module.exports=a})();