"use strict";(()=>{var e={};e.id=1587,e.ids=[1587,3936],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},84375:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>S,requestAsyncStorage:()=>w,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{DELETE:()=>f,GET:()=>m});var a=r(49303),i=r(88716),o=r(60670),n=r(87070),c=r(13936),l=r(62619),d=r(24507),p=r(73055),u=r(17549),h=r(20629);let m=(0,l.er)(l.fp.AUTH_API,"user")(async function(e,t){try{let r=(0,c.getSupabaseForRequest)(e),{data:{user:s},error:a}=await r.auth.getUser();if(a||!s)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let i=t?.params?.id;if(!i)return n.NextResponse.json({error:"ID do upload \xe9 obrigat\xf3rio"},{status:400});let{data:o,error:l}=await r.from("pptx_uploads").select("*").eq("id",i).single();if(l)return console.error("Erro ao buscar upload:",l),n.NextResponse.json({error:"Erro interno do servidor"},{status:500});if(!o)return n.NextResponse.json({error:"Upload n\xe3o encontrado"},{status:404});let{data:d}=await r.from("projects").select("user_id, is_public").eq("id",o.project_id).single(),p=d&&(d.user_id===s.id||d.is_public);if(!p&&d){let{data:e}=await r.from("project_collaborators").select("user_id").eq("project_id",o.project_id).eq("user_id",s.id).single();e&&(p=!0)}if(!p)return n.NextResponse.json({error:"Sem permiss\xe3o para acessar este upload"},{status:403});let{data:u}=await r.from("pptx_slides").select("*").eq("upload_id",i).order("slide_number",{ascending:!0});return n.NextResponse.json({upload:o,slides:u||[]})}catch(e){return console.error("Erro na API de upload by id:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}),f=(0,l.er)(l.fp.AUTH_STRICT,"user")(async function(e,t){try{let r=(0,c.getSupabaseForRequest)(e),{data:{user:s},error:a}=await r.auth.getUser();if(a||!s)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let i=t?.params?.id;if(!i)return n.NextResponse.json({error:"ID do upload \xe9 obrigat\xf3rio"},{status:400});let{data:o}=await r.from("pptx_uploads").select("*").eq("id",i).single();if(!o)return n.NextResponse.json({error:"Upload n\xe3o encontrado"},{status:404});let{data:l}=await r.from("projects").select("user_id, is_public").eq("id",o.project_id).single(),m=l&&(l.user_id===s.id||l.is_public);if(!m&&l){let{data:e}=await r.from("project_collaborators").select("permissions").eq("project_id",o.project_id).eq("user_id",s.id).single();e&&e.permissions?.can_edit&&(m=!0)}if(!m)return n.NextResponse.json({error:"Sem permiss\xe3o para excluir este upload"},{status:403});if(await r.from("pptx_slides").delete().eq("upload_id",i),o.preview_url&&"string"==typeof o.preview_url)try{if(o.preview_url.startsWith("/api/s3/serve/")){let e=decodeURIComponent(o.preview_url.replace("/api/s3/serve/",""));await d.f.deleteFile(e)}else if(o.preview_url.startsWith("/api/videos/cache/")){let e=decodeURIComponent(o.preview_url.replace("/api/videos/cache/",""));p.G.delete(e)}}catch(e){console.warn("Falha ao limpar preview asset:",e)}if(o.file_path&&"string"==typeof o.file_path)try{await (0,h.unlink)(o.file_path)}catch(e){}await r.from("pptx_uploads").delete().eq("id",i);let f=`project:${o.project_id}:uploads`;return u.O.sendNotification({id:`upload_${i}_deleted_${Date.now()}`,type:"system_alert",title:"Upload removido",message:`O upload ${o.original_filename||o.filename} foi removido do projeto`,priority:"low",timestamp:Date.now(),roomId:f,data:{uploadId:i,projectId:o.project_id}}),n.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao excluir upload:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}),_=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/pptx/upload/[id]/route",pathname:"/api/pptx/upload/[id]",filename:"route",bundlePath:"app/api/pptx/upload/[id]/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\pptx\\upload\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:v}=_,x="/api/pptx/upload/[id]/route";function S(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}},17549:(e,t,r)=>{r.d(t,{O:()=>i,f:()=>a});var s=r(61657);class a{constructor(){this.rooms=new Map;let e="https://ofhzrdiadxigrvmrhaiz.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;e&&t||console.warn("⚠️ Supabase credentials not found in NotificationManager"),this.supabase=(0,s.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}static getInstance(){return a.instance||(a.instance=new a),a.instance}getRoom(e){return this.rooms.get(e)}createRoom(e,t){let r={id:e,name:t,members:new Set,createdAt:new Date};return this.rooms.set(e,r),r}joinRoom(e,t){let r=this.rooms.get(e);return!!r&&(r.members.add(t),!0)}leaveRoom(e,t){let r=this.rooms.get(e);return!!r&&r.members.delete(t)}async create(e){e.userId,e.type,e.title,e.message,e.actionUrl,e.expiresAt?.toISOString(),new Date().toISOString();let{data:t,error:r}=await this.supabase.from("analytics_events").insert({user_id:e.userId,event_type:"notification",event_data:{type:e.type,title:e.title,message:e.message,read:!1,actionUrl:e.actionUrl,expiresAt:e.expiresAt},created_at:new Date().toISOString()}).select().single();if(r)throw console.error("Failed to create notification:",r),r;return{id:t.id,userId:t.user_id,type:t.event_data.type,title:t.event_data.title,message:t.event_data.message,read:t.event_data.read,createdAt:new Date(t.created_at),expiresAt:t.event_data.expiresAt?new Date(t.event_data.expiresAt):void 0,actionUrl:t.event_data.actionUrl}}async getForUser(e,t=!1){let r=this.supabase.from("analytics_events").select("*").eq("user_id",e).eq("event_type","notification").order("created_at",{ascending:!1}),{data:s,error:a}=await r.limit(50);if(a)return[];let i=s.map(e=>({id:e.id,userId:e.user_id,type:e.event_data.type,title:e.event_data.title,message:e.event_data.message,read:e.event_data.read,createdAt:new Date(e.created_at),expiresAt:e.event_data.expiresAt?new Date(e.event_data.expiresAt):void 0,actionUrl:e.event_data.actionUrl}));return t&&(i=i.filter(e=>!e.read)),i}async markAsRead(e){let{data:t}=await this.supabase.from("analytics_events").select("event_data").eq("id",e).single();if(!t)return!1;let r={...t.event_data,read:!0},{error:s}=await this.supabase.from("analytics_events").update({event_data:r}).eq("id",e);return!s}async delete(e){let{error:t}=await this.supabase.from("analytics_events").delete().eq("id",e);return!t}async deleteAllForUser(e){let{count:t,error:r}=await this.supabase.from("analytics_events").delete({count:"exact"}).eq("user_id",e).eq("event_type","notification");return r?0:t||0}async sendToUser(e,t){try{let r=t.data;await this.create({userId:e,type:"error"===t.type||"upload_error"===t.type?"error":"info",title:t.title,message:t.message,actionUrl:r?.uploadId?`/upload/${r.uploadId}`:void 0})}catch(e){console.error("Error sending notification to user:",e)}}async broadcastToRoom(e,t){console.log(`[NotificationManager] Broadcasting to room ${e}:`,t.title)}async sendNotification(e){if(!1!==e.persistent&&e.userId)try{await this.create({userId:e.userId,type:"error"===e.type||"upload_error"===e.type?"error":"info",title:e.title,message:e.message,actionUrl:e.data?.uploadId?`/upload/${e.data.uploadId}`:void 0})}catch(e){console.error("Error persisting notification:",e)}e.roomId&&await this.broadcastToRoom(e.roomId,e),e.userId&&!e.roomId&&console.log(`[NotificationManager] Sending to user ${e.userId}:`,e.title)}}let i=new a},62619:(e,t,r)=>{r.d(t,{er:()=>o,fp:()=>i});var s=r(87070);class a{constructor(e){this.config=e,this.requests=new Map}async check(e){let t=Date.now(),r=t-this.config.windowMs,s=this.requests.get(e)||[],a=(s=s.filter(e=>e>r)).length<this.config.maxRequests;return a&&(s.push(t),this.requests.set(e,s)),{allowed:a,remaining:Math.max(0,this.config.maxRequests-s.length),resetAt:new Date(t+this.config.windowMs)}}async reset(e){this.requests.delete(e)}async clearExpired(){let e=Date.now()-this.config.windowMs;for(let[t,r]of this.requests.entries()){let s=r.filter(t=>t>e);0===s.length?this.requests.delete(t):this.requests.set(t,s)}}}new a({windowMs:6e4,maxRequests:100});let i={DEFAULT:{windowMs:6e4,maxRequests:100},API:{windowMs:6e4,maxRequests:60},AUTH_API:{windowMs:6e4,maxRequests:60},AUTH_STRICT:{windowMs:6e4,maxRequests:30},UPLOAD:{windowMs:6e4,maxRequests:10}};function o(e,t="ip"){return function(r){return async(i,o)=>{let n="global";"ip"===t&&(n=i.headers.get("x-forwarded-for")||i.headers.get("x-real-ip")||"unknown");let c=new a(e),l=await c.check(n);return l.allowed?r(i,o):s.NextResponse.json({error:"Too many requests",resetAt:l.resetAt},{status:429})}}}},24507:(e,t,r)=>{r.d(t,{f:()=>l});var s=r(92048),a=r(55315),i=r.n(a),o=r(21841),n=r(61657);function c(){return(process.env.STORAGE_PROVIDER||"local").toLowerCase()}class l{static async deleteFile(e){if("local"===c()){let t=i().join(process.cwd(),"public","uploads",e);await s.promises.rm(t,{force:!0});return}}static async downloadFile(e){try{let t=c();if("local"===t){let t=i().join(process.cwd(),"public","uploads",e),r=await s.promises.readFile(t);return{success:!0,buffer:r}}if("supabase"===t){let t=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=process.env.SUPABASE_STORAGE_BUCKET||"public",a=(0,n.eI)(t,r),{data:i,error:o}=await a.storage.from(s).download(e);if(o||!i)return{success:!1,error:o?.message||"Download failed"};let c=await i.arrayBuffer();return{success:!0,buffer:Buffer.from(c)}}let r=process.env.AWS_REGION||"us-east-1",a=process.env.AWS_S3_BUCKET||"";if(!a)return{success:!1,error:"AWS_S3_BUCKET not configured"};let l=new o.S3Client({region:r}),d=(await l.send(new o.GetObjectCommand({Bucket:a,Key:e}))).Body,p=[];for await(let e of d)p.push(Buffer.isBuffer(e)?e:Buffer.from(e));return{success:!0,buffer:Buffer.concat(p)}}catch(e){return{success:!1,error:String(e)}}}static async fileExists(e){if("local"===c()){let t=i().join(process.cwd(),"public","uploads",e);try{await s.promises.access(t)}catch{return!1}}return!0}static async uploadFile(e,t,r){let a=c();if("local"===a){let r=i().join(process.cwd(),"public","uploads",e);return await s.promises.mkdir(i().dirname(r),{recursive:!0}),await s.promises.writeFile(r,t),`/uploads/${e}`.replace(/\\/g,"/")}if("supabase"===a){let s=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",i=process.env.SUPABASE_STORAGE_BUCKET||"public",o=(0,n.eI)(s,a),{error:c}=await o.storage.from(i).upload(e,t,{contentType:r,upsert:!0});if(c)throw c;let{data:l}=o.storage.from(i).getPublicUrl(e);return l.publicUrl}let l=process.env.AWS_REGION||"us-east-1",d=process.env.AWS_S3_BUCKET||"",p=new o.S3Client({region:l});return await p.send(new o.PutObjectCommand({Bucket:d,Key:e,Body:t,ContentType:r||"application/octet-stream"})),`https://${d}.s3.${l}.amazonaws.com/${e}`}static async getSignedUrl(e,t=3600){let r=c();if("local"===r)return`/uploads/${e}`.replace(/\\/g,"/");if("supabase"===r){let r=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"",a=process.env.SUPABASE_STORAGE_BUCKET||"public",i=(0,n.eI)(r,s),{data:o,error:c}=await i.storage.from(a).createSignedUrl(e,t);if(c||!o)throw c||Error("Failed to sign URL");return o.signedUrl}let s=process.env.AWS_REGION||"us-east-1",a=process.env.AWS_S3_BUCKET||"";return`https://${a}.s3.${s}.amazonaws.com/${e}`}}},13936:(e,t,r)=>{r.d(t,{e:()=>o,getSupabaseForRequest:()=>c,p:()=>n});var s=r(67721),a=r(61657),i=r(71615);let o=()=>{let e=(0,i.cookies)();return(0,s.createServerClient)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch(e){}},remove(t,r){try{e.set({name:t,value:"",...r})}catch(e){}}}})},n=(0,a.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});function c(e){let t=e.headers.get("authorization")||e.headers.get("Authorization");return t?(0,a.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{global:{headers:{Authorization:t}},auth:{persistSession:!1,autoRefreshToken:!1}}):o()}},73055:(e,t,r)=>{r.d(t,{G:()=>o});var s=r(84770),a=r.n(s);class i{set(e,t,r){for(;this.currentSize+t.length>this.maxSize&&this.cache.size>0;){let e=this.cache.keys().next().value;e&&this.delete(e)}let s={id:a().randomUUID(),key:e,buffer:t,format:r,size:t.length,cachedAt:new Date};this.cache.set(e,s),this.currentSize+=t.length}get(e){return this.cache.get(e)||null}has(e){return this.cache.has(e)}delete(e){let t=this.cache.get(e);return!!t&&(this.currentSize-=t.size,this.cache.delete(e))}clear(){this.cache.clear(),this.currentSize=0}getStats(){return{items:this.cache.size,size:this.currentSize,maxSize:this.maxSize}}constructor(){this.cache=new Map,this.maxSize=1073741824,this.currentSize=0}}let o=new i}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1657,9702],()=>r(84375));module.exports=s})();