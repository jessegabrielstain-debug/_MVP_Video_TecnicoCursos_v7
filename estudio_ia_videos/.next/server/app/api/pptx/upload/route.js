"use strict";(()=>{var e={};e.id=9512,e.ids=[9512,3936],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},74124:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>P,requestAsyncStorage:()=>j,routeModule:()=>I,serverHooks:()=>A,staticGenerationAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{GET:()=>w,POST:()=>y});var a=r(49303),o=r(88716),i=r(60670),n=r(87070),d=r(13936),l=r(91585),p=r(26033),c=r(20629),u=r(55315),m=r(92048),h=r(62619),f=r(86840),g=r(17549);let _=l.Ry({project_id:l.Z_().uuid("ID do projeto inv\xe1lido")}),x=["application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.ms-powerpoint"],y=(0,h.er)(h.fp.UPLOAD,"user")(async function(e){try{let t=(0,d.getSupabaseForRequest)(e),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let a=e.headers.get("content-type");if(!a?.includes("multipart/form-data"))return n.NextResponse.json({error:"Content-Type deve ser multipart/form-data"},{status:400});let o=await e.formData(),i=o.get("file"),l=o.get("project_id");if(!i)return n.NextResponse.json({error:"Arquivo \xe9 obrigat\xf3rio"},{status:400});if(!l)return n.NextResponse.json({error:"ID do projeto \xe9 obrigat\xf3rio"},{status:400});_.parse({project_id:l});let{data:p}=await t.from("projects").select("user_id").eq("id",l).single();if(!p)return n.NextResponse.json({error:"Projeto n\xe3o encontrado"},{status:404});let h=p.user_id===r.id;if(!h){let{data:e}=await t.from("project_collaborators").select("permissions").eq("project_id",l).eq("user_id",r.id).single();e&&e.permissions?.can_edit&&(h=!0)}if(!h)return n.NextResponse.json({error:"Sem permiss\xe3o para fazer upload neste projeto"},{status:403});if(i.size>52428800)return n.NextResponse.json({error:`Arquivo muito grande. M\xe1ximo permitido: 50MB`},{status:400});if(!x.includes(i.type))return n.NextResponse.json({error:"Tipo de arquivo n\xe3o permitido. Apenas arquivos PPTX s\xe3o aceitos."},{status:400});let f=Date.now(),y=Math.random().toString(36).substring(2,15),w=i.name.split(".").pop(),I=`${f}_${y}.${w}`,j=(0,u.join)(process.cwd(),"uploads","pptx");(0,m.existsSync)(j)||await (0,c.mkdir)(j,{recursive:!0});let q=(0,u.join)(j,I),A=await i.arrayBuffer(),b=Buffer.from(A);await (0,c.writeFile)(q,b);let{data:P,error:R}=await t.from("pptx_uploads").insert({project_id:l,user_id:r.id,filename:I,original_filename:i.name,file_path:q,file_size:i.size,mime_type:i.type,status:"uploaded"}).select().single();if(R)return console.error("Erro ao criar registro de upload:",R),n.NextResponse.json({error:"Erro ao salvar informa\xe7\xf5es do upload"},{status:500});await t.from("project_history").insert({project_id:l,user_id:r.id,action:"create",entity_type:"pptx_upload",entity_id:P.id,description:`Arquivo PPTX "${i.name}" enviado`,changes:{uploaded_file:{filename:i.name,size:i.size,type:i.type}}});let S=`project:${l}:uploads`;return g.O.sendNotification({id:`upload_${P.id}_started_${Date.now()}`,type:"upload_started",title:"Upload iniciado",message:`Arquivo ${i.name} enviado, iniciando processamento`,priority:"low",timestamp:Date.now(),userId:r.id,roomId:S,data:{uploadId:P.id,filename:i.name,projectId:l}}),v(P.id,q,l),n.NextResponse.json({upload_id:P.id,filename:P.filename,original_filename:P.original_filename,file_size:P.file_size,status:P.status,message:"Upload realizado com sucesso. Processamento iniciado."},{status:201})}catch(e){if(e instanceof p.jm)return n.NextResponse.json({error:"Dados inv\xe1lidos",details:e.errors},{status:400});return console.error("Erro no upload de PPTX:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}});async function w(e){try{let t=(0,d.getSupabaseForRequest)(e),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:a}=new URL(e.url),o=a.get("project_id"),i=a.get("status");if(!o)return n.NextResponse.json({error:"ID do projeto \xe9 obrigat\xf3rio"},{status:400});let{data:l}=await t.from("projects").select("user_id, is_public").eq("id",o).single();if(!l)return n.NextResponse.json({error:"Projeto n\xe3o encontrado"},{status:404});let p=l.user_id===r.id||l.is_public;if(!p){let{data:e}=await t.from("project_collaborators").select("user_id").eq("project_id",o).eq("user_id",r.id).single();e&&(p=!0)}if(!p)return n.NextResponse.json({error:"Sem permiss\xe3o para acessar este projeto"},{status:403});let c=t.from("pptx_uploads").select(`
        *,
        pptx_slides:pptx_slides(count)
      `).eq("project_id",o).order("created_at",{ascending:!1});i&&(c=c.eq("status",i));let{data:u,error:m}=await c;if(m)return console.error("Erro ao buscar uploads:",m),n.NextResponse.json({error:"Erro interno do servidor"},{status:500});return n.NextResponse.json({uploads:u||[]})}catch(e){return console.error("Erro na API de uploads PPTX:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function v(e,t,r){try{let s=d.p,a=`project:${r}:uploads`;await s.from("pptx_uploads").update({status:"processing",processing_progress:10}).eq("id",e),g.O.sendNotification({id:`upload_${e}_processing_start_${Date.now()}`,type:"video_processing",title:"Processando arquivo",message:"Analisando e extraindo slides do PPTX...",priority:"medium",timestamp:Date.now(),roomId:a,data:{uploadId:e,phase:"processing",progress:10,total:100,percentage:10}});let o=await (0,c.readFile)(t),i=await f.ZP.extract(o);if(!i.success){let e="string"==typeof i.error?i.error:"Falha ao extrair dados do PPTX";throw Error(e)}await s.from("pptx_uploads").update({processing_progress:50}).eq("id",e),g.O.sendNotification({id:`upload_${e}_processing_mid_${Date.now()}`,type:"upload_progress",title:"Extra\xe7\xe3o de slides conclu\xedda",message:"Gerando thumbnails e salvando slides...",priority:"medium",timestamp:Date.now(),roomId:a||"",data:{uploadId:e,phase:"processing",progress:50,total:100,percentage:50,slideCount:i.slides.length}});let{data:n}=await s.from("pptx_uploads").select("project_id").eq("id",e).single(),l=null;if(n){let t=i.slides.map((t,r)=>({upload_id:e,project_id:n.project_id,slide_number:t.slideNumber,title:t.title,content:t.content,notes:t.notes,image_url:t.images?.[0]||null,thumbnail_url:null,background_color:null,duration:t.duration,transition_type:"fade",transition_duration:.5,audio_url:null,tts_text:null,voice_settings:{},animations:t.animations||[],effects:[],metadata:{layout:t.layout,shapes:t.shapes,textBlocks:t.textBlocks,images:t.images}}));(l=await f.ZP.generateThumbnail(o,r))&&t.length>0&&(t[0].thumbnail_url=l),await s.from("pptx_slides").insert(t)}await s.from("pptx_uploads").update({status:"completed",processing_progress:100,slide_count:i.slides.length,slides_data:i.slides,metadata:i.metadata,preview_url:l,processed_at:new Date().toISOString()}).eq("id",e),g.O.sendNotification({id:`upload_${e}_complete_${Date.now()}`,type:"upload_complete",title:"Processamento conclu\xeddo",message:"Seu PPTX foi processado com sucesso!",priority:"low",timestamp:Date.now(),roomId:a,persistent:!0,data:{uploadId:e,phase:"complete",progress:100,total:100,percentage:100,slideCount:i.slides.length,previewUrl:l}})}catch(s){console.error("Erro no processamento de PPTX:",s);let t=d.p;await t.from("pptx_uploads").update({status:"failed",error_message:"Erro durante o processamento do arquivo"}).eq("id",e),g.O.sendNotification({id:`upload_${e}_error_${Date.now()}`,type:"upload_error",title:"Erro no processamento",message:"Ocorreu um erro durante o processamento do PPTX.",priority:"high",timestamp:Date.now(),roomId:`project:${r}:uploads`,persistent:!0,data:{uploadId:e,phase:"error"}})}}let I=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/pptx/upload/route",pathname:"/api/pptx/upload",filename:"route",bundlePath:"app/api/pptx/upload/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\pptx\\upload\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:j,staticGenerationAsyncStorage:q,serverHooks:A}=I,b="/api/pptx/upload/route";function P(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:q})}},17549:(e,t,r)=>{r.d(t,{O:()=>o,f:()=>a});var s=r(61657);class a{constructor(){this.rooms=new Map;let e="https://ofhzrdiadxigrvmrhaiz.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;e&&t||console.warn("⚠️ Supabase credentials not found in NotificationManager"),this.supabase=(0,s.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}static getInstance(){return a.instance||(a.instance=new a),a.instance}getRoom(e){return this.rooms.get(e)}createRoom(e,t){let r={id:e,name:t,members:new Set,createdAt:new Date};return this.rooms.set(e,r),r}joinRoom(e,t){let r=this.rooms.get(e);return!!r&&(r.members.add(t),!0)}leaveRoom(e,t){let r=this.rooms.get(e);return!!r&&r.members.delete(t)}async create(e){e.userId,e.type,e.title,e.message,e.actionUrl,e.expiresAt?.toISOString(),new Date().toISOString();let{data:t,error:r}=await this.supabase.from("analytics_events").insert({user_id:e.userId,event_type:"notification",event_data:{type:e.type,title:e.title,message:e.message,read:!1,actionUrl:e.actionUrl,expiresAt:e.expiresAt},created_at:new Date().toISOString()}).select().single();if(r)throw console.error("Failed to create notification:",r),r;return{id:t.id,userId:t.user_id,type:t.event_data.type,title:t.event_data.title,message:t.event_data.message,read:t.event_data.read,createdAt:new Date(t.created_at),expiresAt:t.event_data.expiresAt?new Date(t.event_data.expiresAt):void 0,actionUrl:t.event_data.actionUrl}}async getForUser(e,t=!1){let r=this.supabase.from("analytics_events").select("*").eq("user_id",e).eq("event_type","notification").order("created_at",{ascending:!1}),{data:s,error:a}=await r.limit(50);if(a)return[];let o=s.map(e=>({id:e.id,userId:e.user_id,type:e.event_data.type,title:e.event_data.title,message:e.event_data.message,read:e.event_data.read,createdAt:new Date(e.created_at),expiresAt:e.event_data.expiresAt?new Date(e.event_data.expiresAt):void 0,actionUrl:e.event_data.actionUrl}));return t&&(o=o.filter(e=>!e.read)),o}async markAsRead(e){let{data:t}=await this.supabase.from("analytics_events").select("event_data").eq("id",e).single();if(!t)return!1;let r={...t.event_data,read:!0},{error:s}=await this.supabase.from("analytics_events").update({event_data:r}).eq("id",e);return!s}async delete(e){let{error:t}=await this.supabase.from("analytics_events").delete().eq("id",e);return!t}async deleteAllForUser(e){let{count:t,error:r}=await this.supabase.from("analytics_events").delete({count:"exact"}).eq("user_id",e).eq("event_type","notification");return r?0:t||0}async sendToUser(e,t){try{let r=t.data;await this.create({userId:e,type:"error"===t.type||"upload_error"===t.type?"error":"info",title:t.title,message:t.message,actionUrl:r?.uploadId?`/upload/${r.uploadId}`:void 0})}catch(e){console.error("Error sending notification to user:",e)}}async broadcastToRoom(e,t){console.log(`[NotificationManager] Broadcasting to room ${e}:`,t.title)}async sendNotification(e){if(!1!==e.persistent&&e.userId)try{await this.create({userId:e.userId,type:"error"===e.type||"upload_error"===e.type?"error":"info",title:e.title,message:e.message,actionUrl:e.data?.uploadId?`/upload/${e.data.uploadId}`:void 0})}catch(e){console.error("Error persisting notification:",e)}e.roomId&&await this.broadcastToRoom(e.roomId,e),e.userId&&!e.roomId&&console.log(`[NotificationManager] Sending to user ${e.userId}:`,e.title)}}let o=new a},39953:(e,t,r)=>{r.d(t,{h$:()=>s,o9:()=>o});class s{async parse(e){return console.log("[PPTX Parser] Parsing presentation"),{slides:[],metadata:{slideCount:0},images:[]}}async extractImages(e){return[]}}let a=new s;async function o(e){return a.parse(e)}},86840:(e,t,r)=>{r.d(t,{QP:()=>d,ZP:()=>l});var s=r(89190),a=r.n(s),o=r(4096);class i{constructor(e){this.jobId=e,this.parser=new o.Z({ignoreAttributes:!1,attributeNamePrefix:"@_"})}async parseStructure(e){console.log(`[PPTX Core ${this.jobId||""}] Parsing structure`);let t=await a().loadAsync(e),r={slides:[],layouts:[],masters:[]},s=Object.keys(t.files).filter(e=>e.match(/^ppt\/slides\/slide\d+\.xml$/));for(let e of(s.sort((e,t)=>parseInt(e.match(/slide(\d+)\.xml/)[1])-parseInt(t.match(/slide(\d+)\.xml/)[1])),s)){let s=await t.file(e)?.async("string");if(!s)continue;let a=this.parser.parse(s),o=this.extractText(a);r.slides.push({id:e,content:o})}return r}async parseFile(e,t,r){r?.(.1);let s=await this.parseStructure(e);return r?.(.9),{id:`doc_${Date.now()}`,title:t.replace(".pptx",""),author:"Unknown",slides:s.slides.map((e,t)=>({slideNumber:t+1,title:`Slide ${t+1}`,content:e.content.map(e=>({type:"text",content:e}))})),metadata:{createdAt:new Date().toISOString()}}}extractText(e){let t=[];return function e(r){if(Array.isArray(r)){r.forEach(e);return}if("object"==typeof r&&null!==r){if(r["a:t"]){let e=r["a:t"],s="";"string"==typeof e?s=e:"object"==typeof e&&null!==e&&"#text"in e&&(s=e["#text"]),s&&"string"==typeof s&&s.trim().length>0&&t.push(s.trim())}for(let t in r)e(r[t])}}(e),t}async extractRels(e){return{}}}new i;var n=r(39953);class d{async process(e){return console.log("[PPTX Processor] Processing presentation"),await this.coreParser.parseStructure(e),(await this.advancedParser.parse(e)).slides.map(e=>({index:e.index,title:e.title,content:Array.isArray(e.content)?e.content.join("\n"):String(e.content||""),images:[],notes:e.notes}))}async extractText(e){return(await this.process(e)).map(e=>e.content).join("\n\n")}static async extract(e){try{let t=await a().loadAsync(e),r=new o.Z({ignoreAttributes:!1,attributeNamePrefix:"@_"}),s={title:"Sem t\xedtulo",author:"Desconhecido",totalSlides:0,application:"Unknown",dimensions:{width:0,height:0}},i=t.file("docProps/core.xml");if(i){let e=await i.async("string"),t=r.parse(e)["cp:coreProperties"];t&&(s.title=t["dc:title"]||s.title,s.author=t["dc:creator"]||s.author)}let n=t.file("docProps/app.xml");if(n){let e=await n.async("string"),t=r.parse(e).Properties;t&&(s.application=t.Application||s.application,s.totalSlides=parseInt(t.Slides||"0"))}s.dimensions={width:1920,height:1080};let d=[],l=Object.keys(t.files).filter(e=>e.match(/ppt\/slides\/slide\d+\.xml/));l.sort((e,t)=>{let r=parseInt(e.match(/slide(\d+)\.xml/)[1]),s=parseInt(t.match(/slide(\d+)\.xml/)[1]);return r-s});for(let e=0;e<l.length;e++){let s=l[e],a=await t.file(s).async("string"),o=r.parse(a),i=e+1,n="",p="",c="",u=[],m=o["p:sld"]?.["p:cSld"]?.["p:spTree"],h=m?.["p:sp"];h&&(Array.isArray(h)?h:[h]).forEach(e=>{let t=e["p:txBody"];t&&(Array.isArray(t["a:p"])?t["a:p"]:[t["a:p"]]).forEach(e=>{e&&e["a:r"]&&(Array.isArray(e["a:r"])?e["a:r"]:[e["a:r"]]).forEach(e=>{e&&e["a:t"]&&u.push(e["a:t"])})})}),u.length>0&&(n=u[0],p=u.join(" "));let f=t.file(`ppt/notesSlides/notesSlide${i}.xml`);if(f){let e=await f.async("string"),t=r.parse(e),s=t["p:notes"]?.["p:cSld"]?.["p:spTree"],a=s?.["p:sp"];a&&(Array.isArray(a)?a:[a]).forEach(e=>{let t=e["p:txBody"];t&&(Array.isArray(t["a:p"])?t["a:p"]:[t["a:p"]]).forEach(e=>{e&&e["a:r"]&&(Array.isArray(e["a:r"])?e["a:r"]:[e["a:r"]]).forEach(e=>{e&&e["a:t"]&&(c+=e["a:t"]+" ")})})})}d.push({slideNumber:i,title:n,content:p,notes:c.trim(),layout:"default",images:[],animations:[],duration:5,shapes:1,textBlocks:u.length})}let p={images:[],videos:[],audio:[]};Object.keys(t.files).filter(e=>e.startsWith("ppt/media/")).forEach(e=>{(e.endsWith(".png")||e.endsWith(".jpg"))&&p.images.push(e)});let c={totalDuration:5*d.length,scenes:d.map((e,t)=>({sceneId:`scene_${t+1}`,slideNumber:e.slideNumber,startTime:5*t,endTime:(t+1)*5,transitions:[]}))},u={textBlocks:10,images:p.images.length,shapes:5,charts:0,tables:0};return{success:!0,slides:d,metadata:s,assets:p,timeline:c,extractionStats:u}}catch(e){return{success:!1,error:e,slides:[]}}}static async generateThumbnail(e,t){try{if(e.toString().includes("invalid"))return null;return"thumbnails/mock.png"}catch(e){return null}}constructor(){this.coreParser=new i,this.advancedParser=new n.h$}}new d;let l=d},62619:(e,t,r)=>{r.d(t,{er:()=>i,fp:()=>o});var s=r(87070);class a{constructor(e){this.config=e,this.requests=new Map}async check(e){let t=Date.now(),r=t-this.config.windowMs,s=this.requests.get(e)||[],a=(s=s.filter(e=>e>r)).length<this.config.maxRequests;return a&&(s.push(t),this.requests.set(e,s)),{allowed:a,remaining:Math.max(0,this.config.maxRequests-s.length),resetAt:new Date(t+this.config.windowMs)}}async reset(e){this.requests.delete(e)}async clearExpired(){let e=Date.now()-this.config.windowMs;for(let[t,r]of this.requests.entries()){let s=r.filter(t=>t>e);0===s.length?this.requests.delete(t):this.requests.set(t,s)}}}new a({windowMs:6e4,maxRequests:100});let o={DEFAULT:{windowMs:6e4,maxRequests:100},API:{windowMs:6e4,maxRequests:60},AUTH_API:{windowMs:6e4,maxRequests:60},AUTH_STRICT:{windowMs:6e4,maxRequests:30},UPLOAD:{windowMs:6e4,maxRequests:10}};function i(e,t="ip"){return function(r){return async(o,i)=>{let n="global";"ip"===t&&(n=o.headers.get("x-forwarded-for")||o.headers.get("x-real-ip")||"unknown");let d=new a(e),l=await d.check(n);return l.allowed?r(o,i):s.NextResponse.json({error:"Too many requests",resetAt:l.resetAt},{status:429})}}}},13936:(e,t,r)=>{r.d(t,{e:()=>i,getSupabaseForRequest:()=>d,p:()=>n});var s=r(67721),a=r(61657),o=r(71615);let i=()=>{let e=(0,o.cookies)();return(0,s.createServerClient)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch(e){}},remove(t,r){try{e.set({name:t,value:"",...r})}catch(e){}}}})},n=(0,a.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});function d(e){let t=e.headers.get("authorization")||e.headers.get("Authorization");return t?(0,a.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{global:{headers:{Authorization:t}},auth:{persistSession:!1,autoRefreshToken:!1}}):i()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1657,9702,1585,9190,4096],()=>r(74124));module.exports=s})();