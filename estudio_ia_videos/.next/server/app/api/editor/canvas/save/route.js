"use strict";(()=>{var e={};e.id=6481,e.ids=[6481],e.modules={572934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},554580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},345869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},627790:e=>{e.exports=require("assert")},978893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},986624:e=>{e.exports=require("querystring")},917360:e=>{e.exports=require("url")},521764:e=>{e.exports=require("util")},671568:e=>{e.exports=require("zlib")},774726:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>E,requestAsyncStorage:()=>j,routeModule:()=>x,serverHooks:()=>O,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>v,PUT:()=>f});var o=r(349303),n=r(88716),s=r(60670),i=r(387070),d=r(95715),u=r(200856),c=r(691585);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}();let p=c.Ry({projectId:c.Z_(),canvas:c.Ry({width:c.Rx(),height:c.Rx(),background:c.Z_(),elements:c.IX(c.Ry({id:c.Z_(),type:c.Km(["text","image","video","shape","avatar"]),x:c.Rx(),y:c.Rx(),width:c.Rx(),height:c.Rx(),properties:c.Yj(),layer:c.Rx()}))}),timeline:c.IX(c.Ry({id:c.Z_(),elementId:c.Z_(),startTime:c.Rx(),duration:c.Rx(),animations:c.IX(c.Yj()).optional()}))});class l{async saveCanvasData(e,t,r){try{let a=t.elements.map(e=>{switch(e.type){case"text":return{...e,properties:{text:e.properties.text||"",fontSize:e.properties.fontSize||16,fontFamily:e.properties.fontFamily||"Arial",color:e.properties.color||"#000000",textAlign:e.properties.textAlign||"left"}};case"avatar":return{...e,properties:{model:e.properties.model||"default",animation:e.properties.animation||"idle",voice:e.properties.voice||"pt-BR-female",script:e.properties.script||""}};default:return e}}),o=Math.max(...r.map(e=>e.startTime+e.duration),0);return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:e},data:{metadata:{canvas:{...t,elements:a},timeline:r,totalDuration:o,editedAt:new Date().toISOString()}}}),{canvas:{...t,elements:a},timeline:r,totalDuration:o}}catch(e){throw console.error("Error saving canvas data:",e),Error("Failed to save canvas data")}}async generateVideoConfig(e,t){let r=t.map(t=>{let r=e.elements.find(e=>e.id===t.elementId);return r?{id:t.id,type:r.type,startTime:t.startTime,duration:t.duration,position:{x:r.x,y:r.y},size:{width:r.width,height:r.height},properties:r.properties,animations:t.animations||[]}:null}).filter(Boolean);return{resolution:{width:e.width,height:e.height},background:e.background,scenes:r,totalDuration:Math.max(...t.map(e=>e.startTime+e.duration),0)}}async addElement(e,t){try{let r=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findUnique({where:{id:e}});if(!r)throw Error("Project not found");let a=r.metadata?.canvas||{elements:[]},o=[...a.elements,t];return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:e},data:{metadata:{...r.metadata,canvas:{...a,elements:o}}}}),t}catch(e){throw console.error("Error adding element:",e),Error("Failed to add element")}}}let m=new l;async function v(e){try{let t=await (0,d.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),a=p.parse(r);if(!await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:a.projectId,userId:t.user.id}}))return i.NextResponse.json({error:"Project not found"},{status:404});let o=await m.saveCanvasData(a.projectId,a.canvas,a.timeline),n=await m.generateVideoConfig(a.canvas,a.timeline);return await u.workflowManager.updateWorkflowStep(a.projectId,"edit","completed",{canvas:o.canvas,timeline:o.timeline,videoConfig:n}),i.NextResponse.json({success:!0,result:o,videoConfig:n,message:"Canvas data saved successfully"})}catch(e){return console.error("Canvas Editor API Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{let t=await (0,d.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{projectId:r,element:a}=await e.json();if(!r||!a)return i.NextResponse.json({error:"Project ID and element required"},{status:400});if(!await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:r,userId:t.user.id}}))return i.NextResponse.json({error:"Project not found"},{status:404});let o=await m.addElement(r,a);return i.NextResponse.json({success:!0,element:o,message:"Element added successfully"})}catch(e){return console.error("Canvas Editor PUT Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let t=await (0,d.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("projectId");if(!a)return i.NextResponse.json({error:"Project ID required"},{status:400});let o=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:a,userId:t.user.id}});if(!o)return i.NextResponse.json({error:"Project not found"},{status:404});return i.NextResponse.json({canvas:o.metadata?.canvas||null,timeline:o.metadata?.timeline||[],totalDuration:o.metadata?.totalDuration||0})}catch(e){return console.error("Canvas Editor GET Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let x=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/editor/canvas/save/route",pathname:"/api/editor/canvas/save",filename:"route",bundlePath:"app/api/editor/canvas/save/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\editor\\canvas\\save\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:j,staticGenerationAsyncStorage:w,serverHooks:O}=x,g="/api/editor/canvas/save/route";function E(){return(0,s.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:w})}},200856:(e,t,r)=>{r.r(t),r.d(t,{POST:()=>o});var a=r(387070);async function o(){return a.NextResponse.json({message:"Unified route stub"})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,5715,1585],()=>r(774726));module.exports=a})();