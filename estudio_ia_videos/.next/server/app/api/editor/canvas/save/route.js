"use strict";(()=>{var e={};e.id=6481,e.ids=[6481],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},74726:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>w,serverHooks:()=>R,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{GET:()=>j,POST:()=>h,PUT:()=>f});var s=r(49303),n=r(88716),o=r(60670),i=r(87070),d=r(75571),u=r(95306),p=r(8261),c=r(60519),l=r(91585);let m=l.Ry({projectId:l.Z_(),canvas:l.Ry({width:l.Rx(),height:l.Rx(),background:l.Z_(),elements:l.IX(l.Ry({id:l.Z_(),type:l.Km(["text","image","video","shape","avatar"]),x:l.Rx(),y:l.Rx(),width:l.Rx(),height:l.Rx(),properties:l.IM(l._4()),layer:l.Rx()}))}),timeline:l.IX(l.Ry({id:l.Z_(),elementId:l.Z_(),startTime:l.Rx(),duration:l.Rx(),animations:l.IX(l.IM(l._4())).optional()}))});class x{async saveCanvasData(e,t,r){try{let a=t.elements.map(e=>{switch(e.type){case"text":return{...e,properties:{text:e.properties.text||"",fontSize:e.properties.fontSize||16,fontFamily:e.properties.fontFamily||"Arial",color:e.properties.color||"#000000",textAlign:e.properties.textAlign||"left"}};case"avatar":return{...e,properties:{model:e.properties.model||"default",animation:e.properties.animation||"idle",voice:e.properties.voice||"pt-BR-female",script:e.properties.script||""}};default:return e}}),s=Math.max(...r.map(e=>e.startTime+e.duration),0),n=await p._.project.findUnique({where:{id:e}}),o=n?.metadata||{};return await p._.project.update({where:{id:e},data:{metadata:{...o,canvas:{...t,elements:a},timeline:r,totalDuration:s,editedAt:new Date().toISOString()}}}),{canvas:{...t,elements:a},timeline:r,totalDuration:s}}catch(e){throw console.error("Error saving canvas data:",e),Error("Failed to save canvas data")}}async generateVideoConfig(e,t){let r=t.map(t=>{let r=e.elements.find(e=>e.id===t.elementId);return r?{id:t.id,type:r.type,startTime:t.startTime,duration:t.duration,position:{x:r.x,y:r.y},size:{width:r.width,height:r.height},properties:r.properties,animations:t.animations||[]}:null}).filter(Boolean);return{resolution:{width:e.width,height:e.height},background:e.background,scenes:r,totalDuration:Math.max(...t.map(e=>e.startTime+e.duration),0)}}async addElement(e,t){try{let r=await p._.project.findUnique({where:{id:e}});if(!r)throw Error("Project not found");let a=r.metadata?.canvas||{elements:[]},s=[...a.elements,t];return await p._.project.update({where:{id:e},data:{metadata:{...r.metadata||{},canvas:{...a,elements:s}}}}),t}catch(e){throw console.error("Error adding element:",e),Error("Failed to add element")}}}let v=new x;async function h(e){try{let t=await (0,d.getServerSession)(u.L);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),a=m.parse(r);if(!await p._.project.findFirst({where:{id:a.projectId,userId:t.user.id}}))return i.NextResponse.json({error:"Project not found"},{status:404});let s=await v.saveCanvasData(a.projectId,a.canvas,a.timeline),n=await v.generateVideoConfig(a.canvas,a.timeline);return await c.B.updateWorkflowStep(a.projectId,"edit","completed",{canvas:s.canvas,timeline:s.timeline,videoConfig:n}),i.NextResponse.json({success:!0,result:s,videoConfig:n,message:"Canvas data saved successfully"})}catch(e){return console.error("Canvas Editor API Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{let t=await (0,d.getServerSession)(u.L);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{projectId:r,element:a}=await e.json();if(!r||!a)return i.NextResponse.json({error:"Project ID and element required"},{status:400});if(!await p._.project.findFirst({where:{id:r,userId:t.user.id}}))return i.NextResponse.json({error:"Project not found"},{status:404});let s=await v.addElement(r,a);return i.NextResponse.json({success:!0,element:s,message:"Element added successfully"})}catch(e){return console.error("Canvas Editor PUT Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function j(e){try{let t=await (0,d.getServerSession)(u.L);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("projectId");if(!a)return i.NextResponse.json({error:"Project ID required"},{status:400});let s=await p._.project.findFirst({where:{id:a,userId:t.user.id}});if(!s)return i.NextResponse.json({error:"Project not found"},{status:404});return i.NextResponse.json({canvas:s.metadata?.canvas||null,timeline:s.metadata?.timeline||[],totalDuration:s.metadata?.totalDuration||0})}catch(e){return console.error("Canvas Editor GET Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/editor/canvas/save/route",pathname:"/api/editor/canvas/save",filename:"route",bundlePath:"app/api/editor/canvas/save/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\editor\\canvas\\save\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:R}=w,q="/api/editor/canvas/save/route";function I(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:y})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,5571,1585,1145],()=>r(74726));module.exports=a})();