"use strict";(()=>{var e={};e.id=5180,e.ids=[5180],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},77296:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>j,routeModule:()=>b,serverHooks:()=>y,staticGenerationAsyncStorage:()=>E});var o={};r.r(o),r.d(o,{DELETE:()=>w,GET:()=>h,POST:()=>g,exportSystem:()=>f});var s=r(49303),a=r(88716),i=r(60670),n=r(87070),p=r(75571),u=r(95306),d=r(8261),l=r(60519),c=r(91585);let m=c.Ry({projectId:c.Z_(),exportConfig:c.Ry({format:c.Km(["mp4","webm","mov","avi"]).default("mp4"),quality:c.Km(["480p","720p","1080p","4k"]).default("1080p"),compression:c.Km(["low","medium","high"]).default("medium"),includeSubtitles:c.O7().default(!1),watermark:c.Ry({enabled:c.O7().default(!1),text:c.Z_().optional(),position:c.Km(["top-left","top-right","bottom-left","bottom-right"]).optional()}).optional(),metadata:c.Ry({title:c.Z_().optional(),description:c.Z_().optional(),author:c.Z_().optional(),tags:c.IX(c.Z_()).optional()}).optional()}).optional()});class x{async startExport(e,t){try{let r=`export_${e}_${Date.now()}`,o={id:r,projectId:e,status:"queued",progress:0,config:t,startedAt:new Date().toISOString()};return this.exportJobs.set(r,o),this.processExportJob(r).catch(e=>{console.error("Export job failed:",e),this.updateJobStatus(r,"error",0,e.message)}),o}catch(e){throw console.error("Error starting export:",e),Error("Failed to start export job")}}async processExportJob(e){let t=this.exportJobs.get(e);if(!t)throw Error("Export job not found");try{this.updateJobStatus(e,"processing",0);let r=await d._.project.findUnique({where:{id:t.projectId}});if(!r)throw Error("Project not found");let o=r.metadata||{};if(!o.render?.outputUrl)throw Error("Project not rendered yet. Please render the video first.");await this.prepareExport(t,o),this.updateJobStatus(e,"processing",25),await this.processVideo(t,o),this.updateJobStatus(e,"processing",50),await this.addWatermark(t),this.updateJobStatus(e,"processing",75);let s=await this.finalizeExport(t);this.updateJobStatus(e,"completed",100,void 0,s.outputUrl,s.downloadUrl,s.fileSize);let a=r.metadata||{};await d._.project.update({where:{id:t.projectId},data:{metadata:{...a,export:{jobId:e,status:"completed",outputUrl:s.outputUrl,downloadUrl:s.downloadUrl,fileSize:s.fileSize,completedAt:new Date().toISOString()}}}})}catch(o){let r=o instanceof Error?o.message:"Unknown error";throw this.updateJobStatus(e,"error",t.progress,r),o}}updateJobStatus(e,t,r,o,s,a,i){let n=this.exportJobs.get(e);n&&(n.status=t,n.progress=r,o&&(n.errorMessage=o),s&&(n.outputUrl=s),a&&(n.downloadUrl=a),i&&(n.fileSize=i),("completed"===t||"error"===t)&&(n.completedAt=new Date().toISOString()),this.exportJobs.set(e,n))}async prepareExport(e,t){await new Promise(e=>setTimeout(e,500)),console.log("Export prepared for job:",e.id)}async processVideo(e,t){let r=t.render?.outputUrl;if(!r)throw Error("Render output URL not found in metadata");await this.simulateVideoProcessing(e,r)}async simulateVideoProcessing(e,t){let{format:r,quality:o,compression:s}=e.config;console.log("Export FFmpeg command:",this.buildExportCommand(t,e.config)),await new Promise(e=>setTimeout(e,1500))}buildExportCommand(e,t){let r=`ffmpeg -i "${e}"`,o=this.getQualitySettings(t.quality,t.compression);return r+=` ${o} -f ${t.format}`,t.metadata&&(t.metadata.title&&(r+=` -metadata title="${t.metadata.title}"`),t.metadata.description&&(r+=` -metadata description="${t.metadata.description}"`),t.metadata.author&&(r+=` -metadata author="${t.metadata.author}"`)),r+=` output.${t.format}`}getQualitySettings(e,t){return`${({"480p":"-s 854x480","720p":"-s 1280x720","1080p":"-s 1920x1080","4k":"-s 3840x2160"})[e]} ${({low:"-crf 28",medium:"-crf 23",high:"-crf 18"})[t]}`}async addWatermark(e){e.config.watermark?.enabled&&(await new Promise(e=>setTimeout(e,500)),console.log("Watermark added for job:",e.id))}async finalizeExport(e){let t=`/api/export/output/${e.id}.${e.config.format}`,r=`/api/export/download/${e.id}.${e.config.format}`;return await new Promise(e=>setTimeout(e,300)),{outputUrl:t,downloadUrl:r,fileSize:Math.floor(100*Math.random())+50}}getExportJob(e){return this.exportJobs.get(e)||null}getProjectExportJobs(e){return Array.from(this.exportJobs.values()).filter(t=>t.projectId===e)}async cancelExport(e){let t=this.exportJobs.get(e);return!!t&&"completed"!==t.status&&(this.updateJobStatus(e,"error",t.progress,"Export cancelled by user"),!0)}async getExportFormats(){return[{id:"mp4",name:"MP4",description:"Formato mais compat\xedvel, recomendado para web e dispositivos m\xf3veis",extension:".mp4",mimeType:"video/mp4"},{id:"webm",name:"WebM",description:"Formato otimizado para web, menor tamanho de arquivo",extension:".webm",mimeType:"video/webm"},{id:"mov",name:"MOV",description:"Formato Apple QuickTime, alta qualidade",extension:".mov",mimeType:"video/quicktime"},{id:"avi",name:"AVI",description:"Formato cl\xe1ssico, compat\xedvel com sistemas antigos",extension:".avi",mimeType:"video/x-msvideo"}]}constructor(){this.exportJobs=new Map}}let f=new x;async function g(e){try{let t=await (0,p.getServerSession)(u.L);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),o=m.parse(r),s=await d._.project.findFirst({where:{id:o.projectId,userId:t.user.id}});if(!s)return n.NextResponse.json({error:"Project not found"},{status:404});let a=s.metadata||{};if(!a.render?.outputUrl)return n.NextResponse.json({error:"Project not rendered yet. Please render the video first."},{status:400});await l.B.updateWorkflowStep(o.projectId,"export","processing");let i=await f.startExport(o.projectId,o.exportConfig||{format:"mp4",quality:"1080p",compression:"medium",includeSubtitles:!1});return n.NextResponse.json({success:!0,exportJob:i,message:"Export job started successfully"})}catch(e){return console.error("Export API Error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let t=await (0,p.getServerSession)(u.L);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),o=r.get("action"),s=r.get("jobId"),a=r.get("projectId");if("formats"===o){let e=await f.getExportFormats();return n.NextResponse.json({formats:e})}if(s){let e=f.getExportJob(s);if(!e)return n.NextResponse.json({error:"Export job not found"},{status:404});return n.NextResponse.json({exportJob:e})}if(a){if(!await d._.project.findFirst({where:{id:a,userId:t.user.id}}))return n.NextResponse.json({error:"Project not found"},{status:404});let e=f.getProjectExportJobs(a);return n.NextResponse.json({exportJobs:e})}return n.NextResponse.json({error:"Action, Job ID or Project ID required"},{status:400})}catch(e){return console.error("Export GET Error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let t=await (0,p.getServerSession)(u.L);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),o=r.get("jobId");if(!o)return n.NextResponse.json({error:"Job ID required"},{status:400});if(!await f.cancelExport(o))return n.NextResponse.json({error:"Cannot cancel export job"},{status:400});return n.NextResponse.json({success:!0,message:"Export job cancelled"})}catch(e){return console.error("Export DELETE Error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let b=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/export/mp4/route",pathname:"/api/export/mp4",filename:"route",bundlePath:"app/api/export/mp4/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\export\\mp4\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:j,staticGenerationAsyncStorage:E,serverHooks:y}=b,v="/api/export/mp4/route";function S(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:E})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,5571,1585,1145],()=>r(77296));module.exports=o})();