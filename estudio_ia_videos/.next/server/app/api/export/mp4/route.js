"use strict";(()=>{var e={};e.id=5180,e.ids=[5180],e.modules={572934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},554580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},345869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},627790:e=>{e.exports=require("assert")},978893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},986624:e=>{e.exports=require("querystring")},917360:e=>{e.exports=require("url")},521764:e=>{e.exports=require("util")},671568:e=>{e.exports=require("zlib")},377296:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>j});var o={};r.r(o),r.d(o,{DELETE:()=>x,GET:()=>w,POST:()=>f,exportSystem:()=>m});var a=r(349303),s=r(88716),n=r(60670),i=r(387070),p=r(95715),d=r(396781),u=r(691585);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}();let c=u.Ry({projectId:u.Z_(),exportConfig:u.Ry({format:u.Km(["mp4","webm","mov","avi"]).default("mp4"),quality:u.Km(["480p","720p","1080p","4k"]).default("1080p"),compression:u.Km(["low","medium","high"]).default("medium"),includeSubtitles:u.O7().default(!1),watermark:u.Ry({enabled:u.O7().default(!1),text:u.Z_().optional(),position:u.Km(["top-left","top-right","bottom-left","bottom-right"]).optional()}).optional(),metadata:u.Ry({title:u.Z_().optional(),description:u.Z_().optional(),author:u.Z_().optional(),tags:u.IX(u.Z_()).optional()}).optional()}).optional()});class l{async startExport(e,t){try{let r=`export_${e}_${Date.now()}`,o={id:r,projectId:e,status:"queued",progress:0,config:t,startedAt:new Date().toISOString()};return this.exportJobs.set(r,o),this.processExportJob(r).catch(e=>{console.error("Export job failed:",e),this.updateJobStatus(r,"error",0,e.message)}),o}catch(e){throw console.error("Error starting export:",e),Error("Failed to start export job")}}async processExportJob(e){let t=this.exportJobs.get(e);if(!t)throw Error("Export job not found");try{this.updateJobStatus(e,"processing",0);let r=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findUnique({where:{id:t.projectId}});if(!r)throw Error("Project not found");if(!r.metadata?.render?.outputUrl)throw Error("Project not rendered yet. Please render the video first.");await this.prepareExport(t,r.metadata),this.updateJobStatus(e,"processing",25),await this.processVideo(t,r.metadata),this.updateJobStatus(e,"processing",50),await this.addWatermark(t),this.updateJobStatus(e,"processing",75);let o=await this.finalizeExport(t);this.updateJobStatus(e,"completed",100,void 0,o.outputUrl,o.downloadUrl,o.fileSize),await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:t.projectId},data:{metadata:{...r.metadata,export:{jobId:e,status:"completed",outputUrl:o.outputUrl,downloadUrl:o.downloadUrl,fileSize:o.fileSize,completedAt:new Date().toISOString()}}}})}catch(r){throw this.updateJobStatus(e,"error",t.progress,r.message),r}}updateJobStatus(e,t,r,o,a,s,n){let i=this.exportJobs.get(e);i&&(i.status=t,i.progress=r,o&&(i.errorMessage=o),a&&(i.outputUrl=a),s&&(i.downloadUrl=s),n&&(i.fileSize=n),("completed"===t||"error"===t)&&(i.completedAt=new Date().toISOString()),this.exportJobs.set(e,i))}async prepareExport(e,t){await new Promise(e=>setTimeout(e,500)),console.log("Export prepared for job:",e.id)}async processVideo(e,t){let r=t.render.outputUrl;await this.simulateVideoProcessing(e,r)}async simulateVideoProcessing(e,t){let{format:r,quality:o,compression:a}=e.config;console.log("Export FFmpeg command:",this.buildExportCommand(t,e.config)),await new Promise(e=>setTimeout(e,1500))}buildExportCommand(e,t){let r=`ffmpeg -i "${e}"`,o=this.getQualitySettings(t.quality,t.compression);return r+=` ${o} -f ${t.format}`,t.metadata&&(t.metadata.title&&(r+=` -metadata title="${t.metadata.title}"`),t.metadata.description&&(r+=` -metadata description="${t.metadata.description}"`),t.metadata.author&&(r+=` -metadata author="${t.metadata.author}"`)),r+=` output.${t.format}`}getQualitySettings(e,t){return`${({"480p":"-s 854x480","720p":"-s 1280x720","1080p":"-s 1920x1080","4k":"-s 3840x2160"})[e]} ${({low:"-crf 28",medium:"-crf 23",high:"-crf 18"})[t]}`}async addWatermark(e){e.config.watermark?.enabled&&(await new Promise(e=>setTimeout(e,500)),console.log("Watermark added for job:",e.id))}async finalizeExport(e){let t=`/api/export/output/${e.id}.${e.config.format}`,r=`/api/export/download/${e.id}.${e.config.format}`;return await new Promise(e=>setTimeout(e,300)),{outputUrl:t,downloadUrl:r,fileSize:Math.floor(100*Math.random())+50}}getExportJob(e){return this.exportJobs.get(e)||null}getProjectExportJobs(e){return Array.from(this.exportJobs.values()).filter(t=>t.projectId===e)}async cancelExport(e){let t=this.exportJobs.get(e);return!!t&&"completed"!==t.status&&(this.updateJobStatus(e,"error",t.progress,"Export cancelled by user"),!0)}async getExportFormats(){return[{id:"mp4",name:"MP4",description:"Formato mais compat\xedvel, recomendado para web e dispositivos m\xf3veis",extension:".mp4",mimeType:"video/mp4"},{id:"webm",name:"WebM",description:"Formato otimizado para web, menor tamanho de arquivo",extension:".webm",mimeType:"video/webm"},{id:"mov",name:"MOV",description:"Formato Apple QuickTime, alta qualidade",extension:".mov",mimeType:"video/quicktime"},{id:"avi",name:"AVI",description:"Formato cl\xe1ssico, compat\xedvel com sistemas antigos",extension:".avi",mimeType:"video/x-msvideo"}]}constructor(){this.exportJobs=new Map}}let m=new l;async function f(e){try{let t=await (0,p.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),o=c.parse(r),a=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:o.projectId,userId:t.user.id}});if(!a)return i.NextResponse.json({error:"Project not found"},{status:404});if(!a.metadata?.render?.outputUrl)return i.NextResponse.json({error:"Project not rendered yet. Please render the video first."},{status:400});await d.workflowManager.updateWorkflowStep(o.projectId,"export","processing");let s=await m.startExport(o.projectId,o.exportConfig||{format:"mp4",quality:"1080p",compression:"medium",includeSubtitles:!1});return i.NextResponse.json({success:!0,exportJob:s,message:"Export job started successfully"})}catch(r){console.error("Export API Error:",r);let t=await e.json().catch(()=>({}));return t.projectId&&await d.workflowManager.updateWorkflowStep(t.projectId,"export","error",{error:r.message}),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let t=await (0,p.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),o=r.get("action"),a=r.get("jobId"),s=r.get("projectId");if("formats"===o){let e=await m.getExportFormats();return i.NextResponse.json({formats:e})}if(a){let e=m.getExportJob(a);if(!e)return i.NextResponse.json({error:"Export job not found"},{status:404});return i.NextResponse.json({exportJob:e})}if(s){if(!await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:s,userId:t.user.id}}))return i.NextResponse.json({error:"Project not found"},{status:404});let e=m.getProjectExportJobs(s);return i.NextResponse.json({exportJobs:e})}return i.NextResponse.json({error:"Action, Job ID or Project ID required"},{status:400})}catch(e){return console.error("Export GET Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function x(e){try{let t=await (0,p.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),o=r.get("jobId");if(!o)return i.NextResponse.json({error:"Job ID required"},{status:400});if(!await m.cancelExport(o))return i.NextResponse.json({error:"Cannot cancel export job"},{status:400});return i.NextResponse.json({success:!0,message:"Export job cancelled"})}catch(e){return console.error("Export DELETE Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/export/mp4/route",pathname:"/api/export/mp4",filename:"route",bundlePath:"app/api/export/mp4/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\export\\mp4\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:j,serverHooks:b}=h,E="/api/export/mp4/route";function y(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:j})}},396781:(e,t,r)=>{r.r(t),r.d(t,{DELETE:()=>m,GET:()=>u,POST:()=>c,PUT:()=>l,workflowManager:()=>d});var o=r(387070),a=r(95715);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}();var s=r(691585);let n=s.Ry({name:s.Z_().min(1),type:s.Km(["pptx","template-nr","talking-photo","custom"]),source:s.Ry({type:s.Km(["upload","template","blank"]),data:s._4().optional()})}),i=s.Ry({id:s.Z_(),action:s.Km(["edit","render","export","delete"]),data:s._4().optional()});class p{async createWorkflow(e,t){let r={projectId:e,currentStep:"import",steps:{import:{status:"pending"},edit:{status:"pending"},avatar:{status:"pending"},tts:{status:"pending"},render:{status:"pending"},export:{status:"pending"}},metadata:{createdAt:new Date,updatedAt:new Date,userId:t}};return this.workflows.set(e,r),r}async updateWorkflowStep(e,t,r,o){let a=this.workflows.get(e);if(!a)return null;if(a.steps[t]={status:r,data:o},a.metadata.updatedAt=new Date,"completed"===r){let e=["import","edit","avatar","tts","render","export"],r=e.indexOf(t);r<e.length-1?a.currentStep=e[r+1]:a.currentStep="complete"}return this.workflows.set(e,a),a}getWorkflow(e){return this.workflows.get(e)||null}async executeStep(e,t,r){if(!this.workflows.get(e))throw Error("Workflow not found");await this.updateWorkflowStep(e,t,"processing");try{let o;switch(t){case"import":o=await this.executeImport(e,r);break;case"edit":o=await this.executeEdit(e,r);break;case"avatar":o=await this.executeAvatar(e,r);break;case"tts":o=await this.executeTTS(e,r);break;case"render":o=await this.executeRender(e,r);break;case"export":o=await this.executeExport(e,r);break;default:throw Error(`Unknown step: ${t}`)}return await this.updateWorkflowStep(e,t,"completed",o),o}catch(o){let r=o instanceof Error?o.message:"Unknown error";throw await this.updateWorkflowStep(e,t,"error",{error:r}),o}}async executeImport(e,t){if(t&&"string"==typeof t.type&&"pptx"===t.type){let r=await fetch("/api/pptx/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,file:t.file})});return await r.json()}if(t&&"string"==typeof t.type&&"template-nr"===t.type){let r=await fetch("/api/templates/nr/load",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,template:t.template})});return await r.json()}return{success:!0,message:"Import completed"}}async executeEdit(e,t){let r=await fetch("/api/editor/canvas/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,editorData:t})});return await r.json()}async executeAvatar(e,t){let r=await fetch("/api/avatars/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,avatarConfig:t&&"object"==typeof t.avatar?t.avatar:{model:"default"},script:t&&"string"==typeof t.script?t.script:"Texto padr\xe3o"})});return await r.json()}async executeTTS(e,t){let r=await fetch("/api/tts/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,text:t&&"string"==typeof t.text?t.text:"Texto padr\xe3o",voice:t&&"string"==typeof t.voice?t.voice:"pt-BR-female-1",language:t&&"string"==typeof t.language?t.language:"pt-BR"})});return await r.json()}async executeRender(e,t){let r=await fetch("/api/render/video",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,renderConfig:t||{resolution:{width:1920,height:1080},fps:30,quality:"high",format:"mp4",codec:"h264"}})});return await r.json()}async executeExport(e,t){let r=await fetch("/api/export/mp4",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,exportConfig:t||{format:"mp4",quality:"1080p",compression:"medium",includeSubtitles:!1}})});return await r.json()}constructor(){this.workflows=new Map}}let d=new p;async function u(e){try{let t=await (0,a.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("projectId");if(!s)return o.NextResponse.json({error:"Project ID required"},{status:400});let n=d.getWorkflow(s);if(!n)return o.NextResponse.json({error:"Workflow not found"},{status:404});return o.NextResponse.json({workflow:n})}catch(e){return console.error("Unified API GET Error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){try{let t=await (0,a.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),s=n.parse(r),i=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.create({data:{name:s.name,type:s.type,status:"DRAFT",userId:t.user.id,description:"",organizationId:"",originalFileName:"",fileSize:0,filePath:"",thumbnailUrl:"",duration:0,views:0,likes:0,shares:0,comments:0,downloads:0,isPublic:!1,isTemplate:!1,templateCategory:"",tags:[],customFields:{},version:"1.0",lastEditedBy:t.user.id,collaborators:[],permissions:{},exportFormats:[],renderSettings:{},aiSettings:{},complianceData:{},analyticsData:{}}}),p=await d.createWorkflow(i.id,t.user.id);return s.source.data&&await d.executeStep(i.id,"import",s.source.data),o.NextResponse.json({project:i,workflow:p,message:"Project created and workflow initialized"})}catch(e){return console.error("Unified API POST Error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e){try{let t;let r=await (0,a.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!r?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let s=await e.json(),n=i.parse(s);if(!await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:n.id,userId:r.user.id}}))return o.NextResponse.json({error:"Project not found"},{status:404});switch(n.action){case"edit":t=await d.executeStep(n.id,"edit",n.data);break;case"render":let p=n.data;await d.executeStep(n.id,"avatar",p?.avatar),await d.executeStep(n.id,"tts",p?.tts),t=await d.executeStep(n.id,"render",p?.render);break;case"export":t=await d.executeStep(n.id,"export",n.data);break;case"delete":return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.delete({where:{id:n.id}}),o.NextResponse.json({message:"Project deleted"});default:return o.NextResponse.json({error:"Invalid action"},{status:400})}let u=d.getWorkflow(n.id);return o.NextResponse.json({result:t,workflow:u,message:`Action ${n.action} completed`})}catch(e){return console.error("Unified API PUT Error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=await (0,a.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}()));if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("projectId");if(!s)return o.NextResponse.json({error:"Project ID required"},{status:400});if(!await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.findFirst({where:{id:s,userId:t.user.id}}))return o.NextResponse.json({error:"Project not found"},{status:404});return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.delete({where:{id:s}}),o.NextResponse.json({message:"Project and workflow deleted"})}catch(e){return console.error("Unified API DELETE Error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,5715,1585],()=>r(377296));module.exports=o})();