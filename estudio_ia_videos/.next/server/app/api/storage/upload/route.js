"use strict";(()=>{var e={};e.id=2513,e.ids=[2513],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},5334:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>y,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>m,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>f,POST:()=>g});var a=r(49303),o=r(88716),n=r(60670),i=r(87070),u=r(737),d=r(71487),c=r(62619),l=r(75571);let p="videos",g=(0,c.er)(c.fp.UPLOAD,"user")(async function(e){try{let t=await (0,l.getServerSession)();if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.formData(),s=r.get("file"),a=r.get("folder")||"uploads",o=r.get("bucket")||p;if(!s)return i.NextResponse.json({error:"No file provided"},{status:400});let n=Date.now(),c=s.name.replace(/[^a-zA-Z0-9.-]/g,"_"),g=`users/${t.user.id}/${a}/${n}_${c}`,f=Buffer.from(await s.arrayBuffer()),h=await u.c.upload({bucket:o,path:g,file:f,contentType:s.type||"application/octet-stream"}),{ip:w,userAgent:x}=(0,d.h9)(e);return await d.Ps.logUserAction(t.user.id,d.V6.FILE_UPLOAD,`${o}/${g}`,{fileName:s.name,size:s.size,ip:w,userAgent:x}),i.NextResponse.json({url:h,path:g,bucket:o,fileName:s.name,size:s.size})}catch(e){return i.NextResponse.json({error:e instanceof Error?e.message:String(e)},{status:500})}});async function f(e){try{let t=await (0,l.getServerSession)();if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("bucket")||p,a=await u.c.listUserFiles(t.user.id,s);return i.NextResponse.json({files:a})}catch(e){return i.NextResponse.json({error:e instanceof Error?e.message:String(e)},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/storage/upload/route",pathname:"/api/storage/upload",filename:"route",bundlePath:"app/api/storage/upload/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\storage\\upload\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:x,serverHooks:m}=h,q="/api/storage/upload/route";function y(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:x})}},71487:(e,t,r)=>{r.d(t,{Ps:()=>n,V6:()=>s,h9:()=>i});var s,a=r(61657);class o{constructor(){let e="https://ofhzrdiadxigrvmrhaiz.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;e&&t||console.warn("⚠️ Supabase credentials not found in AuditLoggingService"),this.supabase=(0,a.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}async log(e){try{let{error:t}=await this.supabase.from("analytics_events").insert({user_id:e.userId,event_type:`audit.${e.action}`,event_data:{resource:e.resource,...e.metadata},created_at:new Date().toISOString()});t&&console.error("Failed to write audit log:",t)}catch(e){console.error("Error in audit logger:",e)}}async query(e){try{let t=this.supabase.from("analytics_events").select("*").ilike("event_type","audit.%").order("created_at",{ascending:!1});e.userId&&(t=t.eq("user_id",e.userId)),e.action&&(t=t.eq("event_type",`audit.${e.action}`));let{data:r,error:s}=await t.limit(100);if(s)throw s;return(r||[]).map(e=>({id:e.id,userId:e.user_id,action:e.event_type.replace("audit.",""),resource:e.event_data?.resource||"unknown",timestamp:new Date(e.created_at),metadata:e.event_data}))}catch(e){return console.error("Failed to query audit logs:",e),[]}}async getUserActivity(e,t=50){return this.query({userId:e})}async logUserAction(e,t,r,s){return this.log({userId:e,action:t,resource:r,metadata:s})}}let n=new o;function i(e){return{ip:e.headers.get("x-forwarded-for")||"unknown",userAgent:e.headers.get("user-agent")||"unknown"}}!function(e){e.CREATE="create",e.UPDATE="update",e.DELETE="delete",e.READ="read",e.LOGIN="login",e.LOGOUT="logout",e.UPLOAD="upload",e.DOWNLOAD="download",e.FILE_UPLOAD="file_upload",e.FILE_DOWNLOAD="file_download",e.FILE_DELETE="file_delete"}(s||(s={}))},62619:(e,t,r)=>{r.d(t,{er:()=>n,fp:()=>o});var s=r(87070);class a{constructor(e){this.config=e,this.requests=new Map}async check(e){let t=Date.now(),r=t-this.config.windowMs,s=this.requests.get(e)||[],a=(s=s.filter(e=>e>r)).length<this.config.maxRequests;return a&&(s.push(t),this.requests.set(e,s)),{allowed:a,remaining:Math.max(0,this.config.maxRequests-s.length),resetAt:new Date(t+this.config.windowMs)}}async reset(e){this.requests.delete(e)}async clearExpired(){let e=Date.now()-this.config.windowMs;for(let[t,r]of this.requests.entries()){let s=r.filter(t=>t>e);0===s.length?this.requests.delete(t):this.requests.set(t,s)}}}new a({windowMs:6e4,maxRequests:100});let o={DEFAULT:{windowMs:6e4,maxRequests:100},API:{windowMs:6e4,maxRequests:60},AUTH_API:{windowMs:6e4,maxRequests:60},AUTH_STRICT:{windowMs:6e4,maxRequests:30},UPLOAD:{windowMs:6e4,maxRequests:10}};function n(e,t="ip"){return function(r){return async(o,n)=>{let i="global";"ip"===t&&(i=o.headers.get("x-forwarded-for")||o.headers.get("x-real-ip")||"unknown");let u=new a(e),d=await u.check(i);return d.allowed?r(o,n):s.NextResponse.json({error:"Too many requests",resetAt:d.resetAt},{status:429})}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1657,5571,1175],()=>r(5334));module.exports=s})();