"use strict";(()=>{var e={};e.id=2518,e.ids=[2518],e.modules={220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},592048:e=>{e.exports=require("fs")},555315:e=>{e.exports=require("path")},204829:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>_,requestAsyncStorage:()=>k,routeModule:()=>x,serverHooks:()=>y,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{POST:()=>g});var i=r(349303),a=r(88716),o=r(60670),n=r(387070),l=r(592048),u=r(555315),p=r.n(u);let d=p().join(process.cwd(),"uploads","temp"),c=p().join(process.cwd(),"uploads","metadata"),m=p().join(process.cwd(),"uploads","files");async function h(){try{await l.promises.mkdir(d,{recursive:!0}),await l.promises.mkdir(c,{recursive:!0}),await l.promises.mkdir(m,{recursive:!0})}catch(e){console.error("Error creating directories:",e)}}async function f(e,t){let r=p().join(m,`${e}_assembled`),s=await l.promises.open(r,"w");try{for(let r=0;r<t;r++){let t=p().join(d,`${e}_chunk_${r}`);try{let e=await l.promises.readFile(t);await s.write(e,0,e.length,null)}catch(t){throw Error(`Missing chunk ${r} for upload ${e}`)}}}finally{await s.close()}return r}async function w(e,t){let r=[];for(let s=0;s<t;s++){let t=p().join(d,`${e}_chunk_${s}`);r.push(l.promises.unlink(t).catch(()=>{}))}let s=p().join(c,`${e}.json`);r.push(l.promises.unlink(s).catch(()=>{})),await Promise.all(r)}async function j(e,t){return t.startsWith("image/")||t.startsWith("video/"),null}async function g(e){await h();try{let t;let{uploadId:r,filename:s,mimeType:i,totalSize:a,chunks:o}=await e.json();if(!r||!s||!i||!a||!o)return n.NextResponse.json({error:"Missing required fields"},{status:400});let u=p().join(c,`${r}.json`);try{let e=await l.promises.readFile(u,"utf-8");t=JSON.parse(e)}catch{return n.NextResponse.json({error:"Upload session not found"},{status:404})}if(t.uploadedChunks.length!==o)return n.NextResponse.json({error:"Upload incomplete",uploadedChunks:t.uploadedChunks.length,expectedChunks:o},{status:400});let d=await f(r,o),h=await l.promises.stat(d);if(h.size!==a)return await l.promises.unlink(d),n.NextResponse.json({error:"File size mismatch after assembly"},{status:400});let g=`${r}_${s}`,x=p().join(m,g);await l.promises.rename(d,x);let k=await j(x,i);await w(r,o);let v={id:r,filename:s,size:h.size,mimeType:i,url:`/api/files/${g}`,thumbnailUrl:k,metadata:{originalFilename:s,uploadedChunks:o,assembledAt:new Date().toISOString(),contentLength:h.size},uploadedAt:new Date().toISOString()};return console.log(`Upload completed: ${r} - ${s} (${h.size} bytes)`),n.NextResponse.json(v)}catch(e){return console.error("Upload finalization error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let x=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/upload/finalize/route",pathname:"/api/upload/finalize",filename:"route",bundlePath:"app/api/upload/finalize/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\upload\\finalize\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:k,staticGenerationAsyncStorage:v,serverHooks:y}=x,$="/api/upload/finalize/route";function _(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>r(204829));module.exports=s})();