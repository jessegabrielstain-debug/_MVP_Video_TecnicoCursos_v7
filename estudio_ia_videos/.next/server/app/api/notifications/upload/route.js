"use strict";(()=>{var e={};e.id=3897,e.ids=[3897],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},36505:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var a={};o.r(a),o.d(a,{POST:()=>p});var r=o(49303),s=o(88716),i=o(60670),n=o(17549);class d{broadcast(e){console.log("[WebSocket] Broadcasting:",e.type)}sendToUser(e,t){console.log(`[WebSocket] Sending to user ${e}:`,t.type)}sendNotificationToUser(e,t){this.sendToUser(e,{type:"notification",data:t,timestamp:new Date})}sendNotificationToRoom(e,t){console.log(`[WebSocket] Sending to room ${e}:`,t)}getConnectionCount(){return this.connections.size}constructor(){this.connections=new Set}}let c=new d;async function p(e){try{let{uploadId:t,userId:o,roomId:a,filename:r,progress:s,total:i,speed:d,eta:p,phase:l,error:u}=await e.json(),m=i>0?s/i*100:0;switch(l){case"preparing":{let e={id:`upload_${t}_preparing`,type:"upload_progress",title:"Preparando Upload",message:`Preparando upload do arquivo ${r}`,priority:"medium",timestamp:Date.now(),userId:o,roomId:a,data:{uploadId:t,filename:r,progress:0,total:i,percentage:0,phase:"preparing"}};a?(n.O.broadcastToRoom(a,e),c?.sendNotificationToRoom(a,e)):(n.O.sendToUser(o,e),c?.sendNotificationToUser(o,e))}break;case"uploading":{let e={id:`upload_${t}_progress`,type:"upload_progress",title:"Upload em Andamento",message:`Enviando ${r} - ${m.toFixed(1)}%`,priority:"medium",timestamp:Date.now(),userId:o,roomId:a,data:{uploadId:t,filename:r,progress:s,total:i,percentage:m,speed:d,eta:p,phase:"uploading"}};a?(n.O.broadcastToRoom(a,e),c?.sendNotificationToRoom(a,e)):(n.O.sendToUser(o,e),c?.sendNotificationToUser(o,e))}break;case"processing":{let e={id:`upload_${t}_processing`,type:"video_processing",title:"Processando Arquivo",message:`Processando ${r}...`,priority:"medium",timestamp:Date.now(),userId:o,roomId:a,data:{uploadId:t,filename:r,progress:s,total:i,percentage:m,phase:"processing"}};a?(n.O.broadcastToRoom(a,e),c?.sendNotificationToRoom(a,e)):(n.O.sendToUser(o,e),c?.sendNotificationToUser(o,e))}break;case"complete":{let e={id:`upload_${t}_complete`,type:"upload_complete",title:"Upload Conclu\xeddo",message:`${r} foi enviado com sucesso!`,priority:"low",timestamp:Date.now(),userId:o,roomId:a,persistent:!0,data:{uploadId:t,filename:r,progress:i,total:i,percentage:100,phase:"complete"}};a?(n.O.broadcastToRoom(a,e),c?.sendNotificationToRoom(a,e)):(n.O.sendToUser(o,e),c?.sendNotificationToUser(o,e))}break;case"error":{let e={id:`upload_${t}_error`,type:"upload_error",title:"Erro no Upload",message:`Falha ao enviar ${r}: ${u||"Erro desconhecido"}`,priority:"high",timestamp:Date.now(),userId:o,roomId:a,persistent:!0,data:{uploadId:t,filename:r,error:u||"Erro desconhecido",phase:"error"}};a?(n.O.broadcastToRoom(a,e),c?.sendNotificationToRoom(a,e)):(n.O.sendToUser(o,e),c?.sendNotificationToUser(o,e))}break;default:return Response.json({success:!1,error:"Invalid phase"},{status:400})}return Response.json({success:!0,message:"Notification sent",phase:l,percentage:m.toFixed(1)})}catch(e){return console.error("Error sending upload notification:",e),Response.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/notifications/upload/route",pathname:"/api/notifications/upload",filename:"route",bundlePath:"app/api/notifications/upload/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\notifications\\upload\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:g}=l,_="/api/notifications/upload/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},17549:(e,t,o)=>{o.d(t,{O:()=>s,f:()=>r});var a=o(61657);class r{constructor(){this.rooms=new Map;let e="https://ofhzrdiadxigrvmrhaiz.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;e&&t||console.warn("⚠️ Supabase credentials not found in NotificationManager"),this.supabase=(0,a.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}static getInstance(){return r.instance||(r.instance=new r),r.instance}getRoom(e){return this.rooms.get(e)}createRoom(e,t){let o={id:e,name:t,members:new Set,createdAt:new Date};return this.rooms.set(e,o),o}joinRoom(e,t){let o=this.rooms.get(e);return!!o&&(o.members.add(t),!0)}leaveRoom(e,t){let o=this.rooms.get(e);return!!o&&o.members.delete(t)}async create(e){e.userId,e.type,e.title,e.message,e.actionUrl,e.expiresAt?.toISOString(),new Date().toISOString();let{data:t,error:o}=await this.supabase.from("analytics_events").insert({user_id:e.userId,event_type:"notification",event_data:{type:e.type,title:e.title,message:e.message,read:!1,actionUrl:e.actionUrl,expiresAt:e.expiresAt},created_at:new Date().toISOString()}).select().single();if(o)throw console.error("Failed to create notification:",o),o;return{id:t.id,userId:t.user_id,type:t.event_data.type,title:t.event_data.title,message:t.event_data.message,read:t.event_data.read,createdAt:new Date(t.created_at),expiresAt:t.event_data.expiresAt?new Date(t.event_data.expiresAt):void 0,actionUrl:t.event_data.actionUrl}}async getForUser(e,t=!1){let o=this.supabase.from("analytics_events").select("*").eq("user_id",e).eq("event_type","notification").order("created_at",{ascending:!1}),{data:a,error:r}=await o.limit(50);if(r)return[];let s=a.map(e=>({id:e.id,userId:e.user_id,type:e.event_data.type,title:e.event_data.title,message:e.event_data.message,read:e.event_data.read,createdAt:new Date(e.created_at),expiresAt:e.event_data.expiresAt?new Date(e.event_data.expiresAt):void 0,actionUrl:e.event_data.actionUrl}));return t&&(s=s.filter(e=>!e.read)),s}async markAsRead(e){let{data:t}=await this.supabase.from("analytics_events").select("event_data").eq("id",e).single();if(!t)return!1;let o={...t.event_data,read:!0},{error:a}=await this.supabase.from("analytics_events").update({event_data:o}).eq("id",e);return!a}async delete(e){let{error:t}=await this.supabase.from("analytics_events").delete().eq("id",e);return!t}async deleteAllForUser(e){let{count:t,error:o}=await this.supabase.from("analytics_events").delete({count:"exact"}).eq("user_id",e).eq("event_type","notification");return o?0:t||0}async sendToUser(e,t){try{let o=t.data;await this.create({userId:e,type:"error"===t.type||"upload_error"===t.type?"error":"info",title:t.title,message:t.message,actionUrl:o?.uploadId?`/upload/${o.uploadId}`:void 0})}catch(e){console.error("Error sending notification to user:",e)}}async broadcastToRoom(e,t){console.log(`[NotificationManager] Broadcasting to room ${e}:`,t.title)}async sendNotification(e){if(!1!==e.persistent&&e.userId)try{await this.create({userId:e.userId,type:"error"===e.type||"upload_error"===e.type?"error":"info",title:e.title,message:e.message,actionUrl:e.data?.uploadId?`/upload/${e.data.uploadId}`:void 0})}catch(e){console.error("Error persisting notification:",e)}e.roomId&&await this.broadcastToRoom(e.roomId,e),e.userId&&!e.roomId&&console.log(`[NotificationManager] Sending to user ${e.userId}:`,e.title)}}let s=new r},49303:(e,t,o)=>{e.exports=o(30517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),a=t.X(0,[8948,1657],()=>o(36505));module.exports=a})();