"use strict";(()=>{var e={};e.id=5422,e.ids=[5422],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},61573:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>U,patchFetch:()=>q,requestAsyncStorage:()=>S,routeModule:()=>w,serverHooks:()=>_,staticGenerationAsyncStorage:()=>E});var o={};t.r(o),t.d(o,{GET:()=>x,POST:()=>k});var a=t(49303),i=t(88716),s=t(60670),n=t(87070),u=t(8803);let l=process.env.DID_API_KEY,c="https://api.d-id.com";class p{constructor(){if(!l)throw Error("DID_API_KEY n\xe3o est\xe1 configurada");this.apiKey=l}async createTalk(e){try{u.kg.info("DIDService","Criando avatar D-ID",{sourceUrl:e.sourceUrl});let r=await fetch(`${c}/talks`,{method:"POST",headers:{Authorization:`Basic ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({source_url:e.sourceUrl,script:{type:"audio",audio_url:e.audioUrl},driver_url:e.driver||"bank://lively",config:{stitch:e.config?.stitch??!0,fluent:e.config?.fluent??!0}})});if(!r.ok){let e=await r.json();throw Error(`D-ID API error: ${e.message||r.statusText}`)}let t=await r.json();return u.kg.info("DIDService","Avatar D-ID criado com sucesso",{talkId:t.id}),await this.waitForCompletion(t.id)}catch(e){throw u.kg.error("DIDService","Erro ao criar avatar D-ID",e),e}}async waitForCompletion(e,r=60){for(let t=0;t<r;t++){let r=await this.getTalkStatus(e);if("done"===r.status&&r.result_url)return u.kg.info("DIDService","Avatar D-ID processado com sucesso",{talkId:e}),r.result_url;if("error"===r.status)throw Error(`D-ID processing failed: ${r.error}`);await new Promise(e=>setTimeout(e,5e3))}throw Error("D-ID processing timeout")}async getTalkStatus(e){let r=await fetch(`${c}/talks/${e}`,{headers:{Authorization:`Basic ${this.apiKey}`}});if(!r.ok)throw Error(`Failed to get talk status: ${r.statusText}`);return r.json()}async deleteTalk(e){await fetch(`${c}/talks/${e}`,{method:"DELETE",headers:{Authorization:`Basic ${this.apiKey}`}}),u.kg.info("DIDService","Avatar D-ID deletado",{talkId:e})}}let d=new p;var g=t(68582),f=t(61657),h=t(16428);let v="https://ofhzrdiadxigrvmrhaiz.supabase.co",y=process.env.SUPABASE_SERVICE_ROLE_KEY,m=v&&y?(0,f.eI)(v,y):null;async function I(e){if(!m)throw Error("Supabase n\xe3o est\xe1 configurado.");try{u.kg.info("LipSyncIntegration","Iniciando gera\xe7\xe3o de v\xeddeo com lip sync.",{options:e}),u.kg.info("LipSyncIntegration","Gerando \xe1udio TTS...");let r=await (0,g.T9)(e.text,e.voiceId,e.modelId),t=e.outputFileName?`${e.outputFileName}-audio.mp3`:`lip-sync-${Date.now()}-audio.mp3`,o=`audio/lip-sync/${t}`;u.kg.info("LipSyncIntegration","Fazendo upload de \xe1udio para Storage...",{audioPath:o});let{data:a,error:i}=await m.storage.from("assets").upload(o,r,{contentType:"audio/mpeg",upsert:!0});if(i)throw u.kg.error("LipSyncIntegration","Falha ao fazer upload de \xe1udio.",i),i;let{data:s}=m.storage.from("assets").getPublicUrl(o),n=s.publicUrl;u.kg.info("LipSyncIntegration","\xc1udio enviado com sucesso.",{audioUrl:n}),u.kg.info("LipSyncIntegration","Criando talking head com D-ID...");let l=await d.createTalk({sourceUrl:e.avatarImageUrl,audioUrl:n,driver:"bank://lively",config:{stitch:!0,fluent:!0}});u.kg.info("LipSyncIntegration","V\xeddeo processado com sucesso pelo D-ID.",{videoUrl:l});let c=await fetch(l);if(!c.ok)throw Error(`Falha ao baixar v\xeddeo do D-ID: ${c.status}`);let p=Buffer.from(await c.arrayBuffer()),f=e.outputFileName?`${e.outputFileName}.mp4`:`lip-sync-${Date.now()}.mp4`,v=`videos/lip-sync/${f}`;u.kg.info("LipSyncIntegration","Fazendo upload de v\xeddeo para Storage...",{videoPath:v});let{data:y,error:I}=await m.storage.from("videos").upload(v,p,{contentType:"video/mp4",upsert:!0});if(I)throw u.kg.error("LipSyncIntegration","Falha ao fazer upload de v\xeddeo.",I),I;let{data:D}=m.storage.from("videos").getPublicUrl(v),k=D.publicUrl;return u.kg.info("LipSyncIntegration","V\xeddeo com lip sync finalizado.",{finalVideoUrl:k}),await (0,h.t)("lip_sync_generated",null,{provider:"d-id",details:{videoUrl:k,audioUrl:n}}),{videoUrl:k,audioUrl:n,duration:0,status:"completed",talkId:"unknown"}}catch(r){return u.kg.error("LipSyncIntegration","Falha ao gerar v\xeddeo com lip sync.",r,{options:e}),{videoUrl:"",audioUrl:"",duration:0,status:"failed"}}}async function D(){let e=[];return m||e.push("Supabase n\xe3o est\xe1 configurado."),process.env.ELEVENLABS_API_KEY||e.push("ElevenLabs API key n\xe3o est\xe1 configurada."),process.env.DID_API_KEY||e.push("D-ID API key n\xe3o est\xe1 configurada."),{valid:0===e.length,errors:e}}async function k(e){try{let r=await D();if(!r.valid)return n.NextResponse.json({error:"Recursos n\xe3o configurados",details:r.errors},{status:500});let{text:t,avatarImageUrl:o,voiceId:a,modelId:i,videoQuality:s,outputFileName:u}=await e.json();if(!t||!o)return n.NextResponse.json({error:"Campos obrigat\xf3rios: text, avatarImageUrl"},{status:400});let l=await I({text:t,avatarImageUrl:o,voiceId:a,modelId:i,videoQuality:s,outputFileName:u});if("failed"===l.status)return n.NextResponse.json({error:"Falha ao gerar v\xeddeo com lip sync"},{status:500});return n.NextResponse.json(l)}catch(e){return console.error("Erro ao gerar lip sync:",e),n.NextResponse.json({error:"Erro ao processar requisi\xe7\xe3o"},{status:500})}}async function x(e){try{let e=await D();return n.NextResponse.json(e)}catch(e){return console.error("Erro ao validar recursos:",e),n.NextResponse.json({error:"Erro ao validar recursos"},{status:500})}}let w=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/lip-sync/route",pathname:"/api/lip-sync",filename:"route",bundlePath:"app/api/lip-sync/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\lip-sync\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:S,staticGenerationAsyncStorage:E,serverHooks:_}=w,U="/api/lip-sync/route";function q(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:E})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[8948,5972,1657,6394,8582],()=>t(61573));module.exports=o})();