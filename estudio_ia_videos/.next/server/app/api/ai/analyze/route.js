"use strict";(()=>{var e={};e.id=6233,e.ids=[6233],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},55315:e=>{e.exports=require("path")},21764:e=>{e.exports=require("util")},54624:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>P,patchFetch:()=>j,requestAsyncStorage:()=>x,routeModule:()=>F,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var r={};s.r(r),s.d(r,{GET:()=>y,POST:()=>w});var a=s(49303),o=s(88716),i=s(60670),n=s(87070),p=s(61282),u=s(21764),c=s(92048),d=s(55315),l=s.n(d);(0,u.promisify)(p.exec);class m{constructor(e="ffmpeg"){this.ffmpegPath=e,this.isWindows="win32"===process.platform}async renderFromFrames(e,t){let s=Date.now();try{if(!e.inputFramesDir)throw Error("inputFramesDir \xe9 obrigat\xf3rio");await this.validateInputs(e);let r=await this.buildFFmpegCommand(e);console.log("\uD83C\uDFAC Executando FFmpeg:",this.ffmpegPath,r.join(" "));let a=await this.executeFFmpeg(r,e,t),o=await c.promises.stat(e.outputPath),i=(Date.now()-s)/1e3;return{success:!0,outputPath:e.outputPath,duration:i,fileSize:o.size,stats:a.stats}}catch(t){return console.error("âŒ Erro ao renderizar v\xeddeo:",t),{success:!1,outputPath:e.outputPath,duration:(Date.now()-s)/1e3,fileSize:0,error:t instanceof Error?t.message:"Erro desconhecido"}}}async buildFFmpegCommand(e){let t=[],s=e.inputFramesPattern||"frame_%04d.png",r=l().join(e.inputFramesDir,s);t.push("-framerate",String(e.fps||30)),t.push("-i",r),e.audioPath&&await c.promises.access(e.audioPath).then(()=>!0).catch(()=>!1)&&(t.push("-i",e.audioPath),t.push("-c:a","aac"),t.push("-b:a",e.audioBitrate||"192k"),t.push("-ar",String(e.audioSampleRate||48e3)));let a=e.codec||"h264";switch(a){case"h264":t.push("-c:v","libx264");break;case"h265":t.push("-c:v","libx265");break;case"vp8":t.push("-c:v","libvpx");break;case"vp9":t.push("-c:v","libvpx-vp9");break;default:throw Error(`Codec n\xe3o suportado: ${a}`)}let o=e.preset||"medium";t.push("-preset",o);let i={low:"28",medium:"23",high:"18",ultra:"15"}[e.quality||"medium"];if(t.push("-crf",i),t.push("-pix_fmt","yuv420p"),e.width&&e.height&&t.push("-s",`${e.width}x${e.height}`),e.bitrate&&t.push("-b:v",e.bitrate),e.metadata)for(let[s,r]of Object.entries(e.metadata))t.push("-metadata",`${s}=${r}`);return t.push("-movflags","+faststart"),t.push("-threads","0"),t.push("-y"),t.push(e.outputPath),t}executeFFmpeg(e,t,s){return new Promise((r,a)=>{let o=(0,p.spawn)(this.ffmpegPath,e),i="",n=0,u=0;t.inputFramesDir&&this.countFrames(t.inputFramesDir).then(e=>{n=e}),o.stderr.on("data",e=>{let t=e.toString();i+=t;let r=t.match(/frame=\s*(\d+)/),a=t.match(/fps=\s*([\d.]+)/),o=t.match(/time=(\d+):(\d+):([\d.]+)/),p=t.match(/speed=\s*([\d.]+)x/),c=t.match(/bitrate=\s*([\d.]+\s*\w+)/),d=t.match(/size=\s*([\d.]+\s*\w+)/);if(r){let e={frame:u=parseInt(r[1]),fps:a?parseFloat(a[1]):0,totalFrames:n||2*u,timeSeconds:0,progress:n?Math.min(u/n*100,100):0,speed:p?parseFloat(p[1]):1,bitrate:c?c[1]:"0kbits/s",size:d?d[1]:"0kB"};if(o){let t=parseInt(o[1]),s=parseInt(o[2]),r=parseFloat(o[3]);e.timeSeconds=3600*t+60*s+r}s&&s(e),u%10==0&&console.log(`ðŸ“¹ Frame ${u}/${n} (${e.progress.toFixed(1)}%) - ${e.fps.toFixed(1)} fps`)}}),o.on("close",e=>{0===e?(console.log("âœ… FFmpeg conclu\xeddo com sucesso"),r({stats:{totalFrames:u,averageFps:t.fps||30,totalTime:u/(t.fps||30)}})):(console.error("âŒ FFmpeg falhou com c\xf3digo:",e),console.error("Stderr:",i),a(Error(`FFmpeg falhou com c\xf3digo ${e}`)))}),o.on("error",e=>{console.error("âŒ Erro ao executar FFmpeg:",e),a(e)})})}async validateInputs(e){if(e.inputFramesDir){try{await c.promises.access(e.inputFramesDir)}catch{throw Error(`Diret\xf3rio de frames n\xe3o existe: ${e.inputFramesDir}`)}if(0===(await c.promises.readdir(e.inputFramesDir)).filter(e=>/\.(png|jpg|jpeg)$/i.test(e)).length)throw Error(`Nenhum frame encontrado em: ${e.inputFramesDir}`)}let t=l().dirname(e.outputPath);try{await c.promises.access(t)}catch{await c.promises.mkdir(t,{recursive:!0})}}async countFrames(e){try{return(await c.promises.readdir(e)).filter(e=>/\.(png|jpg|jpeg)$/i.test(e)).length}catch{return 0}}static async checkInstallation(e="ffmpeg"){return new Promise(t=>{let s=(0,p.spawn)(e,["-version"]);s.on("close",e=>{t(0===e)}),s.on("error",()=>{t(!1)})})}static async getVersion(e="ffmpeg"){return new Promise(t=>{let s=(0,p.spawn)(e,["-version"]),r="";s.stdout.on("data",e=>{r+=e.toString()}),s.on("close",e=>{if(0===e){let e=r.match(/ffmpeg version ([^\s]+)/);t(e?e[1]:null)}else t(null)}),s.on("error",()=>{t(null)})})}}var h=s(20629),g=s.n(h);class f{constructor(){this.jobs=new Map,this.ffmpeg=new m}static getInstance(){return f.instance||(f.instance=new f),f.instance}async analyzeVideo(e,t,s){let r=crypto.randomUUID(),a={id:r,videoId:e,status:"pending",progress:0,createdAt:new Date};return this.jobs.set(r,a),this.processJob(a,t),a}async processJob(e,t){e.status="processing",e.progress=10;try{let s=await this.analyze(t);e.results=s,e.status="completed",e.progress=100,e.completedAt=new Date}catch(t){e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date}}getAnalysis(e){return this.jobs.get(e)}async analyze(e){try{await g().access(e);let t=(await g().stat(e)).size/1048576,s="medium";return t<5&&(s="low"),t>50&&(s="high"),{duration:0,scenes:1,quality:s,issues:t<1?["File too small, might be corrupted"]:[],metadata:{width:1920,height:1080,fps:30,bitrate:0,codec:"h264"}}}catch(e){return console.error("Error analyzing video:",e),{duration:0,scenes:0,quality:"low",issues:["File not found or unreadable"],metadata:{width:0,height:0,fps:0,bitrate:0,codec:""}}}}}async function w(e){try{let{videoId:t,videoPath:s,config:r}=await e.json();if(!t||!s)return n.NextResponse.json({error:"Missing required fields: videoId, videoPath"},{status:400});let a=f.getInstance(),o=await a.analyzeVideo(t,s,r);return n.NextResponse.json({success:!0,analysis:{id:o.id,videoId:o.videoId,status:o.status,progress:o.progress,createdAt:o.createdAt}})}catch(e){return console.error("AI analysis error:",e),n.NextResponse.json({error:e instanceof Error?e.message:"Analysis failed"},{status:500})}}async function y(e){try{let t=e.nextUrl.searchParams.get("analysisId");if(!t)return n.NextResponse.json({error:"Missing analysisId parameter"},{status:400});let s=f.getInstance().getAnalysis(t);if(!s)return n.NextResponse.json({error:"Analysis not found"},{status:404});return n.NextResponse.json({success:!0,analysis:{id:s.id,videoId:s.videoId,status:s.status,progress:s.progress,results:s.results,error:s.error,createdAt:s.createdAt,completedAt:s.completedAt}})}catch(e){return console.error("Get analysis error:",e),n.NextResponse.json({error:e instanceof Error?e.message:"Failed to get analysis"},{status:500})}}f.getInstance();let F=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ai/analyze/route",pathname:"/api/ai/analyze",filename:"route",bundlePath:"app/api/ai/analyze/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\ai\\analyze\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:b}=F,P="/api/ai/analyze/route";function j(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>s(54624));module.exports=r})();