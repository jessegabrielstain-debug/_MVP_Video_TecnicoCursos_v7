"use strict";(()=>{var e={};e.id=5764,e.ids=[5764],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},31725:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>R,staticGenerationAsyncStorage:()=>A});var r={};a.r(r),a.d(r,{DELETE:()=>b,GET:()=>f,POST:()=>_});var s=a(49303),o=a(88716),n=a(60670),i=a(87070),l=a(99963),d=a(6251),c=a(42126),u=a(20629),p=a(55315),m=a.n(p);let g=(0,l.H2)(l.wS.render);async function _(e){return g(e,async e=>{try{let t,a;let r=await e.formData(),s=r.get("avatarId"),o=r.get("animation"),n=r.get("text"),l=r.get("audioFile"),p=r.get("resolution")||"4K",g=r.get("quality")||"hyperreal",_=r.get("language")||"pt-BR",y="true"===r.get("rayTracing"),f="true"===r.get("realTimeLipSync"),v="false"!==r.get("audio2FaceEnabled"),b="true"===r.get("voiceCloning");if(console.log("\uD83C\uDFAC API v2: Iniciando renderiza\xe7\xe3o hiper-realista..."),console.log(`ðŸŽ­ Avatar: ${s}`),console.log(`ðŸŽª Anima\xe7\xe3o: ${o}`),console.log(`ðŸ“ Resolu\xe7\xe3o: ${p}`),console.log(`âœ¨ Qualidade: ${g}`),console.log(`ðŸ—£ï¸ Audio2Face: ${v?"Ativado":"Desativado"}`),!s||!o)return i.NextResponse.json({success:!1,error:{message:"Avatar ID e anima\xe7\xe3o s\xe3o obrigat\xf3rios",code:"MISSING_REQUIRED_FIELDS"}},{status:400});let{data:w,error:h}=await c._m.from("avatar_models").select("*").eq("id",s).eq("is_active",!0).single();if(h||!w)return i.NextResponse.json({success:!1,error:{message:"Avatar n\xe3o encontrado",code:"AVATAR_NOT_FOUND"}},{status:404});if(l&&l.size>0){let e=await l.arrayBuffer(),a=`audio_${Date.now()}_${Math.random().toString(36).substr(2,9)}.wav`,r=m().join(process.cwd(),"temp");t=m().join(r,a);try{await (0,u.mkdir)(r,{recursive:!0}),await (0,u.writeFile)(t,Buffer.from(e)),console.log(`ðŸŽµ Arquivo de \xe1udio salvo: ${t}`)}catch(e){return console.error("Erro ao salvar arquivo de \xe1udio:",e),i.NextResponse.json({success:!1,error:{message:"Erro ao processar arquivo de \xe1udio",code:"AUDIO_PROCESSING_ERROR"}},{status:500})}}b&&(a="default-voice-profile");let A=await d.N.renderHyperRealisticAvatar("user-temp",n||"",a,{avatarId:s,animation:o,audioFilePath:t,resolution:p,quality:g,rayTracing:y,realTimeLipSync:f,audio2FaceEnabled:v,voiceCloning:b,language:_});console.log(`âœ… Renderiza\xe7\xe3o iniciada - Job ID: ${A.jobId}`);let R={success:!0,data:{jobId:A.jobId,status:A.status,avatar:{id:w.id,name:w.name,displayName:w.display_name,category:w.category,audio2FaceCompatible:w.audio2face_compatible},render:{animation:o,resolution:p,quality:g,rayTracing:y,audio2FaceEnabled:v,realTimeLipSync:f,voiceCloning:b,language:_,estimatedTime:A.estimatedTime||"30-60s",progress:A.progress||0},output:{videoUrl:A.outputVideo,thumbnailUrl:A.outputThumbnail,statusUrl:`/api/v2/avatars/render/status/${A.jobId}`,downloadUrl:A.outputVideo?`/api/v2/avatars/render/download/${A.jobId}`:null},quality:{renderingEngine:"Unreal Engine 5.3",lipSyncAccuracy:A.lipSyncAccuracy||0,audio2FaceEnabled:A.audio2FaceEnabled||!1,rayTracingEnabled:y},metadata:{startTime:A.startTime?new Date(A.startTime).toISOString():new Date().toISOString(),version:"2.0.0",userId:"user-temp",audioFile:l?l.name:null,textLength:n?.length||0}}};return i.NextResponse.json(R)}catch(e){return console.error("âŒ Erro na renderiza\xe7\xe3o:",e),i.NextResponse.json({success:!1,error:{message:"Erro ao iniciar renderiza\xe7\xe3o",details:e instanceof Error?e.message:"Erro desconhecido",code:"RENDER_ERROR"}},{status:500})}})}let y=(0,l.H2)(l.wS.authenticated);async function f(e){return y(e,async e=>{try{let{searchParams:t}=new URL(e.url),a=t.get("status"),r=t.get("userId"),s=parseInt(t.get("limit")||"10"),o=parseInt(t.get("offset")||"0");console.log("\uD83D\uDCCA API v2: Listando jobs de renderiza\xe7\xe3o...");let n=c._m.from("render_jobs").select(`
        *,
        avatar_models (
          id,
          name,
          display_name,
          category
        )
      `).order("created_at",{ascending:!1});a&&"all"!==a&&(n=n.eq("status",a)),r&&(n=n.eq("user_id",r)),n=n.range(o,o+s-1);let{data:l,error:u}=await n;if(u)throw Error(`Erro ao buscar jobs: ${u.message}`);let p=c._m.from("render_jobs").select("*",{count:"exact",head:!0});a&&"all"!==a&&(p=p.eq("status",a)),r&&(p=p.eq("user_id",r));let{count:m}=await p,g=await d.N.getPipelineStats(),_={success:!0,data:{jobs:(l||[]).map(e=>({id:e.id,avatarId:e.avatar_model_id,userId:e.user_id,status:e.status,progress:e.progress||0,startTime:e.created_at,endTime:e.completed_at,duration:e.completed_at?new Date(e.completed_at).getTime()-new Date(e.created_at).getTime():Date.now()-new Date(e.created_at).getTime(),outputVideo:e.output_video_url,outputThumbnail:e.output_thumbnail_url,error:e.error_message,lipSyncAccuracy:e.lipsync_accuracy,audio2FaceEnabled:e.audio2face_enabled,avatar:e.avatar_models?{id:e.avatar_models.id,name:e.avatar_models.name,displayName:e.avatar_models.display_name,category:e.avatar_models.category}:null,render:{quality:e.quality,resolution:e.resolution,rayTracing:e.ray_tracing_enabled,realTimeLipSync:e.real_time_lipsync,language:e.language}})),pagination:{total:m||0,limit:s,offset:o,hasMore:o+s<(m||0)},stats:{...g,queueLength:(l||[]).filter(e=>"queued"===e.status).length,processingCount:(l||[]).filter(e=>"processing"===e.status).length,completedCount:(l||[]).filter(e=>"completed"===e.status).length,failedCount:(l||[]).filter(e=>"failed"===e.status).length},metadata:{version:"2.0.0",timestamp:new Date().toISOString(),filters:{status:a||"all",userId:r||null}}}};return i.NextResponse.json(_)}catch(e){return console.error("âŒ Erro ao listar jobs:",e),i.NextResponse.json({success:!1,error:{message:"Erro ao listar jobs de renderiza\xe7\xe3o",details:e instanceof Error?e.message:"Erro desconhecido",code:"LIST_JOBS_ERROR"}},{status:500})}})}let v=(0,l.H2)(l.wS.authenticated);async function b(e){return v(e,async e=>{try{let{searchParams:t}=new URL(e.url),a=t.get("jobId"),r=t.get("action");if(console.log(`ðŸ—‘ï¸ API v2: ${"cancel"===r?"Cancelando":"Removendo"} job ${a}`),"cancel"===r){if(!a)return i.NextResponse.json({success:!1,error:{message:"Job ID \xe9 obrigat\xf3rio para cancelamento",code:"MISSING_JOB_ID"}},{status:400});if(!await d.N.cancelRenderJob(a))return i.NextResponse.json({success:!1,error:{message:"Job n\xe3o pode ser cancelado (n\xe3o encontrado ou j\xe1 finalizado)",code:"CANNOT_CANCEL_JOB"}},{status:400});return i.NextResponse.json({success:!0,data:{message:"Job cancelado com sucesso",jobId:a,timestamp:new Date().toISOString()}})}if("cleanup"!==r)return i.NextResponse.json({success:!1,error:{message:"A\xe7\xe3o n\xe3o suportada. Use action=cancel ou action=cleanup",code:"UNSUPPORTED_ACTION"}},{status:400});{await d.N.cleanupOldJobs();let e=new Date;e.setDate(e.getDate()-30);let{data:t}=await c._m.from("render_jobs").select("id").lt("created_at",e.toISOString()).in("status",["completed","failed","cancelled"]);return i.NextResponse.json({success:!0,data:{message:"Jobs antigos removidos com sucesso",cleanedCount:t?.length||0,cutoffDate:e.toISOString()}})}}catch(e){return console.error("âŒ Erro ao gerenciar job:",e),i.NextResponse.json({success:!1,error:{message:"Erro ao gerenciar job",details:e instanceof Error?e.message:"Erro desconhecido",code:"JOB_MANAGEMENT_ERROR"}},{status:500})}})}let w=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/v2/avatars/render/route",pathname:"/api/v2/avatars/render",filename:"route",bundlePath:"app/api/v2/avatars/render/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v2\\avatars\\render\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:A,serverHooks:R}=w,x="/api/v2/avatars/render/route";function E(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:A})}},6251:(e,t,a)=>{a.d(t,{N:()=>o});var r=a(8261),s=a(36527);let o={renderAvatar:async e=>e?{success:!1,error:"Use renderHyperRealisticAvatar for real rendering"}:{success:!1,error:"Invalid avatar config"},customizeAvatar:async(e,t)=>{let a=s.e4.getById(e);return a?{success:!0,avatarData:{id:e,...a.metadata,...t}}:{success:!1,error:"Avatar not found in registry"}},renderHyperRealisticAvatar:async(e,t,a,s)=>{try{let o=await r._.renderJob.create({data:{status:"queued",renderSettings:JSON.parse(JSON.stringify({type:"avatar_render",text:t,voiceProfileId:a,options:s,userId:e})),progress:0}});return{success:!0,jobId:o.id,status:"queued",audio2FaceEnabled:!!s.audio2FaceEnabled}}catch(e){return console.error("Error creating render job:",e),{success:!1,error:"Failed to create render job"}}},getRenderJobStatus:async e=>{try{let t=await r._.renderJob.findUnique({where:{id:e}});if(!t)return{status:"not_found",error:"Job not found"};let a=t.renderSettings||{};return{id:t.id,status:t.status||"unknown",outputVideo:t.outputUrl||void 0,error:t.errorMessage||void 0,progress:t.progress||0,avatarId:a.avatarId,userId:t.userId||void 0,startTime:t.createdAt.getTime(),endTime:t.completedAt?.getTime(),outputThumbnail:t.thumbnailUrl||void 0,lipSyncAccuracy:95,audio2FaceEnabled:!0,quality:a.quality,resolution:a.resolution,rayTracingEnabled:a.rayTracing,realTimeLipSync:a.realTimeLipSync,language:a.language,createdAt:t.createdAt,updatedAt:t.updatedAt}}catch(e){return console.error("Error fetching job status:",e),{status:"error",error:"Database error"}}},getAllCategories:()=>["business","casual","medical","industrial"],getAvatarsByCategory:e=>s.e4.getAll().filter(t=>{let a=t.metadata?.style||"";return"business"!==e||"professional"===a}),getAllAvatars:()=>s.e4.getAll(),getAvatar:e=>s.e4.getById(e),getPipelineStats:async()=>{let e=new Date;e.setHours(0,0,0,0);let[t,a,s,o]=await Promise.all([r._.renderJob.count({where:{status:"processing"}}),r._.renderJob.count({where:{status:"queued"}}),r._.renderJob.count({where:{status:"completed",createdAt:{gte:e}}}),r._.renderJob.findMany({where:{status:"completed",durationMs:{not:null}},select:{durationMs:!0},take:100})]),n=o.length>0?o.reduce((e,t)=>e+(t.durationMs||0),0)/o.length:0,i=await r._.renderJob.count(),l=await r._.renderJob.count({where:{status:"completed"}});return{activeJobs:t,queuedJobs:a,completedToday:s,averageRenderTime:Math.round(n),successRate:Math.round(10*(i>0?l/i*100:100))/10,audio2FaceStatus:!0}},generateHyperRealisticLipSync:async(e,t,a,r)=>{let o=s.e4.getById(e);return o?.engine==="ue5"?{success:!0,audio2FaceEnabled:!0,accuracy:95,processingTime:1200,lipSyncData:[]}:{success:!1,audio2FaceEnabled:!1,accuracy:0,error:"Avatar does not support Audio2Face"}},cancelRenderJob:async e=>{try{let t=await r._.renderJob.findUnique({where:{id:e}});if(!t||["completed","failed","cancelled"].includes(t.status||""))return!1;return await r._.renderJob.update({where:{id:e},data:{status:"cancelled"}}),!0}catch(e){return console.error("Error cancelling job:",e),!1}},cleanupOldJobs:async()=>{let e=new Date;e.setDate(e.getDate()-30),await r._.renderJob.deleteMany({where:{createdAt:{lt:e},status:{in:["completed","failed","cancelled"]}}})}}},36527:(e,t,a)=>{a.d(t,{e4:()=>o});let r=[{id:"heygen_anna_news",name:"Anna (News Anchor)",type:"video",engine:"heygen",gender:"female",description:"Apresentadora profissional ideal para comunicados oficiais e treinamentos corporativos.",style:"professional",tags:["news","formal","enterprise"],previewUrl:"https://files.heygen.ai/avatar/v3/3f2583200c854a0397f129e60b811467/full/preview_target.webp",metadata:{style:"professional",quality:"high",tags:["news","formal"]},heyGenConfig:{avatarId:"Anna_public_3_20240108"}},{id:"heygen_josh_casual",name:"Josh (Casual)",type:"video",engine:"heygen",gender:"male",description:"Especialista descontra\xeddo, \xf3timo para v\xeddeos educacionais e comunicados internos.",style:"casual",tags:["explainer","friendly"],previewUrl:"https://files.heygen.ai/avatar/v3/4a90e2/full/preview_target.webp",metadata:{style:"casual",quality:"high",tags:["explainer","friendly"]},heyGenConfig:{avatarId:"Josh_public_2_20240108"}},{id:"mh_male_01",name:"Professional Male (UE5)",type:"3d",engine:"ue5",gender:"male",description:"MetaHuman masculino para renders imersivos em ambientes industriais.",style:"professional",tags:["ue5","metahuman"],metadata:{style:"professional",age_range:"30-40",clothing_options:["suit","casual"],expression_presets:["neutral","smile","speak"]}},{id:"mh_female_01",name:"Professional Female (UE5)",type:"3d",engine:"ue5",gender:"female",description:"MetaHuman feminino indicado para aulas t\xe9cnicas e conte\xfados executivos.",style:"professional",tags:["ue5","metahuman"],metadata:{style:"professional",age_range:"25-35",clothing_options:["suit","casual"],expression_presets:["neutral","smile","speak"]}},{id:"local_male_01",name:"Simple Male (2D)",type:"2d",engine:"local",gender:"male",description:"Avatar 2D leve para pr\xe9-visualiza\xe7\xf5es r\xe1pidas e anima\xe7\xf5es simples.",style:"cartoon",tags:["2d","fast-render"],metadata:{style:"cartoon",color:"#4a90e2"}},{id:"local_female_01",name:"Simple Female (2D)",type:"2d",engine:"local",gender:"female",description:"Avatar 2D feminino otimizado para storyboards e prot\xf3tipos.",style:"cartoon",tags:["2d","fast-render"],metadata:{style:"cartoon",color:"#e24a90"}}];class s{getAll(){return r}getById(e){return r.find(t=>t.id===e)}getByEngine(e){return r.filter(t=>t.engine===e)}}let o=new s},8261:(e,t,a)=>{a.d(t,{_:()=>s});var r=a(53524);let s=global.prisma||new r.PrismaClient({log:["error"]})},99963:(e,t,a)=>{a.d(t,{H2:()=>o,wS:()=>n});var r=a(87070),s=a(5213);function o(e){let{limit:t,windowMs:a,message:o="Muitas requisi\xe7\xf5es. Tente novamente mais tarde.",keyGenerator:n=e=>`ip:${function(e){let t=e.headers.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let a=e.headers.get("cf-connecting-ip");return a?a:e.headers.get("x-real-ip")||"unknown"}(e)}`,skip:i}=e;return async function(e,l){if(i&&await i(e))return l(e);let d=n(e),c=(0,s.D)(d,t,a);if(!c.allowed)return r.NextResponse.json({error:o,retryAfter:c.retryAfterSec},{status:429,headers:{"Retry-After":c.retryAfterSec.toString(),"X-RateLimit-Limit":t.toString(),"X-RateLimit-Reset":new Date(Date.now()+1e3*c.retryAfterSec).toISOString()}});let u=await l(e);return u.headers.set("X-RateLimit-Limit",t.toString()),u.headers.set("X-RateLimit-Remaining",(t-(c.retryAfterSec||0)).toString()),u}}let n={authenticated:{limit:100,windowMs:6e4,message:"Limite de requisi\xe7\xf5es excedido. Aguarde 1 minuto."},anonymous:{limit:20,windowMs:6e4,message:"Limite de requisi\xe7\xf5es excedido para usu\xe1rios n\xe3o autenticados."},upload:{limit:10,windowMs:36e5,message:"Limite de uploads excedido. Aguarde 1 hora."},render:{limit:5,windowMs:36e5,message:"Limite de renderiza\xe7\xf5es excedido. Aguarde 1 hora."},public:{limit:50,windowMs:6e4,message:"Limite de requisi\xe7\xf5es para API p\xfablica excedido."},webhook:{limit:100,windowMs:6e4,message:"Limite de webhooks excedido."}}},5213:(e,t,a)=>{a.d(t,{D:()=>n,U:()=>i});var r=a(87561);let s=e=>{let t=process.env.RATE_LIMIT_DEBUG_LOG;if(t)try{(0,r.appendFileSync)(t,`${JSON.stringify({ts:Date.now(),...e})}
`,{encoding:"utf-8"})}catch(e){"true"===process.env.DEBUG_RATE_LIMIT&&console.error("[rate-limit] debug log failed",e)}},o=()=>{let e=globalThis.process;if(e)return e.__app_rate_limit_store__||(e.__app_rate_limit_store__=new Map),e.__app_rate_limit_store__;let t=globalThis;return t.__app_rate_limit_store__||(t.__app_rate_limit_store__=new Map),t.__app_rate_limit_store__};function n(e,t,a){let r=o(),n=Date.now(),i=r.get(e),l=i?n-i.lastRequest:0;if(!i||l>=a&&n>=(i.blockedUntil||0))return r.set(e,{windowStart:n,lastRequest:n,count:1,blockedUntil:0}),"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] reset",{key:e,limit:t,windowMs:a,idle:l}),s({type:"reset",key:e,limit:t,windowMs:a,idle:l}),{allowed:!0,retryAfterSec:0};if((i=r.get(e)).blockedUntil&&n<i.blockedUntil){let a=Math.max(0,Math.ceil((i.blockedUntil-n)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] still-blocked",{key:e,retryAfterSec:a}),s({type:"blocked",key:e,count:i.count,limit:t,retryAfterSec:a}),i.lastRequest=n,{allowed:!1,retryAfterSec:a}}if(i.count>=t){i.blockedUntil=i.windowStart+a,i.blockedUntil<=n&&(i.blockedUntil=n+a);let r=Math.max(0,Math.ceil((i.blockedUntil-n)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] blocked",{key:e,count:i.count,limit:t,retryAfterSec:r}),s({type:"blocked",key:e,count:i.count,limit:t,retryAfterSec:r}),i.lastRequest=n,{allowed:!1,retryAfterSec:r}}return i.count+=1,i.lastRequest=n,"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] allowed",{key:e,count:i.count,limit:t,idle:l}),s({type:"allowed",key:e,count:i.count,limit:t,idle:l}),{allowed:!0,retryAfterSec:0}}function i(e){return o().get(e)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,1657,9702,2126],()=>a(31725));module.exports=r})();