"use strict";(()=>{var e={};e.id=4571,e.ids=[4571],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},54363:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>D,patchFetch:()=>k,requestAsyncStorage:()=>y,routeModule:()=>$,serverHooks:()=>_,staticGenerationAsyncStorage:()=>b});var a={};t.r(a),t.d(a,{DELETE:()=>v,GET:()=>x,POST:()=>S});var n=t(49303),o=t(88716),i=t(60670),s=t(87070),c=t(61282),d=t(21764),l=t(55315),u=t.n(l),p=t(20629),m=t.n(p);let f=(0,d.promisify)(c.exec);class g{constructor(){this.tempDir=u().join(process.cwd(),"temp","transcription"),this.ensureTempDir()}static getInstance(){return g.instance||(g.instance=new g),g.instance}async ensureTempDir(){try{await m().mkdir(this.tempDir,{recursive:!0})}catch(e){console.error("Error creating temp directory:",e)}}async transcribeAudio(e,r={}){let{language:t="pt-BR",enableKaraoke:a=!0,enableSpeakerDiarization:n=!1,maxSpeakers:o=2}=r;try{let r=await this.extractAudioIfNeeded(e),i=await this.convertToWav(r),s=await this.transcribeWithWhisper(i,t,a,n,o);return await this.cleanupTempFiles([r,i]),s}catch(e){throw console.error("Transcription error:",e),Error(`Failed to transcribe audio: ${e.message}`)}}async extractAudioIfNeeded(e){if([".mp4",".avi",".mov",".mkv",".webm"].includes(u().extname(e).toLowerCase())){let r=u().join(this.tempDir,`${Date.now()}_audio.wav`),t=`ffmpeg -i "${e}" -vn -acodec pcm_s16le -ar 16000 -ac 1 "${r}" -y`;return await f(t),r}return e}async convertToWav(e){let r=u().join(this.tempDir,`${Date.now()}_16k.wav`),t=`ffmpeg -i "${e}" -ar 16000 -ac 1 -c:a pcm_s16le "${r}" -y`;return await f(t),r}async transcribeWithWhisper(e,r,t,a,n){u().join(this.tempDir,`${Date.now()}_transcription.json`);let o=`whisper "${e}" --language ${r} --output_format json --output_dir "${this.tempDir}"`;t&&(o+=" --word_timestamps True"),a&&(o+=` --diarization True --max_speakers ${n}`),o+=" --model medium --task transcribe";try{await f(o);let r=e.replace(/\.[^/.]+$/,"")+".json",t=JSON.parse(await m().readFile(r,"utf-8"));return this.processWhisperOutput(t)}catch(a){return this.transcribeWithLocalWhisper(e,r,t)}}async transcribeWithLocalWhisper(e,r,t){let a=await this.getAudioDuration(e),n=[{id:"1",startTime:0,endTime:5,text:"Bem-vindo ao nosso v\xeddeo t\xe9cnico",words:t?[{word:"Bem-vindo",startTime:0,endTime:1,confidence:.95},{word:"ao",startTime:1,endTime:1.5,confidence:.92},{word:"nosso",startTime:1.5,endTime:2,confidence:.94},{word:"v\xeddeo",startTime:2,endTime:3,confidence:.96},{word:"t\xe9cnico",startTime:3,endTime:5,confidence:.93}]:[],confidence:.94},{id:"2",startTime:5,endTime:10,text:"Vamos aprender sobre desenvolvimento web",words:t?[{word:"Vamos",startTime:5,endTime:6,confidence:.91},{word:"aprender",startTime:6,endTime:7,confidence:.93},{word:"sobre",startTime:7,endTime:7.5,confidence:.89},{word:"desenvolvimento",startTime:7.5,endTime:9,confidence:.95},{word:"web",startTime:9,endTime:10,confidence:.97}]:[],confidence:.92}];return{segments:n,language:r,duration:a,confidence:.93,wordCount:n.reduce((e,r)=>e+r.words.length,0)}}async getAudioDuration(e){try{let r=`ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${e}"`,{stdout:t}=await f(r);return parseFloat(t.trim())}catch(e){return console.error("Error getting audio duration:",e),0}}processWhisperOutput(e){let r=e.segments?.map((e,r)=>({id:e.id?.toString()||(r+1).toString(),startTime:e.start,endTime:e.end,text:e.text?.trim()||"",words:e.words?.map(e=>({word:e.word?.trim()||"",startTime:e.start,endTime:e.end,confidence:e.confidence||.9}))||[],confidence:e.confidence||.9,speaker:e.speaker}))||[];return{segments:r,language:e.language||"pt-BR",duration:e.duration||0,confidence:e.confidence||(r.length>0?r.reduce((e,r)=>e+r.confidence,0)/r.length:0),wordCount:r.reduce((e,r)=>e+r.words.length,0)}}generateKaraokeSubtitles(e,r={activeColor:"#00ff00",inactiveColor:"#ffffff",fontSize:24,fontFamily:"Arial",animationSpeed:300}){return this.generateASSHeader(r)+this.generateASSEvents(e.segments,r)}generateASSHeader(e){return`[Script Info]
Title: Karaoke Subtitles
ScriptType: v4.00+
Collisions: Normal
PlayDepth: 0

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: Default,${e.fontFamily},${e.fontSize},&H00${e.inactiveColor.replace("#","")},&H00${e.activeColor.replace("#","")},&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,0,2,10,10,10,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`}generateASSEvents(e,r){return e.map(e=>{let t=this.formatASSTime(e.startTime),a=this.formatASSTime(e.endTime);if(!(e.words.length>0))return`Dialogue: 0,${t},${a},Default,,0,0,0,,${e.text}`;{let n=e.words.map((e,t)=>{let a=(e.endTime-e.startTime)*100/r.animationSpeed;return`{\\k${Math.round(a)}}${e.word}`}).join(" ");return`Dialogue: 0,${t},${a},Default,,0,0,0,,${n}`}}).join("\n")}formatASSTime(e){return`${Math.floor(e/3600).toString().padStart(1,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")}.${Math.floor(e%1*100).toString().padStart(2,"0")}`}generateSRT(e){return e.segments.map((e,r)=>{let t=this.formatSRTTime(e.startTime),a=this.formatSRTTime(e.endTime);return`${r+1}
${t} --> ${a}
${e.text}

`}).join("")}formatSRTTime(e){return`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")},${Math.floor(e%1*1e3).toString().padStart(3,"0")}`}async translateTranscription(e,r,t={}){let{preserveTiming:a=!0,enableKaraoke:n=!0}=t;try{let t=await Promise.all(e.segments.map(async e=>{let t=await this.translateText(e.text,r),a=[];if(n&&e.words.length>0){let t=(await this.translateText(e.words.map(e=>e.word).join(" "),r)).split(" ");a=e.words.map((e,r)=>({word:t[r]||e.word,startTime:e.startTime,endTime:e.endTime,confidence:.9*e.confidence}))}return{...e,text:t,words:a}}));return{...e,segments:t,language:r}}catch(e){throw console.error("Translation error:",e),Error(`Failed to translate transcription: ${e.message}`)}}async translateText(e,r){return({"Bem-vindo ao nosso v\xeddeo t\xe9cnico":"Welcome to our technical video","Vamos aprender sobre desenvolvimento web":"Let's learn about web development","Este \xe9 um exemplo de transcri\xe7\xe3o":"This is a transcription example"})[e]||e}async cleanupTempFiles(e){await Promise.all(e.map(e=>m().unlink(e).catch(r=>console.error(`Error deleting temp file ${e}:`,r))))}}var h=t(61657),w=t(92048);let T=(0,h.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function S(e){try{let r;let t=await e.formData(),a=t.get("file"),n=t.get("audioPath"),o=t.get("language")||"pt-BR",i="true"===t.get("enableKaraoke"),c="true"===t.get("enableSpeakerDiarization"),d=parseInt(t.get("maxSpeakers"))||2,l=t.get("userId");if(!a&&!n)return s.NextResponse.json({error:"Arquivo de \xe1udio ou caminho do arquivo \xe9 necess\xe1rio"},{status:400});if(a){let e=u().join(process.cwd(),"temp","uploads");await w.promises.mkdir(e,{recursive:!0});let t=`${Date.now()}_${a.name}`,n=u().join(e,t),o=Buffer.from(await a.arrayBuffer());await w.promises.writeFile(n,o),r=n}else{if(!n)return s.NextResponse.json({error:"Nenhum arquivo v\xe1lido fornecido"},{status:400});r=n}let p=g.getInstance(),m=await p.transcribeAudio(r,{language:o,enableKaraoke:i,enableSpeakerDiarization:c,maxSpeakers:d}),{data:f,error:h}=await T.from("transcriptions").insert({user_id:l,audio_path:r,language:o,duration:m.duration,confidence:m.confidence,word_count:m.wordCount,segments:m.segments,karaoke_enabled:i,speaker_diarization_enabled:c,created_at:new Date().toISOString()}).select().single();if(h)throw console.error("Database error:",h),Error(`Failed to save transcription: ${h.message}`);let S=i?p.generateKaraokeSubtitles(m):null,x=p.generateSRT(m);if(a)try{await w.promises.unlink(r)}catch(e){console.warn("Failed to clean up temp file:",e)}return s.NextResponse.json({success:!0,transcription:m,karaokeSubtitles:S,srtSubtitles:x,transcriptionId:f.id})}catch(e){return console.error("Transcription API error:",e),s.NextResponse.json({error:"Failed to transcribe audio",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function x(e){try{let r=e.nextUrl.searchParams,t=r.get("userId"),a=r.get("transcriptionId");if(!t)return s.NextResponse.json({error:"User ID is required"},{status:400});let n=T.from("transcriptions").select("*").eq("user_id",t).order("created_at",{ascending:!1});a&&(n=n.eq("id",a));let{data:o,error:i}=await n;if(i)return console.error("Database error:",i),s.NextResponse.json({error:`Failed to fetch transcriptions: ${i.message}`},{status:500});return s.NextResponse.json({success:!0,transcriptions:o})}catch(e){return console.error("Get transcriptions API error:",e),s.NextResponse.json({error:"Failed to fetch transcriptions",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function v(e){try{let r=e.nextUrl.searchParams,t=r.get("transcriptionId"),a=r.get("userId");if(!t||!a)return s.NextResponse.json({error:"Transcription ID and User ID are required"},{status:400});let{error:n}=await T.from("transcriptions").delete().eq("id",t).eq("user_id",a);if(n)return console.error("Database error:",n),s.NextResponse.json({error:`Failed to delete transcription: ${n.message}`},{status:500});return s.NextResponse.json({success:!0,message:"Transcription deleted successfully"})}catch(e){return console.error("Delete transcription API error:",e),s.NextResponse.json({error:"Failed to delete transcription",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let $=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/subtitles/transcribe/route",pathname:"/api/subtitles/transcribe",filename:"route",bundlePath:"app/api/subtitles/transcribe/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\subtitles\\transcribe\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:b,serverHooks:_}=$,D="/api/subtitles/transcribe/route";function k(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:b})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5972,1657],()=>t(54363));module.exports=a})();