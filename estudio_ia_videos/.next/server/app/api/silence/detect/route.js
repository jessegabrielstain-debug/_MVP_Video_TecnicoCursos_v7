"use strict";(()=>{var e={};e.id=4947,e.ids=[4947],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},55315:e=>{e.exports=require("path")},21764:e=>{e.exports=require("util")},19681:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>F,requestAsyncStorage:()=>S,routeModule:()=>v,serverHooks:()=>$,staticGenerationAsyncStorage:()=>D});var i={};r.r(i),r.d(i,{GET:()=>y,POST:()=>x});var n=r(49303),a=r(88716),o=r(60670),s=r(87070),c=r(92048),l=r(55315),d=r.n(l),u=r(61282),p=r(21764),m=r(20629),h=r.n(m);let f=(0,p.promisify)(u.exec);class g{constructor(e="/tmp/silence-detection"){this.tempDir=e}async detectSilence(e,t={}){let r={silenceThreshold:-30,minSilenceDuration:.5,breathDetection:!0,fillerWordDetection:!0,minBreathDuration:.1,maxBreathDuration:.8,padding:.05,...t};try{await h().mkdir(this.tempDir,{recursive:!0});let t=await this.getAudioDuration(e),i=await this.detectSilenceSegments(e,r),n=r.breathDetection?await this.detectBreathSegments(e,r):[],a=r.fillerWordDetection?await this.detectFillerWords(e,r):[],o=[...i,...n,...a].sort((e,t)=>e.start-t.start),s=this.mergeOverlappingSegments(o),c=i.reduce((e,t)=>e+t.duration,0),l=n.reduce((e,t)=>e+t.duration,0),d=a.reduce((e,t)=>e+t.duration,0),u=s.reduce((e,t)=>e+t.duration,0),p=c/t;return{segments:s,totalSilenceDuration:c,totalBreathDuration:l,totalFillerDuration:d,originalDuration:t,processedDuration:t-u,silenceRatio:p,audioQuality:Math.max(0,Math.min(100,100-50*p-l/t*30))}}catch(e){throw console.error("Error detecting silence:",e),Error(`Failed to detect silence: ${e instanceof Error?e.message:"Unknown error"}`)}}async getAudioDuration(e){try{let{stdout:t}=await f(`ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${e}"`);return parseFloat(t.trim())}catch(e){throw Error(`Failed to get audio duration: ${e instanceof Error?e.message:"Unknown error"}`)}}async detectSilenceSegments(e,t){try{let r;let{stdout:i}=await f(`ffmpeg -i "${e}" -af silencedetect=noise=${t.silenceThreshold}dB:d=${t.minSilenceDuration} -f null -`),n=[],a=/silence_start: ([\d.]+)/g,o=/silence_end: ([\d.]+)/g,s=[],c=[];for(;null!==(r=a.exec(i));)s.push(parseFloat(r[1]));for(;null!==(r=o.exec(i));)c.push(parseFloat(r[1]));for(let e=0;e<Math.min(s.length,c.length);e++){let r=Math.max(0,s[e]-t.padding),i=c[e]+t.padding,a=i-r;a>=t.minSilenceDuration&&n.push({start:r,end:i,duration:a,type:"silence",confidence:.9})}return n}catch(e){return console.error("Error detecting silence segments:",e),[]}}async detectBreathSegments(e,t){try{let r=d().join(this.tempDir,"audio_features.txt");await f(`aubiopitch -i "${e}" -o "${r}" -s -20 -t 0.5`);let i=(await h().readFile(r,"utf-8")).split("\n").filter(e=>e.trim()),n=[],a=null,o=0;for(let e of i){let[r,i,s]=e.split("	").map(parseFloat);if(!(isNaN(r)||isNaN(i)||isNaN(s))){if(i<200&&s<-40&&!a)a=r,o=s;else if(a&&(i>300||s>-30)){let e=r-a;e>=t.minBreathDuration&&e<=t.maxBreathDuration&&n.push({start:Math.max(0,a-t.padding),end:r+t.padding,duration:e+2*t.padding,type:"breath",confidence:Math.min(.9,Math.max(.6,1-Math.abs(o/50)))}),a=null}}}return n}catch(e){return console.error("Error detecting breath segments:",e),[]}}async detectFillerWords(e,t){try{return[]}catch(e){return console.error("Error detecting filler words:",e),[]}}mergeOverlappingSegments(e){if(0===e.length)return[];let t=[],r={...e[0]};for(let i=1;i<e.length;i++){let n=e[i];n.start<=r.end+.1?(r.end=Math.max(r.end,n.end),r.duration=r.end-r.start,r.confidence=Math.max(r.confidence,n.confidence)):(t.push(r),r={...n})}return t.push(r),t}async removeSilence(e,t,r){try{if(0===r.length){await h().copyFile(e,t);return}let i=this.buildSilenceRemovalFilter(r);await f(`ffmpeg -i "${e}" -filter_complex "${i}" -c:v copy -c:a aac -b:a 192k "${t}"`)}catch(e){throw Error(`Failed to remove silence: ${e instanceof Error?e.message:"Unknown error"}`)}}buildSilenceRemovalFilter(e){let t=[],r=0;for(let i of e)i.start>r&&t.push(`between(t,${r},${i.start})`),r=i.end;let i=[],n=0;for(let t of(r=0,e))t.start>r&&i.push(`[0:a]atrim=start=${r}:end=${t.start},asetpts=PTS-STARTPTS[a${n++}]`),r=t.end;let a=i.map((e,t)=>`[a${t}]`).join(""),o=`${a}concat=n=${i.length}:v=0:a=1[outa]`;return[...i,o].join(";")}async cleanup(){try{await h().rm(this.tempDir,{recursive:!0,force:!0})}catch(e){console.error("Error cleaning up temp directory:",e)}}}let w="/tmp/silence-detection";async function x(e){try{let t=await e.formData(),r=t.get("file"),i=t.get("options");if(!r)return s.NextResponse.json({error:"No file provided"},{status:400});let n=i?JSON.parse(i):{};await c.promises.mkdir(w,{recursive:!0});let a=`${Date.now()}_${r.name}`,o=d().join(w,a),l=Buffer.from(await r.arrayBuffer());await c.promises.writeFile(o,l);let u=new g(w),p=await u.detectSilence(o,n);try{await c.promises.unlink(o)}catch(e){console.error("Error cleaning up file:",e)}return s.NextResponse.json(p)}catch(e){return console.error("Error detecting silence:",e),s.NextResponse.json({error:e instanceof Error?e.message:"Detection failed"},{status:500})}}async function y(){return s.NextResponse.json({message:"Silence detection API endpoint",methods:["POST"],description:"Detect silence, breath, and filler word segments in audio/video files"})}let v=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/silence/detect/route",pathname:"/api/silence/detect",filename:"route",bundlePath:"app/api/silence/detect/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\silence\\detect\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:S,staticGenerationAsyncStorage:D,serverHooks:$}=v,E="/api/silence/detect/route";function F(){return(0,o.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:D})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972],()=>r(19681));module.exports=i})();