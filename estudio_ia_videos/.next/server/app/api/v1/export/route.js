"use strict";(()=>{var e={};e.id=8585,e.ids=[8585,3936],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},13513:e=>{e.exports=require("@remotion/bundler")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},96024:e=>{e.exports=import("@remotion/renderer")},81202:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>c,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g});var n=r(49303),s=r(88716),i=r(60670),a=r(99279),l=e([a]);a=(l.then?(await l)():l)[0];let d=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/v1/export/route",pathname:"/api/v1/export",filename:"route",bundlePath:"app/api/v1/export/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\export\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:g,serverHooks:p}=d,m="/api/v1/export/route";function c(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}o()}catch(e){o(e)}})},99279:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{POST:()=>c});var n=r(87070),s=r(13936),i=r(8261),a=r(81969),l=e([a]);async function c(e){try{let t=(0,s.getSupabaseForRequest)(e),{data:{user:r},error:o}=await t.auth.getUser();if(o||!r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{projectId:l}=await e.json();if(!l)return n.NextResponse.json({error:"Project ID required"},{status:400});let c=await i._.project.findUnique({where:{id:l},include:{slides:!0}});if(!c)return n.NextResponse.json({error:"Project not found"},{status:404});let d=[];if(c.slidesData&&Array.isArray(c.slidesData.slides)?d=c.slidesData.slides.map((e,t)=>({id:e.id||Math.random().toString(),number:t+1,order_index:t,elements:e.elements||[],content:e.content||"",title:e.title||"",duration:e.duration||5,visualSettings:{backgroundImageUrl:e.backgroundImage}})):c.slides&&c.slides.length>0&&(d=c.slides.map((e,t)=>({id:e.id,number:t+1,order_index:t,elements:[],content:e.content,title:e.title,duration:e.duration||5,visualSettings:{backgroundImageUrl:e.backgroundImage}}))),0===d.length)return n.NextResponse.json({error:"No slides to render"},{status:400});return console.log(`Starting render for project ${l} with ${d.length} slides`),await i._.project.update({where:{id:l},data:{status:"PROCESSING"}}),a.p.renderVideo(l,d).then(async e=>{console.log(`Render success for ${l}`),await i._.project.update({where:{id:l},data:{status:"COMPLETED",metadata:{...c.metadata||{},videoUrl:e.videoUrl}}})}).catch(async e=>{console.error(`Render failed for ${l}:`,e),await i._.project.update({where:{id:l},data:{status:"ERROR",metadata:{...c.metadata||{},errorMessage:e instanceof Error?e.message:"Unknown render error"}}})}),n.NextResponse.json({success:!0,jobId:l,message:"Renderization started in background"})}catch(e){return console.error("Export error:",e),n.NextResponse.json({error:"Export failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}a=(l.then?(await l)():l)[0],o()}catch(e){o(e)}})},94084:(e,t,r)=>{r.d(t,{OC:()=>a});var o=r(21841);let n={region:process.env.AWS_REGION||"us-east-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""},bucket:process.env.AWS_S3_BUCKET||"estudio-ia-videos"},s=null,i=()=>s||(console.log("[S3] Creating S3 client for region:",n.region),s=new o.S3Client({region:n.region,credentials:n.credentials})),a=async(e,t,r)=>{let s;console.log("[S3] Uploading file to S3:",t);let a=i(),l=r;if(!l&&"type"in e&&(l=e.type),l||(l="application/octet-stream"),Buffer.isBuffer(e))s=e;else if(e instanceof Blob)s=e;else throw Error("Invalid file format for upload");let c=new o.PutObjectCommand({Bucket:n.bucket,Key:t,Body:s,ContentType:l});try{return await a.send(c),{url:`https://${n.bucket}.s3.amazonaws.com/${t}`,key:t}}catch(e){throw console.error("[S3] Upload error:",e),e}}},8261:(e,t,r)=>{r.d(t,{_:()=>n});var o=r(53524);let n=global.prisma||new o.PrismaClient({log:["error"]})},8803:(e,t,r)=>{r.d(t,{kg:()=>l});var o=r(92048),n=r.n(o),s=r(55315),i=r.n(s);class a{constructor(){this.maxFileSize=10485760,this.maxFiles=5,this.logDir=i().join(process.cwd(),"logs"),n().existsSync(this.logDir)||n().mkdirSync(this.logDir,{recursive:!0}),this.currentLogFile=i().join(this.logDir,`app-${this.getDateString()}.log`)}static getInstance(){return a.instance||(a.instance=new a),a.instance}getDateString(){let e=new Date;return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}`}getTimestamp(){return new Date().toISOString()}formatConsole(e){let t={DEBUG:"\x1b[36m",INFO:"\x1b[37m",WARN:"\x1b[33m",ERROR:"\x1b[31m",FATAL:"\x1b[35m",RESET:"\x1b[0m"},r=t[e.level],o={DEBUG:"\uD83D\uDD0D",INFO:"â„¹ï¸",WARN:"âš ï¸",ERROR:"âŒ",FATAL:"\uD83D\uDC80"}[e.level],n=`${r}[${e.timestamp}] ${o} ${e.level} [${e.component}] ${e.message}${t.RESET}`;return e.data&&(n+=`
${r}   Data: ${JSON.stringify(e.data,null,2)}${t.RESET}`),e.stack&&(n+=`
${r}   Stack: ${e.stack}${t.RESET}`),n}writeToFile(e){try{this.rotateIfNeeded();let t=JSON.stringify(e)+"\n";n().appendFileSync(this.currentLogFile,t,"utf-8")}catch(e){console.error("Erro ao escrever log:",e)}}rotateIfNeeded(){try{if(n().existsSync(this.currentLogFile)&&n().statSync(this.currentLogFile).size>=this.maxFileSize){let e=Date.now(),t=this.currentLogFile.replace(".log",`-${e}.log`);n().renameSync(this.currentLogFile,t),this.cleanOldLogs()}}catch(e){console.error("Erro ao rotacionar logs:",e)}}cleanOldLogs(){try{let e=n().readdirSync(this.logDir).filter(e=>e.endsWith(".log")).map(e=>({name:e,path:i().join(this.logDir,e),time:n().statSync(i().join(this.logDir,e)).mtime.getTime()})).sort((e,t)=>t.time-e.time);e.length>this.maxFiles&&e.slice(this.maxFiles).forEach(e=>{n().unlinkSync(e.path)})}catch(e){console.error("Erro ao limpar logs antigos:",e)}}log(e,t,r,o,n){let s={timestamp:this.getTimestamp(),level:e,component:t,message:r,data:o};n&&(s.stack=n.stack),this.writeToFile(s)}debug(e,t,r){this.log("DEBUG",e,t,r)}info(e,t,r){this.log("INFO",e,t,r)}warn(e,t,r){this.log("WARN",e,t,r)}error(e,t,r,o){this.log("ERROR",e,t,o,r)}fatal(e,t,r,o){this.log("FATAL",e,t,o,r)}analyzeLogs(e){let t=e||this.currentLogFile;if(!n().existsSync(t))throw Error(`Arquivo de log n\xe3o encontrado: ${t}`);let r=n().readFileSync(t,"utf-8").split("\n").filter(e=>e.trim()).map(e=>{try{return JSON.parse(e)}catch{return null}}).filter(e=>null!==e),o={totalLogs:r.length,byLevel:{DEBUG:r.filter(e=>"DEBUG"===e.level).length,INFO:r.filter(e=>"INFO"===e.level).length,WARN:r.filter(e=>"WARN"===e.level).length,ERROR:r.filter(e=>"ERROR"===e.level).length,FATAL:r.filter(e=>"FATAL"===e.level).length},byComponent:{},errors:r.filter(e=>"ERROR"===e.level||"FATAL"===e.level),warnings:r.filter(e=>"WARN"===e.level),timeRange:{start:r[0]?.timestamp||"",end:r[r.length-1]?.timestamp||""}};return r.forEach(e=>{o.byComponent[e.component]||(o.byComponent[e.component]=0),o.byComponent[e.component]++}),o}searchLogs(e,t,r,o){let s=o||this.currentLogFile;return n().existsSync(s)?n().readFileSync(s,"utf-8").split("\n").filter(e=>e.trim()).map(e=>{try{return JSON.parse(e)}catch{return null}}).filter(e=>null!==e).filter(o=>(!t||o.level===t)&&(!r||o.component===r)&&(!e||JSON.stringify(o).toLowerCase().includes(e.toLowerCase()))):[]}printAnalysis(e){console.log("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"),console.log("â•‘                    \uD83D\uDCCA AN\xc1LISE DE LOGS                            â•‘"),console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"),console.log(`ðŸ“‹ Total de Logs: ${e.totalLogs}`),console.log(`â° Per\xedodo: ${e.timeRange.start} â†’ ${e.timeRange.end}
`),console.log("\uD83D\uDCCA Por N\xedvel:"),console.log(`   ðŸ” DEBUG: ${e.byLevel.DEBUG}`),console.log(`   â„¹ï¸  INFO:  ${e.byLevel.INFO}`),console.log(`   âš ï¸  WARN:  ${e.byLevel.WARN}`),console.log(`   âŒ ERROR: ${e.byLevel.ERROR}`),console.log(`   ðŸ’€ FATAL: ${e.byLevel.FATAL}
`),console.log("\uD83D\uDCE6 Por Componente:"),Object.entries(e.byComponent).sort(([,e],[,t])=>t-e).forEach(([e,t])=>{console.log(`   - ${e}: ${t}`)}),e.errors.length>0&&(console.log(`
âŒ Erros Recentes (${e.errors.length}):`),e.errors.slice(-5).forEach(e=>{console.log(`   [${e.timestamp}] ${e.component}: ${e.message}`)})),e.warnings.length>0&&(console.log(`
âš ï¸  Avisos Recentes (${e.warnings.length}):`),e.warnings.slice(-5).forEach(e=>{console.log(`   [${e.timestamp}] ${e.component}: ${e.message}`)})),console.log("\n")}getLogFiles(){return n().readdirSync(this.logDir).filter(e=>e.endsWith(".log")).map(e=>i().join(this.logDir,e))}clearLogs(){let e=this.getLogFiles();e.forEach(e=>n().unlinkSync(e)),console.log(`âœ… ${e.length} arquivos de log removidos`)}}let l=a.getInstance()},81969:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.d(t,{p:()=>p});var n=r(13513),s=r(96024),i=r(55315),a=r.n(i),l=r(92048),c=r.n(l),d=r(94084),u=r(8803),g=e([s]);s=(g.then?(await g)():g)[0];class p{static async renderVideo(e,t){let r=a().join(process.cwd(),"app/remotion/index.ts");u.kg.info("RenderService",`Starting render for project ${e}`);try{u.kg.info("RenderService","Bundling video...");let o=await (0,n.bundle)({entryPoint:r}),i=await (0,s.selectComposition)({serveUrl:o,id:"MyVideo",inputProps:{slides:t}}),l=a().join(process.cwd(),"public","renders",`${e}.mp4`),g=a().dirname(l);c().existsSync(g)||c().mkdirSync(g,{recursive:!0}),u.kg.info("RenderService","Rendering video...",{durationInFrames:i.durationInFrames}),await (0,s.renderMedia)({composition:i,serveUrl:o,codec:"h264",outputLocation:l,inputProps:{slides:t}}),u.kg.info("RenderService","Render complete",{outputLocation:l});let p=c().readFileSync(l),m=`renders/${e}-${Date.now()}.mp4`;u.kg.info("RenderService","Uploading to S3...",{s3Key:m});let{url:h}=await (0,d.OC)(p,m,"video/mp4");u.kg.info("RenderService","Upload complete",{videoUrl:h});try{c().unlinkSync(l)}catch(e){u.kg.warn("RenderService","Failed to cleanup local file",e)}return{success:!0,videoUrl:h,s3Key:m}}catch(e){throw u.kg.error("RenderService","Error rendering video",e),e}}}o()}catch(e){o(e)}})},13936:(e,t,r)=>{r.d(t,{e:()=>i,getSupabaseForRequest:()=>l,p:()=>a});var o=r(67721),n=r(61657),s=r(71615);let i=()=>{let e=(0,s.cookies)();return(0,o.createServerClient)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{cookies:{get:t=>e.get(t)?.value,set(t,r,o){try{e.set({name:t,value:r,...o})}catch(e){}},remove(t,r){try{e.set({name:t,value:"",...r})}catch(e){}}}})},a=(0,n.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});function l(e){let t=e.headers.get("authorization")||e.headers.get("Authorization");return t?(0,n.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9maHpyZGlhZHhpZ3J2bXJoYWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTE3NjEsImV4cCI6MjA3NTI4Nzc2MX0.u-F5m9lvYc1lx9aA-MoTZqCAa83QHGVk8uTh-_KPfCQ",{global:{headers:{Authorization:t}},auth:{persistSession:!1,autoRefreshToken:!1}}):i()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,1657,9702],()=>r(81202));module.exports=o})();