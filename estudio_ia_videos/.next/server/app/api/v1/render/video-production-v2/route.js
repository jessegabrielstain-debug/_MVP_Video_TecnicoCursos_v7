"use strict";(()=>{var e={};e.id=7491,e.ids=[7491],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},46718:e=>{e.exports=require("canvas")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61212:e=>{e.exports=require("async_hooks")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},27920:e=>{e.exports=require("diagnostics_channel")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},96119:e=>{e.exports=require("perf_hooks")},35816:e=>{e.exports=require("process")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},17718:e=>{e.exports=require("node:child_process")},65714:e=>{e.exports=require("node:diagnostics_channel")},15673:e=>{e.exports=require("node:events")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},85690:e=>{e.exports=require("node:inspector")},82033:e=>{e.exports=require("node:module")},87503:e=>{e.exports=require("node:net")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},51747:e=>{e.exports=require("node:readline")},84492:e=>{e.exports=require("node:stream")},31764:e=>{e.exports=require("node:tls")},47261:e=>{e.exports=require("node:util")},24086:e=>{e.exports=require("node:worker_threads")},65628:e=>{e.exports=require("node:zlib")},49574:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>U,requestAsyncStorage:()=>P,routeModule:()=>$,serverHooks:()=>F,staticGenerationAsyncStorage:()=>R});var o={};r.r(o),r.d(o,{GET:()=>q,POST:()=>A});var s=r(49303),a=r(88716),i=r(60670),n=r(87070),d=r(24507),l=r(61657),c=r(55315),p=r.n(c),u=r(20629),g=r.n(u),f=r(74037),h=r(91630),m=r(61282),w=r(19801),b=r.n(w),v=r(64053);class _{constructor(e){let t=process.env.SUPABASE_SERVICE_ROLE_KEY;this.supabase=(0,l.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",t),this.settings=e||{}}async prepareAssets(e){return console.log("[Pipeline] Preparing assets for",e.length,"slides"),{ready:!0}}async renderSlides(e,t){return console.log("[Pipeline] Rendering slides..."),e.map((e,t)=>`slide_${t}.mp4`)}async composeTimeline(e,t){return console.log("[Pipeline] Composing timeline..."),{composed:!0,duration:t.duration}}async encodeVideo(e,t){return console.log("[Pipeline] Encoding video with settings:",t),`/tmp/output_${Date.now()}.mp4`}async execute(e){console.log("[Pipeline] Starting render pipeline for project:",e.projectId);let{projectId:t,jobId:r}=e;try{await f.N.startJob(r),await f.N.updateProgress(r,5);let{data:o,error:s}=await this.supabase.from("slides").select("*").eq("project_id",t).order("order_index",{ascending:!0});if(s||!o||0===o.length)throw Error("No slides found for project");let a=await g().mkdtemp(p().join(b().tmpdir(),"render-")),i=[];for(let t=0;t<o.length;t++){let s=o[t],n=10+Math.round(t/o.length*60);await f.N.updateProgress(r,n),console.log(`[Pipeline] Processing slide ${t+1}/${o.length}`);let d=p().join(a,`slide_${t}.mp4`);if(s.avatar_config?.engine==="heygen")console.log(`[Pipeline] Slide ${t} uses HeyGen avatar. Initiating cloud render...`),await this.processHeyGenSlide(s,d,e.test);else{let e="";if(s.content){let r=await h.O_.generateSpeech({text:s.content,voiceId:s.audio_config?.voiceId||"21m00Tcm4TlvDq8ikWAM"});e=p().join(a,`slide_${t}_audio.mp3`),await g().writeFile(e,Buffer.from(r))}await this.createSlideVideo(s,e,d)}i.push(d)}await f.N.updateProgress(r,80);let n=p().join(a,"final_output.mp4");await this.concatVideos(i,n),await f.N.updateProgress(r,90);let d=await g().readFile(n),l=`projects/${t}/${Date.now()}_final.mp4`,{error:c}=await this.supabase.storage.from("videos").upload(l,d,{contentType:"video/mp4",upsert:!0});if(c)throw c;let{data:{publicUrl:u}}=this.supabase.storage.from("videos").getPublicUrl(l);return await g().rm(a,{recursive:!0,force:!0}),await f.N.completeJob(r,u),u}catch(t){console.error("[Pipeline] Error:",t);let e=t instanceof Error?t.message:"Unknown error";throw await f.N.failJob(r,e),t}}async createSlideVideo(e,t,r){let o=e.duration||5,s=e.background_color||"black",a=["-y","-f","lavfi","-i",`color=c=${s}:s=1280x720:d=${o}`];t&&(a.push("-i",t),a.push("-map","0:v","-map","1:a"),a.push("-shortest")),a.push("-c:v","libx264","-pix_fmt","yuv420p"),a.push(r),await this.runFFmpeg(a)}async processHeyGenSlide(e,t,r=!1){try{let o=e.avatar_config,s=await v.b.render({engine:"heygen",duration:e.duration,config:{avatarId:o.avatarId,text:e.content||" ",quality:o.quality||"high",background:e.background_color||"#00FF00",voiceId:o.voiceId,test:r}});if("video"!==s.type||!s.jobId)throw Error("Failed to initiate HeyGen render");let a="",i=0;for(;i<60;){await new Promise(e=>setTimeout(e,5e3));let e=await v.b.checkHeyGenStatus(s.jobId);if("completed"===e.status&&e.videoUrl){a=e.videoUrl;break}if("failed"===e.status)throw Error("HeyGen render failed");i++,console.log(`[Pipeline] Polling HeyGen job ${s.jobId}: ${e.status} (${i}/60)`)}if(!a)throw Error("HeyGen render timed out");console.log(`[Pipeline] Downloading HeyGen video from ${a}`);let n=await fetch(a);if(!n.ok)throw Error(`Failed to download video: ${n.statusText}`);let d=await n.arrayBuffer();await g().writeFile(t,Buffer.from(d)),console.log(`[Pipeline] HeyGen video saved to ${t}`)}catch(e){throw console.error("[Pipeline] Error processing HeyGen slide:",e),e}}async concatVideos(e,t){let r=p().join(p().dirname(t),"list.txt"),o=e.map(e=>`file '${e.replace(/\\/g,"/")}'`).join("\n");await g().writeFile(r,o);let s=["-y","-f","concat","-safe","0","-i",r,"-c","copy",t];await this.runFFmpeg(s)}runFFmpeg(e){return new Promise((t,r)=>{let o=(0,m.spawn)("ffmpeg",e);o.on("close",e=>{0===e?t():r(Error(`FFmpeg exited with code ${e}`))}),o.on("error",e=>r(e))})}async validatePipeline(){return!0}}new _;var y=r(84770),S=r.n(y),x=r(92048),E=r.n(x);let j=new Map;async function A(e){console.log("\uD83C\uDFAC [Video Render v2] Iniciando renderiza\xe7\xe3o de produ\xe7\xe3o...");try{let{slides:t,timeline:r,settings:o}=await e.json();if(!t||!Array.isArray(t))return n.NextResponse.json({success:!1,error:"Slides s\xe3o obrigat\xf3rios"},{status:400});if(!r||!r.totalDuration)return n.NextResponse.json({success:!1,error:"Timeline \xe9 obrigat\xf3rio"},{status:400});let s={width:o?.width||1920,height:o?.height||1080,fps:o?.fps||30,bitrate:o?.bitrate||"8000k",format:o?.format||"mp4",quality:o?.quality||"high",audioQuality:o?.audioQuality||192,enableAudio:o?.enableAudio!==!1},a=`render_${S().randomBytes(16).toString("hex")}`,i={jobId:a,status:"queued",progress:0,startedAt:new Date().toISOString(),settings:s};return j.set(a,i),console.log("\uD83D\uDCCB [Video Render v2] Job criado:",{jobId:a,slides:t.length,duration:r.totalDuration,settings:s}),I(a,t,r,s).catch(e=>{console.error(`âŒ [Video Render v2] Erro no job ${a}:`,e);let t=j.get(a);t&&(t.status="failed",t.errorMessage=e instanceof Error?e.message:"Erro desconhecido",t.completedAt=new Date().toISOString(),j.set(a,t))}),n.NextResponse.json({success:!0,jobId:a,message:"Renderiza\xe7\xe3o iniciada com sucesso",estimatedTime:Math.ceil(2*r.totalDuration),status:"queued"})}catch(e){return console.error("âŒ [Video Render v2] Erro na cria\xe7\xe3o do job:",e),n.NextResponse.json({success:!1,error:"Erro interno na renderiza\xe7\xe3o",details:e instanceof Error?e.message:"Erro desconhecido"},{status:500})}}async function q(e){let{searchParams:t}=new URL(e.url),r=t.get("jobId");if(!r)return n.NextResponse.json({success:!1,error:"Job ID \xe9 obrigat\xf3rio"},{status:400});let o=j.get(r);return o?n.NextResponse.json({success:!0,job:{jobId:o.jobId,status:o.status,progress:o.progress,startedAt:o.startedAt,completedAt:o.completedAt,outputPath:o.outputPath||"Em processamento...",errorMessage:o.errorMessage,settings:o.settings}}):n.NextResponse.json({success:!1,error:"Job n\xe3o encontrado"},{status:404})}async function I(e,t,r,o){console.log(`ðŸ”„ [Video Render v2] Processando job ${e}...`);let s=j.get(e);if(s)try{s.status="processing",s.progress=10,j.set(e,s);let a=new _(o);console.log(`ðŸ“¦ [Video Render v2] Preparando assets para job ${e}...`),await a.prepareAssets(t),s.progress=30,j.set(e,s),console.log(`ðŸŽ¨ [Video Render v2] Renderizando slides para job ${e}...`);let i=await a.renderSlides(t,r);s.progress=60,j.set(e,s),console.log(`ðŸŽžï¸ [Video Render v2] Compondo timeline para job ${e}...`);let n=await a.composeTimeline(i,r);s.progress=80,j.set(e,s),console.log(`ðŸ“¹ [Video Render v2] Codificando v\xeddeo final para job ${e}...`);let l=await a.encodeVideo(n,o);s.progress=95,j.set(e,s);let c=l;try{console.log(`â˜ï¸ [Video Render v2] Fazendo upload para S3 do job ${e}...`);let t=`rendered-videos/${e}.${o.format}`,r=E().readFileSync(l),s=await d.f.uploadFile(t,r,`video/${o.format}`);s&&(c=s)}catch(t){console.warn(`âš ï¸ [Video Render v2] Upload S3 falhou para job ${e}:`,t)}s.status="completed",s.progress=100,s.outputPath=c,s.completedAt=new Date().toISOString(),j.set(e,s),console.log(`âœ… [Video Render v2] Job ${e} conclu\xeddo com sucesso!`)}catch(t){console.error(`âŒ [Video Render v2] Erro no job ${e}:`,t),s.status="failed",s.errorMessage=t instanceof Error?t.message:"Erro desconhecido na renderiza\xe7\xe3o",s.completedAt=new Date().toISOString(),j.set(e,s)}}let $=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/v1/render/video-production-v2/route",pathname:"/api/v1/render/video-production-v2",filename:"route",bundlePath:"app/api/v1/render/video-production-v2/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\render\\video-production-v2\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:P,staticGenerationAsyncStorage:R,serverHooks:F}=$,T="/api/v1/render/video-production-v2/route";function U(){return(0,i.patchFetch)({serverHooks:F,staticGenerationAsyncStorage:R})}},91630:(e,t,r)=>{r.d(t,{O_:()=>n,ZP:()=>d});var o=r(61657),s=r(84770),a=r.n(s);class i{constructor(e={}){this.apiKey=e.apiKey||process.env.ELEVENLABS_API_KEY||"";let t=process.env.SUPABASE_SERVICE_ROLE_KEY;this.supabase=(0,o.eI)("https://ofhzrdiadxigrvmrhaiz.supabase.co",t)}static getInstance(){return i.instance||(i.instance=new i),i.instance}async generateSpeech(e){if(!this.apiKey)throw Error("ElevenLabs API Key not configured");let t=e.voiceId||e.voice_id||"21m00Tcm4TlvDq8ikWAM",r=e.modelId||e.model_id||"eleven_multilingual_v2",o=e.voice_settings||{stability:.5,similarity_boost:.75},s=a().createHash("md5").update(`${t}-${e.text}-${JSON.stringify(o)}`).digest("hex"),i=`tts/${s}.mp3`,{data:n}=await this.supabase.storage.from("assets").download(i);if(n)return console.log(`ðŸŽ¤ TTS Cache Hit: ${i}`),await n.arrayBuffer();console.log(`ðŸŽ¤ Generating TTS for: "${e.text.substring(0,20)}..."`);let d=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${t}`,{method:"POST",headers:{Accept:"audio/mpeg","Content-Type":"application/json","xi-api-key":this.apiKey},body:JSON.stringify({text:e.text,model_id:r,voice_settings:o})});if(!d.ok){let e=await d.text();throw Error(`ElevenLabs API Error: ${d.status} - ${e}`)}let l=await d.arrayBuffer(),{error:c}=await this.supabase.storage.from("assets").upload(i,l,{contentType:"audio/mpeg",upsert:!0});return c&&console.warn("âš ï¸ Failed to cache TTS audio:",c.message),l}async listVoices(){if(!this.apiKey)return[];let e=await fetch("https://api.elevenlabs.io/v1/voices",{headers:{"xi-api-key":this.apiKey}});return e.ok?(await e.json()).voices:[]}async getVoices(){return(await this.listVoices()).map(e=>({id:e.voice_id,name:e.name,category:e.category,description:e.description,labels:e.labels,preview_url:e.preview_url,settings:e.settings,language:e.labels?.language||"unknown",gender:e.labels?.gender||"unknown",accent:e.labels?.accent||"unknown"}))}async getUserInfo(){if(!this.apiKey)return null;let e=await fetch("https://api.elevenlabs.io/v1/user",{headers:{"xi-api-key":this.apiKey}});if(!e.ok)throw Error(`Failed to fetch user info: ${e.statusText}`);return await e.json()}async cloneVoice(e,t,r){if(!this.apiKey)throw Error("ElevenLabs API Key not configured");let o=new FormData;o.append("name",e),t&&o.append("description",t),r.forEach(e=>{o.append("files",e)});let s=await fetch("https://api.elevenlabs.io/v1/voices/add",{method:"POST",headers:{"xi-api-key":this.apiKey},body:o});if(!s.ok){let e=await s.text();throw Error(`ElevenLabs API Error: ${s.status} - ${e}`)}return await s.json()}}let n=new i,d=i},74037:(e,t,r)=>{r.d(t,{N:()=>i});var o=r(61657),s=r(80338);class a{constructor(){let e="https://ofhzrdiadxigrvmrhaiz.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;e&&t||console.warn("âš ï¸ Supabase credentials not found in JobManager"),this.supabase=(0,o.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}async getJobContext(e){try{let{data:t,error:r}=await this.supabase.from("render_jobs").select("project_id").eq("id",e).single();if(r||!t)return null;let{data:o,error:s}=await this.supabase.from("projects").select("user_id").eq("id",t.project_id).single();if(s||!o)return null;return{projectId:t.project_id,userId:o.user_id}}catch(e){return console.error("Error fetching job context:",e),null}}async createJob(e,t){let r=new Date(Date.now()-6e4).toISOString(),{data:o}=await this.supabase.from("render_jobs").select("id").eq("project_id",t).eq("status","queued").gt("created_at",r).maybeSingle();if(o)return console.log(`[JobManager] Idempotency: Returning existing queued job ${o.id} for project ${t}`),o.id;let{data:s,error:a}=await this.supabase.from("render_jobs").insert({project_id:t,user_id:e,status:"queued",progress:0,render_settings:{},attempts:0}).select("id").single();if(a)throw Error(`Failed to create job: ${a.message}`);return s.id}async getJob(e){let{data:t,error:r}=await this.supabase.from("render_jobs").select("*").eq("id",e).single();return r||!t?null:{id:t.id,userId:t.user_id,projectId:t.project_id,status:t.status,progress:t.progress,createdAt:new Date(t.created_at),startedAt:t.started_at?new Date(t.started_at):void 0,completedAt:t.completed_at?new Date(t.completed_at):void 0,outputUrl:t.output_url,error:t.error_message}}async updateProgress(e,t){let r={progress:Math.min(100,Math.max(0,t)),updated_at:new Date().toISOString()},{error:o}=await this.supabase.from("render_jobs").update(r).eq("id",e);o&&console.error(`Failed to update progress for job ${e}:`,o)}async startJob(e){let{error:t}=await this.supabase.from("render_jobs").update({status:"processing",started_at:new Date().toISOString(),progress:0}).eq("id",e);if(t)console.error(`Failed to start job ${e}:`,t);else{let t=await this.getJobContext(e);t&&s.DR.renderStarted({jobId:e,projectId:t.projectId,userId:t.userId}).catch(e=>console.error("Webhook trigger failed:",e))}}async completeJob(e,t){let{error:r}=await this.supabase.from("render_jobs").update({status:"completed",progress:100,completed_at:new Date().toISOString(),output_url:t}).eq("id",e);if(r)console.error(`Failed to complete job ${e}:`,r);else{let r=await this.getJobContext(e);r&&s.DR.renderCompleted({jobId:e,projectId:r.projectId,videoUrl:t,duration:0}).catch(e=>console.error("Webhook trigger failed:",e))}}async failJob(e,t){let{error:r}=await this.supabase.from("render_jobs").update({status:"failed",completed_at:new Date().toISOString(),error_message:t}).eq("id",e);if(r)console.error(`Failed to fail job ${e}:`,r);else{let r=await this.getJobContext(e);r&&s.DR.renderFailed({jobId:e,projectId:r.projectId,error:t}).catch(e=>console.error("Webhook trigger failed:",e))}}async listJobs(e,t=100){let r=this.supabase.from("render_jobs").select("*");e&&(r=r.eq("project_id",e));let{data:o,error:s}=await r.order("created_at",{ascending:!1}).limit(t);return s?(console.error("Failed to list jobs:",s),[]):o.map(e=>({id:e.id,userId:e.user_id,projectId:e.project_id,status:e.status,progress:e.progress,createdAt:new Date(e.created_at),startedAt:e.started_at?new Date(e.started_at):void 0,completedAt:e.completed_at?new Date(e.completed_at):void 0,outputUrl:e.output_url,error:e.error_message}))}async removeJob(e){let{error:t}=await this.supabase.from("render_jobs").delete().eq("id",e);t&&console.error(`Failed to remove job ${e}:`,t)}}let i=new a},24507:(e,t,r)=>{r.d(t,{f:()=>l});var o=r(92048),s=r(55315),a=r.n(s),i=r(21841),n=r(61657);function d(){return(process.env.STORAGE_PROVIDER||"local").toLowerCase()}class l{static async deleteFile(e){if("local"===d()){let t=a().join(process.cwd(),"public","uploads",e);await o.promises.rm(t,{force:!0});return}}static async downloadFile(e){try{let t=d();if("local"===t){let t=a().join(process.cwd(),"public","uploads",e),r=await o.promises.readFile(t);return{success:!0,buffer:r}}if("supabase"===t){let t=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY||"",o=process.env.SUPABASE_STORAGE_BUCKET||"public",s=(0,n.eI)(t,r),{data:a,error:i}=await s.storage.from(o).download(e);if(i||!a)return{success:!1,error:i?.message||"Download failed"};let d=await a.arrayBuffer();return{success:!0,buffer:Buffer.from(d)}}let r=process.env.AWS_REGION||"us-east-1",s=process.env.AWS_S3_BUCKET||"";if(!s)return{success:!1,error:"AWS_S3_BUCKET not configured"};let l=new i.S3Client({region:r}),c=(await l.send(new i.GetObjectCommand({Bucket:s,Key:e}))).Body,p=[];for await(let e of c)p.push(Buffer.isBuffer(e)?e:Buffer.from(e));return{success:!0,buffer:Buffer.concat(p)}}catch(e){return{success:!1,error:String(e)}}}static async fileExists(e){if("local"===d()){let t=a().join(process.cwd(),"public","uploads",e);try{await o.promises.access(t)}catch{return!1}}return!0}static async uploadFile(e,t,r){let s=d();if("local"===s){let r=a().join(process.cwd(),"public","uploads",e);return await o.promises.mkdir(a().dirname(r),{recursive:!0}),await o.promises.writeFile(r,t),`/uploads/${e}`.replace(/\\/g,"/")}if("supabase"===s){let o=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"",a=process.env.SUPABASE_STORAGE_BUCKET||"public",i=(0,n.eI)(o,s),{error:d}=await i.storage.from(a).upload(e,t,{contentType:r,upsert:!0});if(d)throw d;let{data:l}=i.storage.from(a).getPublicUrl(e);return l.publicUrl}let l=process.env.AWS_REGION||"us-east-1",c=process.env.AWS_S3_BUCKET||"",p=new i.S3Client({region:l});return await p.send(new i.PutObjectCommand({Bucket:c,Key:e,Body:t,ContentType:r||"application/octet-stream"})),`https://${c}.s3.${l}.amazonaws.com/${e}`}static async getSignedUrl(e,t=3600){let r=d();if("local"===r)return`/uploads/${e}`.replace(/\\/g,"/");if("supabase"===r){let r=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",o=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=process.env.SUPABASE_STORAGE_BUCKET||"public",a=(0,n.eI)(r,o),{data:i,error:d}=await a.storage.from(s).createSignedUrl(e,t);if(d||!i)throw d||Error("Failed to sign URL");return i.signedUrl}let o=process.env.AWS_REGION||"us-east-1",s=process.env.AWS_S3_BUCKET||"";return`https://${s}.s3.${o}.amazonaws.com/${e}`}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,1657,9092,7686,616,4053],()=>r(49574));module.exports=o})();