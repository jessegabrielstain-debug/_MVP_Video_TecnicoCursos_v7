"use strict";(()=>{var e={};e.id=1756,e.ids=[1756],e.modules={220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},592048:e=>{e.exports=require("fs")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},555315:e=>{e.exports=require("path")},768621:e=>{e.exports=require("punycode")},276162:e=>{e.exports=require("stream")},917360:e=>{e.exports=require("url")},671568:e=>{e.exports=require("zlib")},906005:e=>{e.exports=require("node:crypto")},487561:e=>{e.exports=require("node:fs")},714907:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>E,requestAsyncStorage:()=>x,routeModule:()=>b,serverHooks:()=>D,staticGenerationAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{GET:()=>R,POST:()=>v,runtime:()=>f});var a=s(349303),o=s(88716),i=s(60670),n=s(387070),d=s(848588),u=s(895412),l=s(5213),p=s(831006),_=s(351842),c=s(840594);let m=c.Km(["queued","processing","completed","failed","cancelled"]),g=c.Ry({limit:c.oQ.number().int().min(1).max(50).default(20),status:m.optional()});var h=s(40817);let f="nodejs",j=()=>"false"!==process.env.ALLOW_RENDER_JOBS_FALLBACK;async function v(e){let t=Date.now(),s=null;try{let a;let o=await e.json(),i=function(e){let t=_.l_.safeParse(e);return t.success?{ok:!0,data:t.data}:{ok:!1,issues:t.error.issues}}(o);if(!i.ok){var r;return r=i.issues,n.NextResponse.json({code:"VALIDATION_ERROR",message:"Payload inv\xe1lido",details:r},{status:400})}let c=(e.headers.get("authorization")??e.headers.get("Authorization")??"").trim(),m=(c.toLowerCase().startsWith("bearer ")?c.slice(7).trim():c).length>0,g=(0,h.Z2)()||!m;if(g)a=(0,h.fR)(e);else{s=(0,u.s)(e);let{data:t,error:r}=await s.auth.getUser();if(r||!t.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});a=t.user.id}let f=(0,l.D)(`post:${a}`,30,6e4);if("true"===process.env.DEBUG_RATE_LIMIT&&d.k.info("video-jobs","rate-limit-check",{key:`post:${a}`,result:f,bucket:(0,l.U)(`post:${a}`)}),!f.allowed)return(0,p.g7)(),new n.NextResponse(JSON.stringify({code:"RATE_LIMITED",message:"Muitas requisi\xe7\xf5es. Tente novamente em breve."}),{status:429,headers:{"content-type":"application/json","Retry-After":String(f.retryAfterSec)}});if(g){let e=(0,h.OY)(a,i.data),s=Date.now()-t;return n.NextResponse.json({job:e,metrics:{validation_ms:s}},{status:201})}let v=i.data;if(!s)throw Error("Supabase client n\xe3o inicializado");let{error:R,data:b}=await s.from("render_jobs").insert({user_id:a,project_id:v.project_id,status:"queued",progress:0,attempts:1,render_settings:{slides:v.slides.length,quality:v.quality,tts_voice:v.tts_voice}}).select("id,status,project_id,created_at,progress,render_settings,attempts,duration_ms").single();if(R){if((0,p.vJ)("DB_ERROR"),j()){let e=(0,h.OY)(a,v),s=Date.now()-t;return n.NextResponse.json({job:e,metadata:{fallback:"mock"},metrics:{validation_ms:s}},{status:201})}return n.NextResponse.json({code:"DB_ERROR",message:"Falha ao criar job",details:R.message},{status:500})}let x=Date.now()-t,y=b?{id:b.id,status:b.status,project_id:b.project_id,created_at:b.created_at,progress:b.progress,attempts:b.attempts,duration_ms:b.duration_ms??null,settings:b.render_settings}:null;return n.NextResponse.json({job:y,metrics:{validation_ms:x}},{status:201})}catch(e){return(0,p.vJ)("UNEXPECTED"),d.k.error("video-jobs","unexpected-error",e),n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}async function R(e){let t;let s=j(),r=null,a="",o=10;try{let i=(e.headers.get("authorization")??e.headers.get("Authorization")??"").trim(),d=(i.toLowerCase().startsWith("bearer ")?i.slice(7).trim():i).length>0,l=(0,h.Z2)()||!d,_=null;if(l)a=(0,h.fR)(e);else{_=(0,u.s)(e);let{data:t,error:s}=await _.auth.getUser();if(s||!t.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});a=t.user.id}let c=new URL(e.url),m={};c.searchParams.forEach((e,t)=>{m[t]=e});let f=function(e){let t={};for(let[s,r]of Object.entries(e))t[s]=Array.isArray(r)?r[0]:r;return g.safeParse(t)}(m);if(!f.success)return n.NextResponse.json({code:"VALIDATION_ERROR",message:"Par\xe2metros inv\xe1lidos",details:f.error.issues},{status:400});o=f.data.limit,t=f.data.status;let j=globalThis;j.__vj_cache||(j.__vj_cache=new Map);let v=`list:${a}:${o}:${t||"all"}`,R=(e="MISS")=>{let s={jobs:(0,h.Rx)(a,{limit:o,status:t})};return j.__vj_cache.set(v,{expiresAt:Date.now()+15e3,payload:s}),new n.NextResponse(JSON.stringify(s),{status:200,headers:{"content-type":"application/json","X-Cache":e,"X-Mock-Data":"render-jobs"}})};r=R;let b=j.__vj_cache.get(v);if(b&&b.expiresAt>Date.now())return new n.NextResponse(JSON.stringify(b.payload),{status:200,headers:{"content-type":"application/json","X-Cache":"HIT"}});if(l)return R();if(!_)throw Error("Supabase client n\xe3o inicializado");let x=_.from("render_jobs").select("id,status,project_id,created_at,progress,render_settings,attempts,duration_ms").eq("user_id",a).order("created_at",{ascending:!1}).limit(o);t&&(x=x.eq("status",t));let{data:y,error:D}=await x;if(D){if((0,p.vJ)("DB_ERROR"),s&&r)return r();return n.NextResponse.json({code:"DB_ERROR",message:"Falha ao listar jobs",details:D.message},{status:500})}let w={jobs:(y??[]).map(e=>{let{render_settings:t,...s}=e;return{...s,settings:t}})};return j.__vj_cache.set(v,{expiresAt:Date.now()+15e3,payload:w}),new n.NextResponse(JSON.stringify(w),{status:200,headers:{"content-type":"application/json","X-Cache":"MISS"}})}catch(e){if((0,p.vJ)("UNEXPECTED"),d.k.error("video-jobs","list-unexpected-error",e),s&&r)return r();return n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}let b=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/v1/video-jobs/route",pathname:"/api/v1/video-jobs",filename:"route",bundlePath:"app/api/v1/video-jobs/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\video-jobs\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:y,serverHooks:D}=b,w="/api/v1/video-jobs/route";function E(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:y})}},40817:(e,t,s)=>{s.d(t,{$L:()=>m,OY:()=>_,Rx:()=>c,Z2:()=>i,fR:()=>n});var r=s(906005);let a=()=>{let e=globalThis;return e.__mock_render_jobs__||(e.__mock_render_jobs__=new Map),e.__mock_render_jobs__},o=()=>!!(process.env.NEXT_PUBLIC_SUPABASE_URL&&process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY),i=()=>"true"===process.env.USE_MOCK_RENDER_JOBS||!o(),n=e=>{let t=e?.headers.get("x-mock-user")?.trim();return t&&t.length>0?t:"mock-user"},d=(e,t)=>{let s=new Date().toISOString();return{id:(0,r.randomUUID)(),user_id:e,project_id:t.project_id??(0,r.randomUUID)(),status:t.status??"queued",progress:t.progress??0,attempts:t.attempts??1,duration_ms:t.duration_ms??("completed"===t.status?42e3:null),render_settings:t.render_settings??{slides:4,quality:"medium",tts_voice:"br-Female"},created_at:t.created_at??s,updated_at:t.updated_at??s,completed_at:t.completed_at??("completed"===t.status?s:null)}},u=e=>{let t=Date.now();return[d(e,{status:"completed",progress:100,duration_ms:38e3,created_at:new Date(t-18e5).toISOString(),completed_at:new Date(t-15e5).toISOString(),render_settings:{slides:12,quality:"high",tts_voice:"br-Male"}}),d(e,{status:"completed",progress:100,duration_ms:52e3,created_at:new Date(t-54e5).toISOString(),completed_at:new Date(t-528e4).toISOString(),render_settings:{slides:9,quality:"medium"}}),d(e,{status:"processing",progress:65,duration_ms:null,created_at:new Date(t-3e5).toISOString(),render_settings:{slides:6,quality:"medium"}}),d(e,{status:"queued",progress:0,duration_ms:null,created_at:new Date(t-12e4).toISOString(),render_settings:{slides:3,quality:"low"}}),d(e,{status:"failed",progress:35,duration_ms:null,created_at:new Date(t-108e5).toISOString(),render_settings:{slides:8,quality:"high"}})]},l=e=>{let t=a();return t.has(e)||t.set(e,u(e)),t.get(e)},p=e=>({id:e.id,status:e.status,project_id:e.project_id,created_at:e.created_at,progress:e.progress,attempts:e.attempts,duration_ms:e.duration_ms,settings:e.render_settings}),_=(e,t)=>{let s=l(e),r=d(e,{project_id:t.project_id,status:"queued",progress:0,attempts:1,duration_ms:null,render_settings:{slides:t.slides.length,quality:t.quality??"medium",tts_voice:t.tts_voice??"br-Female"}});return s.unshift(r),p(r)},c=(e,t)=>{let s=l(e);return(t.status?s.filter(e=>e.status===t.status):s).slice(0,t.limit).map(p)},m=e=>{let t=l(e),s=t.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{}),r=t.filter(e=>"completed"===e.status),a=Date.now(),o=r.filter(e=>!!e.completed_at&&a-new Date(e.completed_at).getTime()<=36e5).length,i=r.map(e=>e.duration_ms??0),n=i.length?Math.round(i.reduce((e,t)=>e+t,0)/i.length):0,d=i.slice().sort((e,t)=>e-t),u=e=>{if(!d.length)return 0;let t=Math.min(d.length-1,Math.floor(e*(d.length-1)));return d[t]};return{totals:{total_jobs:t.length},by_status:{queued:s.queued||0,processing:s.processing||0,completed:s.completed||0,failed:s.failed||0,cancelled:s.cancelled||0,other:0},throughput:{window_minutes:60,jobs_completed_last_60m:o,jobs_per_min:Number(((o||0)/60).toFixed(3))},performance:{avg_duration_ms:n,p50_ms:u(.5),p90_ms:u(.9),p95_ms:u(.95)}}}},351842:(e,t,s)=>{s.d(t,{GJ:()=>i,LL:()=>d,kB:()=>n,l_:()=>o});var r=s(840594);let a=r.Ry({title:r.Z_().min(1),content:r.Z_().min(1),order_index:r.Rx().int().nonnegative()}),o=r.Ry({project_id:r.Z_().uuid(),slides:r.IX(a).min(1),tts_voice:r.Z_().optional(),quality:r.Km(["low","medium","high"]).default("medium")});r.Ry({startDate:r.oQ.date().optional(),endDate:r.oQ.date().optional(),projectId:r.Z_().uuid().optional(),groupBy:r.Km(["day","week","month"]).default("day"),includeDetails:r.oQ.boolean().default(!1)});let i=r.Ry({period:r.Km(["24h","7d","30d","all"]).default("7d"),includeErrors:r.oQ.boolean().default(!0),includePerformance:r.oQ.boolean().default(!0)});r.Ry({eventType:r.Km(["slide_reordered","video_exported","project_created","render_started","render_completed","render_failed","user_login","user_logout"]),eventData:r.IM(r._4()),userId:r.Z_().uuid().optional(),sessionId:r.Z_().optional(),timestamp:r.oQ.date().default(()=>new Date)}),r.Ry({startDate:r.oQ.date(),endDate:r.oQ.date(),eventTypes:r.IX(r.Z_()).optional(),userId:r.Z_().uuid().optional(),limit:r.oQ.number().int().positive().max(1e3).default(100),offset:r.oQ.number().int().nonnegative().default(0)});let n=r.Ry({jobId:r.Z_().uuid("ID de job inv\xe1lido"),reason:r.Z_().max(500).optional()}),d=r.Ry({jobId:r.Z_().uuid("ID de job inv\xe1lido"),force:r.oQ.boolean().default(!1)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,8355,3105,2694],()=>s(714907));module.exports=r})();