"use strict";(()=>{var e={};e.id=1756,e.ids=[1756],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},27920:e=>{e.exports=require("diagnostics_channel")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},96119:e=>{e.exports=require("perf_hooks")},35816:e=>{e.exports=require("process")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},17718:e=>{e.exports=require("node:child_process")},65714:e=>{e.exports=require("node:diagnostics_channel")},15673:e=>{e.exports=require("node:events")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},85690:e=>{e.exports=require("node:inspector")},82033:e=>{e.exports=require("node:module")},87503:e=>{e.exports=require("node:net")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},51747:e=>{e.exports=require("node:readline")},84492:e=>{e.exports=require("node:stream")},31764:e=>{e.exports=require("node:tls")},47261:e=>{e.exports=require("node:util")},24086:e=>{e.exports=require("node:worker_threads")},65628:e=>{e.exports=require("node:zlib")},14907:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>x,serverHooks:()=>R,staticGenerationAsyncStorage:()=>j});var s={};r.r(s),r.d(s,{GET:()=>f,POST:()=>g,runtime:()=>_});var o=r(49303),i=r(88716),a=r(60670),n=r(87070),d=r(60354),l=r(5213),u=r(31006),p=r(51842),c=r(40981);let _="nodejs",m=()=>"false"!==process.env.ALLOW_RENDER_JOBS_FALLBACK;async function g(e){let t=Date.now(),r=null;try{let o;let i=await e.json(),a=function(e){let t=p.l_.safeParse(e);return t.success?{ok:!0,data:t.data}:{ok:!1,issues:t.error.issues}}(i);if(!a.ok){var s;return s=a.issues,n.NextResponse.json({code:"VALIDATION_ERROR",message:"Payload inv\xe1lido",details:s},{status:400})}let _=(e.headers.get("authorization")??e.headers.get("Authorization")??"").trim(),g=(_.toLowerCase().startsWith("bearer ")?_.slice(7).trim():_).length>0,f=(0,c.Z2)()||!g;if(f)o=(0,c.fR)(e);else{r=(0,d.sR)(e);let{data:t,error:s}=await r.auth.getUser();if(s||!t.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});o=t.user.id}let x=(0,l.D)(`post:${o}`,30,6e4);if("true"===process.env.DEBUG_RATE_LIMIT&&d.kg.info("video-jobs","rate-limit-check",{key:`post:${o}`,result:x,bucket:(0,l.U)(`post:${o}`)}),!x.allowed)return(0,u.g7)(),new n.NextResponse(JSON.stringify({code:"RATE_LIMITED",message:"Muitas requisi\xe7\xf5es. Tente novamente em breve."}),{status:429,headers:{"content-type":"application/json","Retry-After":String(x.retryAfterSec)}});if(f){let e=(0,c.OY)(o,a.data),r=Date.now()-t;return n.NextResponse.json({job:e,metrics:{validation_ms:r}},{status:201})}let h=a.data;if(!r)throw Error("Supabase client n\xe3o inicializado");let{error:j,data:R}=await r.from("render_jobs").insert({user_id:o,project_id:h.project_id,status:"queued",progress:0,attempts:1,render_settings:{slides:h.slides.length,quality:h.quality,tts_voice:h.tts_voice}}).select("id,status,project_id,created_at,progress,render_settings,attempts,duration_ms").single();if(j){if((0,u.vJ)("DB_ERROR"),m()){let e=(0,c.OY)(o,h),r=Date.now()-t;return n.NextResponse.json({job:e,metadata:{fallback:"mock"},metrics:{validation_ms:r}},{status:201})}return n.NextResponse.json({code:"DB_ERROR",message:"Falha ao criar job",details:j.message},{status:500})}let b=Date.now()-t,v=R?{id:R.id,status:R.status,project_id:R.project_id,created_at:R.created_at,progress:R.progress,attempts:R.attempts,duration_ms:R.duration_ms??null,settings:R.render_settings}:null;return n.NextResponse.json({job:v,metrics:{validation_ms:b}},{status:201})}catch(e){return(0,u.vJ)("UNEXPECTED"),d.kg.error("video-jobs","unexpected-error",e),n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}async function f(e){let t=m(),r=null,s="",o=null;try{let i=(e.headers.get("authorization")??e.headers.get("Authorization")??"").trim(),a=(i.toLowerCase().startsWith("bearer ")?i.slice(7).trim():i).length>0,l=(0,c.Z2)()||!a,_=null;if(l)s=(0,c.fR)(e);else{_=(0,d.sR)(e);let{data:t,error:r}=await _.auth.getUser();if(r||!t.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});s=t.user.id}let m=new URL(e.url),g={};m.searchParams.forEach((e,t)=>{g[t]=e});let f=function(e){let t={};for(let[r,s]of Object.entries(e))t[r]=Array.isArray(s)?s[0]:s;return p.xV.safeParse(t)}(g);if(!f.success)return n.NextResponse.json({code:"VALIDATION_ERROR",message:"Par\xe2metros inv\xe1lidos",details:f.error.issues},{status:400});o=f.data;let x=globalThis;x.__vj_cache||(x.__vj_cache=new Map);let h=`list:${s}:${o.limit}:${o.offset}:${o.status||"all"}:${o.projectId||"all"}:${o.sortBy}:${o.sortOrder}`,j=(e="MISS")=>{let t={jobs:(0,c.Rx)(s,{limit:o.limit,offset:o.offset,status:o.status,projectId:o.projectId,sortBy:o.sortBy,sortOrder:o.sortOrder})};return x.__vj_cache?.set(h,{expiresAt:Date.now()+15e3,payload:t}),new n.NextResponse(JSON.stringify(t),{status:200,headers:{"content-type":"application/json","X-Cache":e,"X-Mock-Data":"render-jobs"}})};r=j;let R=x.__vj_cache.get(h);if(R&&R.expiresAt>Date.now())return new n.NextResponse(JSON.stringify(R.payload),{status:200,headers:{"content-type":"application/json","X-Cache":"HIT"}});if(l)return j();if(!_)throw Error("Supabase client n\xe3o inicializado");if(!o)throw Error("Par\xe2metros da listagem n\xe3o foram inicializados");let{limit:b,offset:v,status:y,projectId:q,sortBy:D,sortOrder:I}=o,w=_.from("render_jobs").select("id,status,project_id,created_at,updated_at,progress,render_settings,attempts,duration_ms").eq("user_id",s).order("updated_at"===D?"updated_at":"status"===D?"status":"created_at",{ascending:"asc"===I}).range(v,v+b-1);y&&(w=w.eq("status",y)),q&&(w=w.eq("project_id",q));let{data:E,error:T}=await w;if(T){if((0,u.vJ)("DB_ERROR"),t&&r)return r();return n.NextResponse.json({code:"DB_ERROR",message:"Falha ao listar jobs",details:T.message},{status:500})}let S={jobs:(E??[]).map(e=>{let{render_settings:t,...r}=e;return{...r,settings:t}})};return x.__vj_cache?.set(h,{expiresAt:Date.now()+15e3,payload:S}),new n.NextResponse(JSON.stringify(S),{status:200,headers:{"content-type":"application/json","X-Cache":"MISS"}})}catch(e){if((0,u.vJ)("UNEXPECTED"),d.kg.error("video-jobs","list-unexpected-error",e),t&&r)return r();return n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}let x=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/v1/video-jobs/route",pathname:"/api/v1/video-jobs",filename:"route",bundlePath:"app/api/v1/video-jobs/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\video-jobs\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:j,serverHooks:R}=x,b="/api/v1/video-jobs/route";function v(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:j})}},40981:(e,t,r)=>{r.d(t,{$L:()=>m,fR:()=>n,OY:()=>c,Rx:()=>_,Z2:()=>a});let s=require("node:crypto"),o=()=>{let e=globalThis;return e.__mock_render_jobs__||(e.__mock_render_jobs__=new Map),e.__mock_render_jobs__},i=()=>!0,a=()=>"true"===process.env.USE_MOCK_RENDER_JOBS||!i(),n=e=>{let t=e?.headers.get("x-mock-user")?.trim();return t&&t.length>0?t:"mock-user"},d=(e,t)=>{let r=new Date().toISOString();return{id:(0,s.randomUUID)(),user_id:e,project_id:t.project_id??(0,s.randomUUID)(),status:t.status??"queued",progress:t.progress??0,attempts:t.attempts??1,duration_ms:t.duration_ms??("completed"===t.status?42e3:null),render_settings:t.render_settings??{slides:4,quality:"medium",tts_voice:"br-Female"},created_at:t.created_at??r,updated_at:t.updated_at??r,completed_at:t.completed_at??("completed"===t.status?r:null)}},l=e=>{let t=Date.now();return[d(e,{status:"completed",progress:100,duration_ms:38e3,created_at:new Date(t-18e5).toISOString(),completed_at:new Date(t-15e5).toISOString(),render_settings:{slides:12,quality:"high",tts_voice:"br-Male"}}),d(e,{status:"completed",progress:100,duration_ms:52e3,created_at:new Date(t-54e5).toISOString(),completed_at:new Date(t-528e4).toISOString(),render_settings:{slides:9,quality:"medium"}}),d(e,{status:"processing",progress:65,duration_ms:null,created_at:new Date(t-3e5).toISOString(),render_settings:{slides:6,quality:"medium"}}),d(e,{status:"queued",progress:0,duration_ms:null,created_at:new Date(t-12e4).toISOString(),render_settings:{slides:3,quality:"low"}}),d(e,{status:"failed",progress:35,duration_ms:null,created_at:new Date(t-108e5).toISOString(),render_settings:{slides:8,quality:"high"}})]},u=e=>{let t=o();return t.has(e)||t.set(e,l(e)),t.get(e)},p=e=>({id:e.id,status:e.status,project_id:e.project_id,created_at:e.created_at,progress:e.progress,attempts:e.attempts,duration_ms:e.duration_ms,settings:e.render_settings}),c=(e,t)=>{let r=u(e),s=d(e,{project_id:t.project_id,status:"queued",progress:0,attempts:1,duration_ms:null,render_settings:{slides:t.slides.length,quality:t.quality??"medium",tts_voice:t.tts_voice??"br-Female"}});return r.unshift(s),p(s)},_=(e,t)=>{let r=u(e),s=t.status?r.filter(e=>e.status===t.status):r;return t.projectId&&(s=s.filter(e=>e.project_id===t.projectId)),s.slice().sort((e,r)=>{let s="asc"===t.sortOrder?1:-1;return"status"===t.sortBy?e.status.localeCompare(r.status)*s:"updated_at"===t.sortBy?e.updated_at.localeCompare(r.updated_at)*s:e.created_at.localeCompare(r.created_at)*s}).slice(t.offset,t.offset+t.limit).map(p)},m=e=>{let t=u(e),r=t.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{}),s=t.filter(e=>"completed"===e.status),o=Date.now(),i=s.filter(e=>!!e.completed_at&&o-new Date(e.completed_at).getTime()<=36e5).length,a=s.map(e=>e.duration_ms??0),n=a.length?Math.round(a.reduce((e,t)=>e+t,0)/a.length):0,d=a.slice().sort((e,t)=>e-t),l=e=>{if(!d.length)return 0;let t=Math.min(d.length-1,Math.floor(e*(d.length-1)));return d[t]};return{totals:{total_jobs:t.length},by_status:{queued:r.queued||0,processing:r.processing||0,completed:r.completed||0,failed:r.failed||0,cancelled:r.cancelled||0,other:0},throughput:{window_minutes:60,jobs_completed_last_60m:i,jobs_per_min:Number(((i||0)/60).toFixed(3))},performance:{avg_duration_ms:n,p50_ms:l(.5),p90_ms:l(.9),p95_ms:l(.95)}}}},5213:(e,t,r)=>{r.d(t,{D:()=>a,U:()=>n});var s=r(87561);let o=e=>{let t=process.env.RATE_LIMIT_DEBUG_LOG;if(t)try{(0,s.appendFileSync)(t,`${JSON.stringify({ts:Date.now(),...e})}
`,{encoding:"utf-8"})}catch(e){"true"===process.env.DEBUG_RATE_LIMIT&&console.error("[rate-limit] debug log failed",e)}},i=()=>{let e=globalThis.process;if(e)return e.__app_rate_limit_store__||(e.__app_rate_limit_store__=new Map),e.__app_rate_limit_store__;let t=globalThis;return t.__app_rate_limit_store__||(t.__app_rate_limit_store__=new Map),t.__app_rate_limit_store__};function a(e,t,r){let s=i(),a=Date.now(),n=s.get(e),d=n?a-n.lastRequest:0;if(!n||d>=r&&a>=(n.blockedUntil||0))return s.set(e,{windowStart:a,lastRequest:a,count:1,blockedUntil:0}),"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] reset",{key:e,limit:t,windowMs:r,idle:d}),o({type:"reset",key:e,limit:t,windowMs:r,idle:d}),{allowed:!0,retryAfterSec:0};if((n=s.get(e)).blockedUntil&&a<n.blockedUntil){let r=Math.max(0,Math.ceil((n.blockedUntil-a)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] still-blocked",{key:e,retryAfterSec:r}),o({type:"blocked",key:e,count:n.count,limit:t,retryAfterSec:r}),n.lastRequest=a,{allowed:!1,retryAfterSec:r}}if(n.count>=t){n.blockedUntil=n.windowStart+r,n.blockedUntil<=a&&(n.blockedUntil=a+r);let s=Math.max(0,Math.ceil((n.blockedUntil-a)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] blocked",{key:e,count:n.count,limit:t,retryAfterSec:s}),o({type:"blocked",key:e,count:n.count,limit:t,retryAfterSec:s}),n.lastRequest=a,{allowed:!1,retryAfterSec:s}}return n.count+=1,n.lastRequest=a,"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] allowed",{key:e,count:n.count,limit:t,idle:d}),o({type:"allowed",key:e,count:n.count,limit:t,idle:d}),{allowed:!0,retryAfterSec:0}}function n(e){return i().get(e)}},31006:(e,t,r)=>{r.d(t,{g7:()=>o,vJ:()=>i});let s=()=>{let e=globalThis;return e.__metrics||(e.__metrics={rate_limit_hits:0,errors:{},startTime:Date.now()}),e.__metrics};function o(){let e=s();e.rate_limit_hits+=1}function i(e){let t=s();t.errors[e]=(t.errors[e]||0)+1}},51842:(e,t,r)=>{r.d(t,{FR:()=>c,N8:()=>p,SV:()=>g,gG:()=>_,kB:()=>m,l_:()=>u,xV:()=>f});var s=r(40594);let o=s.dj(e=>{if("string"==typeof e){let t=e.trim().toLowerCase();if(["true","1","yes","y"].includes(t))return!0;if(["false","0","no","n"].includes(t))return!1}return e},s.O7()),i=s.dj(e=>{if(e instanceof Date)return e;if("string"==typeof e||"number"==typeof e){let t=new Date(e);return Number.isNaN(t.getTime())?void 0:t}return e},s.hT()),a=s.Km(["1h","24h","7d","30d","all"]),n=s.Km(["1h","24h","7d","30d","90d"]),d=s.Km(["all","completed","failed","processing","pending"]),l=s.Ry({title:s.Z_().min(1,"T\xedtulo \xe9 obrigat\xf3rio"),content:s.Z_().min(1,"Conte\xfado \xe9 obrigat\xf3rio"),order_index:s.Rx().int().nonnegative()}),u=s.Ry({project_id:s.Z_().uuid("ID de projeto inv\xe1lido"),slides:s.IX(l).min(1,"Pelo menos um slide \xe9 necess\xe1rio"),tts_voice:s.Z_().optional(),quality:s.Km(["low","medium","high"]).default("medium"),flow:s.Ry({enabled:s.O7().default(!1),bpmSource:s.Km(["auto","manual"]).default("auto"),bpmManual:s.Rx().positive().optional(),beatToleranceMs:s.Rx().int().positive().max(200).default(25),crossfadeRatio:s.Rx().min(.2).max(.6).default(.35),sidechain:s.Ry({threshold:s.Rx().min(0).default(.015),ratio:s.Rx().min(1).max(10).default(4)}).optional()}).optional()}),p=s.Km(["queued","processing","completed","failed","cancelled"]),c=s.Ry({jobId:s.Z_().uuid("ID de job inv\xe1lido"),progress:s.Rx().min(0).max(100),status:p,currentStep:s.Z_().optional(),estimatedTimeRemaining:s.Rx().nonnegative().optional()});s.Ry({id:s.Z_().uuid("ID de job inv\xe1lido"),jobId:s.Z_().uuid("ID de job inv\xe1lido").optional()}),s.Ry({startDate:i.optional(),endDate:i.optional(),projectId:s.Z_().uuid("ID de projeto inv\xe1lido").optional(),groupBy:s.Km(["hour","day","week","month"]).default("day"),includeDetails:o.optional().default(!1)}).refine(e=>!e.startDate||!e.endDate||e.startDate.getTime()<=e.endDate.getTime(),{message:"startDate deve ser anterior ao endDate",path:["endDate"]});let _=s.Ry({period:s.dj(e=>"string"==typeof e?e.toLowerCase():e,a).default("7d"),includeErrors:o.optional().default(!0),includePerformance:o.optional().default(!0),limit:s.oQ.number().int().positive().max(5e3).default(5e3)}).extend({status:p.optional(),projectId:s.Z_().uuid("ID de projeto inv\xe1lido").optional()});s.Ry({eventType:s.Km(["slide_reordered","video_exported","project_created","render_started","render_completed","render_failed","user_login","user_logout"]),eventData:s.IM(s._4()),userId:s.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),sessionId:s.Z_().optional(),timestamp:s.oQ.date().default(()=>new Date)}),s.Ry({startDate:s.oQ.date(),endDate:s.oQ.date(),eventTypes:s.IX(s.Z_()).optional(),userId:s.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),limit:s.oQ.number().int().positive().max(1e3).default(100),offset:s.oQ.number().int().nonnegative().default(0)}),s.Ry({timeRange:s.dj(e=>"string"==typeof e?e.toLowerCase():e,n).default("24h"),userId:s.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),projectType:s.Z_().min(1).optional(),status:s.dj(e=>"string"==typeof e?e.toLowerCase():e,d).default("all"),includeErrors:o.optional().default(!0),includePerformance:o.optional().default(!0)});let m=s.dj(e=>{if("object"==typeof e&&null!==e&&!("jobId"in e)){if(e.id)return{...e,jobId:e.id};if(e.job_id)return{...e,jobId:e.job_id}}return e},s.Ry({jobId:s.Z_().uuid("ID de job inv\xe1lido"),reason:s.Z_().max(500).optional()}));s.Ry({jobId:s.Z_().uuid("ID de job inv\xe1lido"),force:o.optional().default(!1)});let g=s.Ry({jobId:s.Z_().uuid("ID de job inv\xe1lido"),priority:s.Km(["low","normal","high"]).default("normal"),resetProgress:o.optional().default(!1)}),f=s.Ry({status:p.optional(),projectId:s.Z_().uuid("ID de projeto inv\xe1lido").optional(),limit:s.oQ.number().int().positive().max(100).default(20),offset:s.oQ.number().int().nonnegative().default(0),sortBy:s.Km(["created_at","updated_at","status"]).default("created_at"),sortOrder:s.Km(["asc","desc"]).default("desc")});s.Ry({id:s.Z_().uuid(),user_id:s.Z_().uuid(),project_id:s.Z_().uuid().nullable(),status:p,progress:s.Rx().min(0).max(100),attempts:s.Rx().int().nonnegative(),created_at:s.Z_().datetime(),updated_at:s.Z_().datetime().optional(),completed_at:s.Z_().datetime().nullable(),duration_ms:s.Rx().nonnegative().nullable(),render_settings:s.IM(s._4()).nullable(),error_message:s.Z_().nullable()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1657,9702,9092,7686,6608,1080,3595],()=>r(14907));module.exports=s})();