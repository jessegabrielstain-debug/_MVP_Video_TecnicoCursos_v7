"use strict";(()=>{var e={};e.id=8039,e.ids=[8039],e.modules={220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},592048:e=>{e.exports=require("fs")},532615:e=>{e.exports=require("http")},735240:e=>{e.exports=require("https")},555315:e=>{e.exports=require("path")},768621:e=>{e.exports=require("punycode")},276162:e=>{e.exports=require("stream")},917360:e=>{e.exports=require("url")},671568:e=>{e.exports=require("zlib")},487561:e=>{e.exports=require("node:fs")},353321:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>b,patchFetch:()=>N,requestAsyncStorage:()=>v,routeModule:()=>x,serverHooks:()=>R,staticGenerationAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{GET:()=>j,POST:()=>_});var o=s(349303),a=s(88716),i=s(60670),n=s(387070),d=s(895412),u=s(5213),p=s(831006),c=s(840594);let l=c.Km(["processing","completed","failed"]),g=c.Ry({id:c.Z_().uuid(),progress:c.oQ.number().min(0).max(100),status:l.optional()});var m=s(848588);async function _(e){try{var t,s;let r=(0,d.s)(e),{data:o,error:a}=await r.auth.getUser();if(a||!o.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});let i=(0,u.D)(`progress:${o.user.id}`,120,6e4);if(!i.allowed)return(0,p.g7)(),new n.NextResponse(JSON.stringify({code:"RATE_LIMITED",message:"Muitas requisi\xe7\xf5es de progresso. Tente novamente em breve."}),{status:429,headers:{"content-type":"application/json","Retry-After":String(i.retryAfterSec)}});let c=(t=await e.json(),g.safeParse(t));if(!c.success)return s=c.error.issues,n.NextResponse.json({code:"VALIDATION_ERROR",message:"Payload inv\xe1lido",details:s},{status:400});let{id:l,progress:_,status:j}=c.data,{data:x,error:v}=await r.from("render_jobs").select("id,status,user_id").eq("id",l).single();if(v||!x)return n.NextResponse.json({code:"NOT_FOUND",message:"Job n\xe3o encontrado"},{status:404});if(x.user_id&&x.user_id!==o.user.id)return n.NextResponse.json({code:"FORBIDDEN",message:"Sem permiss\xe3o para atualizar este job"},{status:403});if(!["queued","processing"].includes(x.status))return n.NextResponse.json({code:"CONFLICT",message:"Job n\xe3o pode ser atualizado neste status"},{status:409});let f={progress:_};if(j&&(f.status=j),"processing"===j){let{data:e}=await r.from("render_jobs").select("started_at").eq("id",l).single();e&&!e.started_at&&(f.started_at=new Date().toISOString())}if(("completed"===j||"failed"===j)&&(f.completed_at=new Date().toISOString()),"completed"===j){let{data:e}=await r.from("render_jobs").select("id,started_at").eq("id",l).single();if(e&&e.started_at){let t=Date.parse(e.started_at),s=Date.now()-t;f.duration_ms=s}}let{data:R,error:b}=await r.from("render_jobs").update(f).eq("id",l).select("id,status,project_id,created_at,progress,render_settings,attempts,duration_ms").single();if(b||!R)return(0,p.vJ)("DB_ERROR"),m.k.error("video-jobs-progress","db-update-failed",b),n.NextResponse.json({code:"DB_ERROR",message:"Falha ao atualizar job",details:b?.message},{status:500});let N={id:R.id,status:R.status,project_id:R.project_id,created_at:R.created_at,progress:R.progress,attempts:R.attempts,duration_ms:R.duration_ms??null,settings:R.render_settings};return n.NextResponse.json({job:N})}catch(e){return(0,p.vJ)("UNEXPECTED"),m.k.error("video-jobs-progress","unexpected-error",e),n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}function j(){return n.NextResponse.json({code:"METHOD_NOT_ALLOWED",message:"Use POST para atualizar progresso"},{status:405})}let x=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/v1/video-jobs/progress/route",pathname:"/api/v1/video-jobs/progress",filename:"route",bundlePath:"app/api/v1/video-jobs/progress/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\video-jobs\\progress\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:f,serverHooks:R}=x,b="/api/v1/video-jobs/progress/route";function N(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:f})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,8355,3105,2694],()=>s(353321));module.exports=r})();