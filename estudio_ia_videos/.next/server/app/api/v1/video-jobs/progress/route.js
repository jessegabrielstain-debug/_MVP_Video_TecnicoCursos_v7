"use strict";(()=>{var e={};e.id=8039,e.ids=[8039],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},27920:e=>{e.exports=require("diagnostics_channel")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},96119:e=>{e.exports=require("perf_hooks")},35816:e=>{e.exports=require("process")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},17718:e=>{e.exports=require("node:child_process")},65714:e=>{e.exports=require("node:diagnostics_channel")},15673:e=>{e.exports=require("node:events")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},85690:e=>{e.exports=require("node:inspector")},82033:e=>{e.exports=require("node:module")},87503:e=>{e.exports=require("node:net")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},51747:e=>{e.exports=require("node:readline")},84492:e=>{e.exports=require("node:stream")},31764:e=>{e.exports=require("node:tls")},47261:e=>{e.exports=require("node:util")},24086:e=>{e.exports=require("node:worker_threads")},65628:e=>{e.exports=require("node:zlib")},53321:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>q,requestAsyncStorage:()=>b,routeModule:()=>x,serverHooks:()=>v,staticGenerationAsyncStorage:()=>j});var o={};r.r(o),r.d(o,{GET:()=>g,POST:()=>f});var s=r(49303),i=r(88716),a=r(60670),n=r(87070),d=r(60354),u=r(5213),l=r(31006),p=r(40594),c=r(51842);let _=new Set(["processing","completed","failed","queued","cancelled"]),m=p.dj(e=>{if("object"==typeof e&&null!==e&&!("jobId"in e)){if(e.id)return{...e,jobId:e.id};if(e.job_id)return{...e,jobId:e.job_id}}return e},c.FR.pick({jobId:!0,progress:!0}).extend({status:c.N8.optional()}).refine(e=>!e.status||_.has(e.status),{path:["status"],message:"Status inv\xe1lido para atualiza\xe7\xe3o de progresso"}));async function f(e){try{var t,r;let o=(0,d.sR)(e),{data:s,error:i}=await o.auth.getUser();if(i||!s.user)return n.NextResponse.json({code:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});let a=(0,u.D)(`progress:${s.user.id}`,120,6e4);if(!a.allowed)return(0,l.g7)(),new n.NextResponse(JSON.stringify({code:"RATE_LIMITED",message:"Muitas requisi\xe7\xf5es de progresso. Tente novamente em breve."}),{status:429,headers:{"content-type":"application/json","Retry-After":String(a.retryAfterSec)}});let p=(t=await e.json(),m.safeParse(t));if(!p.success)return r=p.error.issues,n.NextResponse.json({code:"VALIDATION_ERROR",message:"Payload inv\xe1lido",details:r},{status:400});let{jobId:c,progress:_,status:f}=p.data,{data:g,error:x}=await o.from("render_jobs").select("id,status,user_id").eq("id",c).single();if(x||!g)return n.NextResponse.json({code:"NOT_FOUND",message:"Job n\xe3o encontrado"},{status:404});if(g.user_id&&g.user_id!==s.user.id)return n.NextResponse.json({code:"FORBIDDEN",message:"Sem permiss\xe3o para atualizar este job"},{status:403});if(!["queued","processing"].includes(g.status))return n.NextResponse.json({code:"CONFLICT",message:"Job n\xe3o pode ser atualizado neste status"},{status:409});let b={progress:_};if(f&&(b.status=f),"processing"===f){let{data:e}=await o.from("render_jobs").select("started_at").eq("id",c).single();e&&!e.started_at&&(b.started_at=new Date().toISOString())}if(("completed"===f||"failed"===f)&&(b.completed_at=new Date().toISOString()),"completed"===f){let{data:e}=await o.from("render_jobs").select("id,started_at").eq("id",c).single();if(e&&e.started_at){let t=Date.parse(e.started_at),r=Date.now()-t;b.duration_ms=r}}let{data:j,error:v}=await o.from("render_jobs").update(b).eq("id",c).select("id,status,project_id,created_at,progress,render_settings,attempts,duration_ms").single();if(v||!j)return(0,l.vJ)("DB_ERROR"),d.kg.error("video-jobs-progress","db-update-failed",v),n.NextResponse.json({code:"DB_ERROR",message:"Falha ao atualizar job",details:v?.message},{status:500});let R={id:j.id,status:j.status,project_id:j.project_id,created_at:j.created_at,progress:j.progress,attempts:j.attempts,duration_ms:j.duration_ms??null,settings:j.render_settings};return n.NextResponse.json({job:R})}catch(e){return(0,l.vJ)("UNEXPECTED"),d.kg.error("video-jobs-progress","unexpected-error",e),n.NextResponse.json({code:"UNEXPECTED",message:"Erro inesperado",details:e.message},{status:500})}}function g(){return n.NextResponse.json({code:"METHOD_NOT_ALLOWED",message:"Use POST para atualizar progresso"},{status:405})}let x=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/v1/video-jobs/progress/route",pathname:"/api/v1/video-jobs/progress",filename:"route",bundlePath:"app/api/v1/video-jobs/progress/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\video-jobs\\progress\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:b,staticGenerationAsyncStorage:j,serverHooks:v}=x,R="/api/v1/video-jobs/progress/route";function q(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:j})}},5213:(e,t,r)=>{r.d(t,{D:()=>a,U:()=>n});var o=r(87561);let s=e=>{let t=process.env.RATE_LIMIT_DEBUG_LOG;if(t)try{(0,o.appendFileSync)(t,`${JSON.stringify({ts:Date.now(),...e})}
`,{encoding:"utf-8"})}catch(e){"true"===process.env.DEBUG_RATE_LIMIT&&console.error("[rate-limit] debug log failed",e)}},i=()=>{let e=globalThis.process;if(e)return e.__app_rate_limit_store__||(e.__app_rate_limit_store__=new Map),e.__app_rate_limit_store__;let t=globalThis;return t.__app_rate_limit_store__||(t.__app_rate_limit_store__=new Map),t.__app_rate_limit_store__};function a(e,t,r){let o=i(),a=Date.now(),n=o.get(e),d=n?a-n.lastRequest:0;if(!n||d>=r&&a>=(n.blockedUntil||0))return o.set(e,{windowStart:a,lastRequest:a,count:1,blockedUntil:0}),"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] reset",{key:e,limit:t,windowMs:r,idle:d}),s({type:"reset",key:e,limit:t,windowMs:r,idle:d}),{allowed:!0,retryAfterSec:0};if((n=o.get(e)).blockedUntil&&a<n.blockedUntil){let r=Math.max(0,Math.ceil((n.blockedUntil-a)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] still-blocked",{key:e,retryAfterSec:r}),s({type:"blocked",key:e,count:n.count,limit:t,retryAfterSec:r}),n.lastRequest=a,{allowed:!1,retryAfterSec:r}}if(n.count>=t){n.blockedUntil=n.windowStart+r,n.blockedUntil<=a&&(n.blockedUntil=a+r);let o=Math.max(0,Math.ceil((n.blockedUntil-a)/1e3));return"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] blocked",{key:e,count:n.count,limit:t,retryAfterSec:o}),s({type:"blocked",key:e,count:n.count,limit:t,retryAfterSec:o}),n.lastRequest=a,{allowed:!1,retryAfterSec:o}}return n.count+=1,n.lastRequest=a,"true"===process.env.DEBUG_RATE_LIMIT&&console.info("[rate-limit] allowed",{key:e,count:n.count,limit:t,idle:d}),s({type:"allowed",key:e,count:n.count,limit:t,idle:d}),{allowed:!0,retryAfterSec:0}}function n(e){return i().get(e)}},31006:(e,t,r)=>{r.d(t,{g7:()=>s,vJ:()=>i});let o=()=>{let e=globalThis;return e.__metrics||(e.__metrics={rate_limit_hits:0,errors:{},startTime:Date.now()}),e.__metrics};function s(){let e=o();e.rate_limit_hits+=1}function i(e){let t=o();t.errors[e]=(t.errors[e]||0)+1}},51842:(e,t,r)=>{r.d(t,{FR:()=>c,N8:()=>p,SV:()=>f,gG:()=>_,kB:()=>m,l_:()=>l,xV:()=>g});var o=r(40594);let s=o.dj(e=>{if("string"==typeof e){let t=e.trim().toLowerCase();if(["true","1","yes","y"].includes(t))return!0;if(["false","0","no","n"].includes(t))return!1}return e},o.O7()),i=o.dj(e=>{if(e instanceof Date)return e;if("string"==typeof e||"number"==typeof e){let t=new Date(e);return Number.isNaN(t.getTime())?void 0:t}return e},o.hT()),a=o.Km(["1h","24h","7d","30d","all"]),n=o.Km(["1h","24h","7d","30d","90d"]),d=o.Km(["all","completed","failed","processing","pending"]),u=o.Ry({title:o.Z_().min(1,"T\xedtulo \xe9 obrigat\xf3rio"),content:o.Z_().min(1,"Conte\xfado \xe9 obrigat\xf3rio"),order_index:o.Rx().int().nonnegative()}),l=o.Ry({project_id:o.Z_().uuid("ID de projeto inv\xe1lido"),slides:o.IX(u).min(1,"Pelo menos um slide \xe9 necess\xe1rio"),tts_voice:o.Z_().optional(),quality:o.Km(["low","medium","high"]).default("medium"),flow:o.Ry({enabled:o.O7().default(!1),bpmSource:o.Km(["auto","manual"]).default("auto"),bpmManual:o.Rx().positive().optional(),beatToleranceMs:o.Rx().int().positive().max(200).default(25),crossfadeRatio:o.Rx().min(.2).max(.6).default(.35),sidechain:o.Ry({threshold:o.Rx().min(0).default(.015),ratio:o.Rx().min(1).max(10).default(4)}).optional()}).optional()}),p=o.Km(["queued","processing","completed","failed","cancelled"]),c=o.Ry({jobId:o.Z_().uuid("ID de job inv\xe1lido"),progress:o.Rx().min(0).max(100),status:p,currentStep:o.Z_().optional(),estimatedTimeRemaining:o.Rx().nonnegative().optional()});o.Ry({id:o.Z_().uuid("ID de job inv\xe1lido"),jobId:o.Z_().uuid("ID de job inv\xe1lido").optional()}),o.Ry({startDate:i.optional(),endDate:i.optional(),projectId:o.Z_().uuid("ID de projeto inv\xe1lido").optional(),groupBy:o.Km(["hour","day","week","month"]).default("day"),includeDetails:s.optional().default(!1)}).refine(e=>!e.startDate||!e.endDate||e.startDate.getTime()<=e.endDate.getTime(),{message:"startDate deve ser anterior ao endDate",path:["endDate"]});let _=o.Ry({period:o.dj(e=>"string"==typeof e?e.toLowerCase():e,a).default("7d"),includeErrors:s.optional().default(!0),includePerformance:s.optional().default(!0),limit:o.oQ.number().int().positive().max(5e3).default(5e3)}).extend({status:p.optional(),projectId:o.Z_().uuid("ID de projeto inv\xe1lido").optional()});o.Ry({eventType:o.Km(["slide_reordered","video_exported","project_created","render_started","render_completed","render_failed","user_login","user_logout"]),eventData:o.IM(o._4()),userId:o.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),sessionId:o.Z_().optional(),timestamp:o.oQ.date().default(()=>new Date)}),o.Ry({startDate:o.oQ.date(),endDate:o.oQ.date(),eventTypes:o.IX(o.Z_()).optional(),userId:o.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),limit:o.oQ.number().int().positive().max(1e3).default(100),offset:o.oQ.number().int().nonnegative().default(0)}),o.Ry({timeRange:o.dj(e=>"string"==typeof e?e.toLowerCase():e,n).default("24h"),userId:o.Z_().uuid("ID de usu\xe1rio inv\xe1lido").optional(),projectType:o.Z_().min(1).optional(),status:o.dj(e=>"string"==typeof e?e.toLowerCase():e,d).default("all"),includeErrors:s.optional().default(!0),includePerformance:s.optional().default(!0)});let m=o.dj(e=>{if("object"==typeof e&&null!==e&&!("jobId"in e)){if(e.id)return{...e,jobId:e.id};if(e.job_id)return{...e,jobId:e.job_id}}return e},o.Ry({jobId:o.Z_().uuid("ID de job inv\xe1lido"),reason:o.Z_().max(500).optional()}));o.Ry({jobId:o.Z_().uuid("ID de job inv\xe1lido"),force:s.optional().default(!1)});let f=o.Ry({jobId:o.Z_().uuid("ID de job inv\xe1lido"),priority:o.Km(["low","normal","high"]).default("normal"),resetProgress:s.optional().default(!1)}),g=o.Ry({status:p.optional(),projectId:o.Z_().uuid("ID de projeto inv\xe1lido").optional(),limit:o.oQ.number().int().positive().max(100).default(20),offset:o.oQ.number().int().nonnegative().default(0),sortBy:o.Km(["created_at","updated_at","status"]).default("created_at"),sortOrder:o.Km(["asc","desc"]).default("desc")});o.Ry({id:o.Z_().uuid(),user_id:o.Z_().uuid(),project_id:o.Z_().uuid().nullable(),status:p,progress:o.Rx().min(0).max(100),attempts:o.Rx().int().nonnegative(),created_at:o.Z_().datetime(),updated_at:o.Z_().datetime().optional(),completed_at:o.Z_().datetime().nullable(),duration_ms:o.Rx().nonnegative().nullable(),render_settings:o.IM(o._4()).nullable(),error_message:o.Z_().nullable()})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,1657,9702,9092,7686,6608,1080,3595],()=>r(53321));module.exports=o})();