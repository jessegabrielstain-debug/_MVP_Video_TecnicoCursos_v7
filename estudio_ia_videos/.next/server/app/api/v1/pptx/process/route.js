"use strict";(()=>{var e={};e.id=4398,e.ids=[4398],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},82981:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>p});var a=r(49303),o=r(88716),i=r(60670),n=r(87070),l=r(24507),c=r(8261),u=r(73004);class d{constructor(){this.parser=new u.R}async parse(e){return this.parser.parsePPTX(e)}async process(e){let{file:t}=e,r=Buffer.from(await t.arrayBuffer());return{slides:(await this.parser.parsePPTX(r)).slides}}static async validatePPTXFile(e){try{if(e.length<4)return{valid:!1,isValid:!1,error:"File too small",warnings:[]};if(!(80===e[0]&&75===e[1]))return{valid:!1,isValid:!1,error:"Invalid PPTX file format",warnings:[]};return{valid:!0,isValid:!0,warnings:[]}}catch(e){return{valid:!1,isValid:!1,error:e instanceof Error?e.message:"Validation failed",warnings:[]}}}static async processFile(e,t,r,s){try{s&&s({stage:"init",progress:0,message:"Starting processing"});let t=new d,r=await t.parse(e);s&&s({stage:"parsing",progress:50,message:"Parsed PPTX structure"});let a=r.slides||[],o=a.reduce((e,t)=>e+(t.duration||5e3),0);return s&&s({stage:"completed",progress:100,message:"Processing completed"}),{success:!0,slides:a,assets:{images:[]},timeline:{totalDuration:o},extractionStats:{slideCount:a.length,duration:o}}}catch(e){return{success:!1,slides:[],error:e instanceof Error?e.message:"Processing failed",assets:{images:[]},timeline:{totalDuration:0}}}}}async function p(e){console.log("\uD83C\uDFAF Iniciando processamento PPTX real - FASE 1...");let t=Date.now(),r={};try{let{s3Key:s,projectId:a}=r=await e.json();if(!s||!a)return n.NextResponse.json({success:!1,error:"S3 key e Project ID s\xe3o obrigat\xf3rios"},{status:400});if(console.log(`ðŸ”„ Processando projeto: ${a}, arquivo: ${s}`),await c._.project.update({where:{id:a},data:{status:"PROCESSING",processingLog:{processingStarted:new Date().toISOString(),s3Key:s,status:"processing",phase:"FASE_1_REAL_PROCESSING"}}}),!await l.f.fileExists(s))return await c._.project.update({where:{id:a},data:{status:"ERROR",processingLog:{error:"Arquivo n\xe3o encontrado no S3",failedAt:new Date().toISOString()}}}),n.NextResponse.json({success:!1,error:"Arquivo n\xe3o encontrado no S3"},{status:404});console.log("\uD83D\uDCE5 Baixando arquivo do S3...");let o=await l.f.downloadFile(s);if(!o.success||!o.buffer){let e=`Erro ao baixar arquivo: ${o.error}`;return await c._.project.update({where:{id:a},data:{status:"ERROR",processingLog:{error:e,failedAt:new Date().toISOString()}}}),n.NextResponse.json({success:!1,error:e},{status:500})}console.log(`ðŸ“¦ Arquivo baixado: ${o.buffer.length} bytes`),console.log("\uD83D\uDD0D Validando arquivo PPTX...");let i=await d.validatePPTXFile(o.buffer);if(!i.isValid){let e=`Arquivo PPTX inv\xe1lido: ${i.error||"Erro desconhecido"}`;return await c._.project.update({where:{id:a},data:{status:"ERROR",processingLog:{error:e,failedAt:new Date().toISOString()}}}),n.NextResponse.json({success:!1,error:e},{status:400})}i.warnings.length>0&&console.warn("âš ï¸ Avisos na valida\xe7\xe3o:",i.warnings),console.log("\uD83C\uDFAF Iniciando processamento real com PPTXProcessor...");let u=await d.processFile(o.buffer,a,{extractImages:!0,detectLayouts:!0,estimateDurations:!0,uploadToS3:!0,generateThumbnails:!0,maxImageSize:1920,imageQuality:85,extractHyperlinks:!0},e=>{console.log(`ðŸ“Š ${e.stage}: ${Math.round(e.progress)}% - ${e.message}`)});if(!u.success){let e=`Erro ao processar PPTX: ${u.error}`;return await c._.project.update({where:{id:a},data:{status:"ERROR",processingLog:{error:e,failedAt:new Date().toISOString()}}}),n.NextResponse.json({success:!1,error:e},{status:500})}console.log(`âœ… Processamento conclu\xeddo: ${u.slides.length} slides extra\xeddos`);let p=null;if(u.assets.images.length>0){let e=u.assets.images[0];e.s3Url&&(p=e.s3Url)}console.log("\uD83D\uDCBE Salvando dados processados no banco...");let g=Date.now()-t,f=JSON.parse(JSON.stringify(u)),m=JSON.parse(JSON.stringify({processingCompleted:new Date().toISOString(),s3Key:s,status:"completed",phase:"FASE_1_REAL_PROCESSING",slidesExtracted:u.slides.length,imagesExtracted:u.assets.images.length,totalDuration:u.timeline?.totalDuration||0,processingTime:g,extractionStats:u.extractionStats}));await c._.project.update({where:{id:a},data:{status:"COMPLETED",slidesData:f,totalSlides:u.slides.length,duration:u.timeline?Math.round(u.timeline.totalDuration/1e3):0,thumbnailUrl:p,processingLog:m}}),console.log("\uD83D\uDCC4 Criando slides individuais no banco...");for(let e=0;e<u.slides.length;e++){let t=u.slides[e],r=JSON.parse(JSON.stringify({layout:t.layout,textElements:t.textBoxes,animations:t.animations,backgroundType:t.backgroundType,images:t.images,shapes:t.shapes,audioText:t.content+(t.notes?"\n\n"+t.notes:"")}));await c._.slide.create({data:{projectId:a,title:t.title||"",content:t.content||"",orderIndex:e,duration:Math.round((t.duration||5e3)/1e3),backgroundColor:t.backgroundColor||"#FFFFFF",avatarConfig:r}})}console.log(`âœ… Processamento PPTX conclu\xeddo em ${g}ms e salvo no banco`);let h={success:!0,projectId:a,extractedContent:u,thumbnailUrl:p||void 0,processingTime:g};return n.NextResponse.json(h)}catch(a){console.error("âŒ Erro no processamento PPTX:",a);let e=a instanceof Error?a.message:"Erro interno do servidor",s=Date.now()-t;return r.projectId&&await c._.project.update({where:{id:r.projectId},data:{status:"ERROR",processingLog:{error:e,timestamp:new Date().toISOString(),phase:"FASE_1_REAL_PROCESSING",processingTime:s,failedAt:new Date().toISOString()}}}).catch(console.error),n.NextResponse.json({success:!1,error:e,processingTime:s},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/v1/pptx/process/route",pathname:"/api/v1/pptx/process",filename:"route",bundlePath:"app/api/v1/pptx/process/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\pptx\\process\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:h}=g,S="/api/v1/pptx/process/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},73004:(e,t,r)=>{r.d(t,{R:()=>n});var s=r(89190),a=r.n(s),o=r(4096);let i={title:"Untitled Presentation",author:"Unknown"};class n{constructor(){this.xmlParser=new o.Z({ignoreAttributes:!1,attributeNamePrefix:"@_",allowBooleanAttributes:!0,parseAttributeValue:!0,trimValues:!0,cdataPropName:"__cdata"})}static async validatePPTX(e){try{let t=(await a().loadAsync(e)).file(/ppt\/presentation.xml/);if(!t||0===t.length)return!1;return!0}catch(e){return!1}}async parsePPTX(e){let t;let r=await a().loadAsync(e),s=r.file("docProps/core.xml"),o=i.title,n=i.author;if(s){let e=await s.async("string"),r=this.xmlParser.parse(e)["cp:coreProperties"];r&&(o=r["dc:title"]||o,n=r["dc:creator"]||n,t=r["dc:subject"])}let l=r.file(/ppt\/presentation.xml/)[0];if(!l)throw Error("presentation.xml not found in ppt/ directory");let c=await l.async("string"),u=this.xmlParser.parse(c),d=u["p:presentation"]?.["p:sldIdLst"]??u["p:presentation"]?.["p:slideIdLst"],p=(this.isRecord(d)?d["p:sldId"]??d["p:slideId"]:void 0)||[],g=this.toArray(p),f=[];if(g.length>0)for(let[e]of g.entries()){let t=e+1,s=`ppt/slides/slide${t}.xml`,a=r.file(s);if(a)try{let e=await a.async("string"),r=this.xmlParser.parse(e),s=this.extractText(r);f.push({title:s[0]||`Slide ${t}`,content:s.slice(1).join("\n"),notes:""})}catch(e){console.warn(`Failed to parse slide ${t}:`,e)}}return{metadata:{title:o,author:n,subject:t,slideCount:f.length},slides:f}}async parseFile(e){let t=Buffer.from(await e.arrayBuffer()),r=await this.parsePPTX(t);return{title:r.metadata.title,author:r.metadata.author,slideCount:r.metadata.slideCount,totalDuration:5*r.metadata.slideCount,createdDate:new Date,theme:"default",slides:r.slides.map((e,t)=>({id:`slide-${t+1}`,slideNumber:t+1,title:e.title,content:e.content?[e.content]:[],duration:5,images:[],shapes:[],animations:[]}))}}convertToTimelineData(e){return{tracks:[{id:"track-1",type:"video",clips:e.slides.map((e,t)=>({id:`clip-${e.id}`,start:5*t,duration:5,content:e}))}]}}extractText(e){let t=[];if(!this.isRecord(e))return t;let r=this.getNested(e,["p:sld","p:cSld","p:spTree"]);if(!this.isRecord(r))return t;for(let e of this.toArray(r["p:sp"])){if(!this.isRecord(e))continue;let r=this.isRecord(e["p:txBody"])?e["p:txBody"]:void 0;if(r){for(let e of this.toArray(r["a:p"]))if(this.isRecord(e))for(let r of this.toArray(e["a:r"])){if(!this.isRecord(r))continue;let e=r["a:t"];"string"==typeof e||"number"==typeof e?t.push(String(e)):this.isRecord(e)&&"string"==typeof e.__cdata&&t.push(e.__cdata)}}}return t}isRecord(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}toArray(e){return void 0===e?[]:Array.isArray(e)?e:[e]}getNested(e,t){return t.reduce((e,t)=>{if(this.isRecord(e))return e[t]},e)}}},8261:(e,t,r)=>{r.d(t,{_:()=>a});var s=r(53524);let a=global.prisma||new s.PrismaClient({log:["error"]})},24507:(e,t,r)=>{r.d(t,{f:()=>c});var s=r(92048),a=r(55315),o=r.n(a),i=r(21841),n=r(61657);function l(){return(process.env.STORAGE_PROVIDER||"local").toLowerCase()}class c{static async deleteFile(e){if("local"===l()){let t=o().join(process.cwd(),"public","uploads",e);await s.promises.rm(t,{force:!0});return}}static async downloadFile(e){try{let t=l();if("local"===t){let t=o().join(process.cwd(),"public","uploads",e),r=await s.promises.readFile(t);return{success:!0,buffer:r}}if("supabase"===t){let t=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=process.env.SUPABASE_STORAGE_BUCKET||"public",a=(0,n.eI)(t,r),{data:o,error:i}=await a.storage.from(s).download(e);if(i||!o)return{success:!1,error:i?.message||"Download failed"};let l=await o.arrayBuffer();return{success:!0,buffer:Buffer.from(l)}}let r=process.env.AWS_REGION||"us-east-1",a=process.env.AWS_S3_BUCKET||"";if(!a)return{success:!1,error:"AWS_S3_BUCKET not configured"};let c=new i.S3Client({region:r}),u=(await c.send(new i.GetObjectCommand({Bucket:a,Key:e}))).Body,d=[];for await(let e of u)d.push(Buffer.isBuffer(e)?e:Buffer.from(e));return{success:!0,buffer:Buffer.concat(d)}}catch(e){return{success:!1,error:String(e)}}}static async fileExists(e){if("local"===l()){let t=o().join(process.cwd(),"public","uploads",e);try{await s.promises.access(t)}catch{return!1}}return!0}static async uploadFile(e,t,r){let a=l();if("local"===a){let r=o().join(process.cwd(),"public","uploads",e);return await s.promises.mkdir(o().dirname(r),{recursive:!0}),await s.promises.writeFile(r,t),`/uploads/${e}`.replace(/\\/g,"/")}if("supabase"===a){let s=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",o=process.env.SUPABASE_STORAGE_BUCKET||"public",i=(0,n.eI)(s,a),{error:l}=await i.storage.from(o).upload(e,t,{contentType:r,upsert:!0});if(l)throw l;let{data:c}=i.storage.from(o).getPublicUrl(e);return c.publicUrl}let c=process.env.AWS_REGION||"us-east-1",u=process.env.AWS_S3_BUCKET||"",d=new i.S3Client({region:c});return await d.send(new i.PutObjectCommand({Bucket:u,Key:e,Body:t,ContentType:r||"application/octet-stream"})),`https://${u}.s3.${c}.amazonaws.com/${e}`}static async getSignedUrl(e,t=3600){let r=l();if("local"===r)return`/uploads/${e}`.replace(/\\/g,"/");if("supabase"===r){let r=process.env.SUPABASE_URL||"https://ofhzrdiadxigrvmrhaiz.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"",a=process.env.SUPABASE_STORAGE_BUCKET||"public",o=(0,n.eI)(r,s),{data:i,error:l}=await o.storage.from(a).createSignedUrl(e,t);if(l||!i)throw l||Error("Failed to sign URL");return i.signedUrl}let s=process.env.AWS_REGION||"us-east-1",a=process.env.AWS_S3_BUCKET||"";return`https://${a}.s3.${s}.amazonaws.com/${e}`}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1657,9190,4096],()=>r(82981));module.exports=s})();