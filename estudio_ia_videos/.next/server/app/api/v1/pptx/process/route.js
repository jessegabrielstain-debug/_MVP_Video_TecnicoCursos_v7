"use strict";(()=>{var e={};e.id=4398,e.ids=[4398],e.modules={220399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},430517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},978893:e=>{e.exports=require("buffer")},17702:e=>{e.exports=require("events")},276162:e=>{e.exports=require("stream")},521764:e=>{e.exports=require("util")},554681:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>D,patchFetch:()=>E,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>O,staticGenerationAsyncStorage:()=>w});var o={};r.r(o),r.d(o,{POST:()=>g});var s=r(349303),a=r(88716),i=r(60670),n=r(387070),l=r(224507),c=r(707598),d=r.n(c),u=r(742707);let p={title:"Untitled Presentation",author:"Unknown"};class m{constructor(){this.xmlParser=new u.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",allowBooleanAttributes:!0,parseNodeValue:!0,parseAttributeValue:!0,trimValues:!0,cdataPropName:"__cdata"})}static async validatePPTX(e){try{let t=(await d().loadAsync(e)).file(/ppt\/presentation.xml/);if(!t||0===t.length)return!1;return!0}catch(e){return!1}}async parsePPTX(e){let t=await d().loadAsync(e),r=t.file("docProps/core.xml"),o=p.title,s=p.author;if(r){let e=await r.async("string"),t=this.xmlParser.parse(e)["cp:coreProperties"];t&&(o=t["dc:title"]||o,s=t["dc:creator"]||s)}let a=t.file(/ppt\/presentation.xml/)[0];if(!a)throw Error("presentation.xml not found in ppt/ directory");let i=await a.async("string"),n=this.xmlParser.parse(i),l=n["p:presentation"]?.["p:sldIdLst"]??n["p:presentation"]?.["p:slideIdLst"],c=(this.isRecord(l)?l["p:sldId"]??l["p:slideId"]:void 0)||[],u=this.toArray(c),m=[];if(u.length>0)for(let[e]of u.entries()){let r=e+1,o=`ppt/slides/slide${r}.xml`,s=t.file(o);if(s){let e=await s.async("string"),t=this.xmlParser.parse(e),o=this.extractText(t);m.push({title:o[0]||`Slide ${r}`,content:o.slice(1).join("\n"),notes:""})}}return{metadata:{title:o,author:s,slideCount:m.length},slides:m}}extractText(e){let t=[];if(!this.isRecord(e))return t;let r=this.getNested(e,["p:sld","p:cSld","p:spTree"]);if(!this.isRecord(r))return t;for(let e of this.toArray(r["p:sp"])){if(!this.isRecord(e))continue;let r=this.isRecord(e["p:txBody"])?e["p:txBody"]:void 0;if(r){for(let e of this.toArray(r["a:p"]))if(this.isRecord(e))for(let r of this.toArray(e["a:r"])){if(!this.isRecord(r))continue;let e=r["a:t"];"string"==typeof e||"number"==typeof e?t.push(String(e)):this.isRecord(e)&&"string"==typeof e.__cdata&&t.push(e.__cdata)}}}return t}isRecord(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}toArray(e){return void 0===e?[]:Array.isArray(e)?e:[e]}getNested(e,t){return t.reduce((e,t)=>{if(this.isRecord(e))return e[t]},e)}}class f{constructor(){this.parser=new m}async process(e){let{file:t}=e,r=await d().loadAsync(await t.arrayBuffer());return{slides:await this.parser.parse(r)}}}async function g(e){console.log("\uD83C\uDFAF Iniciando processamento PPTX real - FASE 1...");let t=Date.now();try{let{s3Key:r,projectId:o}=await e.json();if(!r||!o)return n.NextResponse.json({success:!1,error:"S3 key e Project ID s\xe3o obrigat\xf3rios"},{status:400});if(console.log(`ðŸ”„ Processando projeto: ${o}, arquivo: ${r}`),await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"PROCESSING",processingLog:{processingStarted:new Date().toISOString(),s3Key:r,status:"processing",phase:"FASE_1_REAL_PROCESSING"}}}),!await l.f.fileExists(r))return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"ERROR",errorMessage:"Arquivo n\xe3o encontrado no S3"}}),n.NextResponse.json({success:!1,error:"Arquivo n\xe3o encontrado no S3"},{status:404});console.log("\uD83D\uDCE5 Baixando arquivo do S3...");let s=await l.f.downloadFile(r);if(!s.success||!s.buffer){let e=`Erro ao baixar arquivo: ${s.error}`;return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"ERROR",errorMessage:e}}),n.NextResponse.json({success:!1,error:e},{status:500})}console.log(`ðŸ“¦ Arquivo baixado: ${s.buffer.length} bytes`),console.log("\uD83D\uDD0D Validando arquivo PPTX...");let a=await f.validatePPTXFile(s.buffer);if(!a.isValid){let e=`Arquivo PPTX inv\xe1lido: ${a.errors.join(", ")}`;return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"ERROR",errorMessage:e}}),n.NextResponse.json({success:!1,error:e},{status:400})}a.warnings.length>0&&console.warn("âš ï¸ Avisos na valida\xe7\xe3o:",a.warnings),console.log("\uD83C\uDFAF Iniciando processamento real com PPTXProcessor...");let i=await f.processFile(s.buffer,o,{extractImages:!0,detectLayouts:!0,estimateDurations:!0,uploadToS3:!0,generateThumbnails:!0,maxImageSize:1920,imageQuality:85,extractHyperlinks:!0},e=>{console.log(`ðŸ“Š ${e.stage}: ${Math.round(e.progress)}% - ${e.message}`)});if(!i.success){let e=`Erro ao processar PPTX: ${i.error}`;return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"ERROR",errorMessage:e}}),n.NextResponse.json({success:!1,error:e},{status:500})}console.log(`âœ… Processamento conclu\xeddo: ${i.slides.length} slides extra\xeddos`);let c=null;if(i.assets.images.length>0){let e=i.assets.images[0];e.s3Url&&(c=e.s3Url)}console.log("\uD83D\uDCBE Salvando dados processados no banco...");let d=Date.now()-t;for(let e of(await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:o},data:{status:"COMPLETED",slidesData:i,totalSlides:i.slides.length,duration:i.timeline?Math.round(i.timeline.totalDuration/1e3):0,thumbnailUrl:c,processingLog:{processingCompleted:new Date().toISOString(),s3Key:r,status:"completed",phase:"FASE_1_REAL_PROCESSING",slidesExtracted:i.slides.length,imagesExtracted:i.assets.images.length,totalDuration:i.timeline?.totalDuration||0,processingTime:d,extractionStats:i.extractionStats}}}),console.log("\uD83D\uDCC4 Criando slides individuais no banco..."),i.slides))await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).slide.create({data:{projectId:o,title:e.title,content:e.content,slideNumber:e.slideNumber,duration:e.duration/1e3,audioText:e.content+(e.notes?"\n\n"+e.notes:""),elements:{layout:e.layout,textElements:e.textBoxes,animations:e.animations,backgroundType:e.backgroundType,backgroundColor:e.backgroundColor,images:e.images,shapes:e.shapes}}});console.log(`âœ… Processamento PPTX conclu\xeddo em ${d}ms e salvo no banco`);let u={success:!0,projectId:o,extractedContent:i,thumbnailUrl:c||void 0,processingTime:d};return n.NextResponse.json(u)}catch(a){console.error("âŒ Erro no processamento PPTX:",a);let r=a instanceof Error?a.message:"Erro interno do servidor",o=Date.now()-t,s=await e.json().catch(()=>({}));return s.projectId&&await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).project.update({where:{id:s.projectId},data:{status:"ERROR",errorMessage:r,processingLog:{error:r,timestamp:new Date().toISOString(),phase:"FASE_1_REAL_PROCESSING",processingTime:o,failedAt:new Date().toISOString()}}}).catch(console.error),n.NextResponse.json({success:!1,error:r,processingTime:o},{status:500})}}!function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}();let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/v1/pptx/process/route",pathname:"/api/v1/pptx/process",filename:"route",bundlePath:"app/api/v1/pptx/process/route"},resolvedPagePath:"C:\\xampp\\htdocs\\_MVP_Video_TecnicoCursos_v7\\estudio_ia_videos\\app\\api\\v1\\pptx\\process\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:O}=h,D="/api/v1/pptx/process/route";function E(){return(0,i.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:w})}},224507:(e,t,r)=>{r.d(t,{f:()=>o});class o{}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,8835],()=>r(554681));module.exports=o})();