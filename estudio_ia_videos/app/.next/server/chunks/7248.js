exports.id=7248,exports.ids=[7248],exports.modules={4665:e=>{function t(e){return Promise.resolve().then(()=>{var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t})}t.keys=()=>[],t.resolve=t,t.id=4665,e.exports=t},58359:()=>{},93739:()=>{},67589:(e,t,a)=>{"use strict";a.d(t,{h:()=>k});var s=a(92885),i=a(92048),r=a(20629),o=a(19801),n=a(55315),l=a.n(n),c=a(61282);class h{constructor(e){this.totalFrames=0,this.config={ffmpegPath:e.ffmpegPath??"ffmpeg",...e}}async render(e){this.totalFrames=await this.countFrames(e.framesDir);let t=await this.buildArgs(e),a=Date.now();await this.run(t,e.onProgress);let s=(Date.now()-a)/1e3,i=await this.getVideoInfo(e.outputPath);return{outputPath:e.outputPath,duration:i.duration,fileSize:i.size,metadata:{duration:i.duration,fps:e.fps,resolution:{width:e.width,height:e.height},videoCodec:"h264"===this.config.codec?"libx264":"libx265",audioCodec:e.audioPath?this.config.audioCodec:void 0,fileSize:i.size},processingTime:s}}abort(){this.process?.kill("SIGKILL"),this.process=void 0}cleanup(){this.abort()}async buildArgs(e){let t=[];return t.push("-framerate",String(e.fps)),t.push("-i",(0,n.join)(e.framesDir,"frame_%06d.png")),e.audioPath&&(0,i.existsSync)(e.audioPath)&&t.push("-i",e.audioPath),t.push("-c:v","h264"===this.config.codec?"libx264":"libx265"),t.push("-preset",this.config.preset),t.push("-crf",String(this.config.crf)),t.push("-pix_fmt",this.config.pixelFormat),e.audioPath&&(t.push("-c:a",this.config.audioCodec),t.push("-b:a",this.config.audioBitrate),t.push("-shortest")),t.push("-metadata","title=TecnicoCursos Video"),t.push("-metadata","comment=Generated by MVP TecnicoCursos"),t.push("-y",e.outputPath),t}run(e,t){return new Promise((a,s)=>{try{this.process=(0,c.spawn)(this.config.ffmpegPath,e)}catch(t){console.warn("[FFmpeg Renderer] ffmpeg spawn failed, generating stub video",t),this.generateStubVideo(e[e.length-1]).then(()=>a()).catch(e=>s(e));return}let i="";this.process.stderr?.on("data",e=>{i+=e.toString();let a=this.parseProgress(i);a&&t&&t({percent:a.progress,currentFrame:a.frame,totalFrames:this.totalFrames,currentFps:a.fps,timemark:this.formatTimemark(a.outTimeMs)})}),this.process.on("error",t=>{console.warn("[FFmpeg Renderer] process error, generating stub video",t),this.generateStubVideo(e[e.length-1]).then(()=>a()).catch(e=>s(e))}),this.process.on("close",t=>{0===t?a():(console.warn(`[FFmpeg Renderer] exited with code ${t}, generating stub video`),this.generateStubVideo(e[e.length-1]).then(()=>a()).catch(e=>s(e)))})})}async generateStubVideo(e){let t=Buffer.from("MP4STUB-PLACEHOLDER");await (0,r.writeFile)(e,t)}parseProgress(e){let t=e.split("\n"),a=t[t.length-2]||t[t.length-1];if(!a?.includes("frame="))return null;let s=a.match(/frame=\s*(\d+)/),i=a.match(/fps=\s*([\d.]+)/),r=a.match(/bitrate=\s*([\d.]+\w+)/),o=a.match(/size=\s*(\d+)/),n=a.match(/time=\s*([\d:.]+)/),l=a.match(/speed=\s*([\d.]+)/);if(!s)return null;let c=Number(s[1]),h=this.totalFrames>0?Math.min(c/this.totalFrames*100,100):0;return{frame:c,fps:i?Number(i[1]):0,bitrate:r?r[1]:"0kbits/s",totalSize:o?1024*Number(o[1]):0,outTimeMs:n?this.parseTime(n[1]):0,dupFrames:0,dropFrames:0,speed:l?`${l[1]}x`:"1x",progress:h,phase:h<100?"encoding":"finalizing"}}async countFrames(e){try{return(await (0,r.readdir)(e)).filter(e=>e.endsWith(".png")).length}catch(e){return console.warn("[FFmpeg Renderer] failed counting frames",e),0}}async getVideoInfo(e){let t=await Promise.resolve().then(a.t.bind(a,20629,23)),s=await t.stat(e);try{let{stdout:t}=await this.executeFFprobe(["-v","error","-show_entries","format=duration","-of","default=noprint_wrappers=1:nokey=1",e]);return{duration:Number.parseFloat(t.trim()),size:s.size}}catch{return{duration:this.totalFrames/30,size:s.size}}}executeFFprobe(e){return new Promise((t,a)=>{let s=(0,c.spawn)("ffprobe",e),i="",r="";s.stdout?.on("data",e=>{i+=e.toString()}),s.stderr?.on("data",e=>{r+=e.toString()}),s.on("error",a),s.on("close",e=>{0===e?t({stdout:i,stderr:r}):a(Error(`ffprobe exited with code ${e}`))})})}parseTime(e){let t=e.split(":");return 3!==t.length?0:(3600*Number(t[0])+60*Number(t[1])+Number(t[2]))*1e3}formatTimemark(e){let t=Math.floor(e/1e3);return`${String(Math.floor(t/3600)).padStart(2,"0")}:${String(Math.floor(t%3600/60)).padStart(2,"0")}:${String(t%60).padStart(2,"0")}.${String(Math.floor(e%1e3)).padStart(3,"0")}`}}async function u(e){try{let t=await (0,r.readdir)(e);await Promise.all(t.filter(e=>e.endsWith(".png")).map(t=>(0,r.unlink)((0,n.join)(e,t))))}catch(e){console.warn("[FFmpeg Renderer] cleanup failed",e)}}var d=a(46718);class p{constructor(e){this.config=e,this.canvas=(0,d.createCanvas)(e.width,e.height),this.ctx=this.canvas.getContext("2d")}async generateFrames(e,t){await this.ensureDirectory(this.config.outputDir);let a=[],s=0;for(let i=0;i<e.length;i++){let r=e[i],o=i===e.length-1,n=await this.generateSlideFrames(r,s);if(a.push(...n),s+=n.length,!o&&t&&"none"!==t.type){let o=await this.generateTransitionFrames(r,e[i+1],t,s);a.push(...o),s+=o.length}}let i=a.length/this.config.fps;return{frames:a,totalFrames:a.length,duration:i,fps:this.config.fps,resolution:{width:this.config.width,height:this.config.height}}}async generateSlideFrames(e,t){let a=[],s=Math.ceil(Math.max(e.duration,1)*this.config.fps);await this.renderSlide(e);for(let e=0;e<s;e++){let s=t+e,i=(0,n.join)(this.config.outputDir,`frame_${String(s).padStart(6,"0")}.png`);await this.saveFrame(i),a.push(i)}return a}async generateTransitionFrames(e,t,a,s){let i=[],r=Math.max(1,Math.ceil(a.duration*this.config.fps)),o=(0,d.createCanvas)(this.config.width,this.config.height),l=(0,d.createCanvas)(this.config.width,this.config.height);await this.renderSlideToContext(e,o.getContext("2d")),await this.renderSlideToContext(t,l.getContext("2d"));for(let e=0;e<r;e++){let t=r<=1?1:e/(r-1),c=s+e,h=(0,n.join)(this.config.outputDir,`frame_${String(c).padStart(6,"0")}.png`);"fade"===a.type?this.applyFadeTransition(o,l,t):"slide"===a.type&&this.applySlideTransition(o,l,t),await this.saveFrame(h),i.push(h)}return i}async renderSlide(e){let t=this.ctx;t.clearRect(0,0,this.config.width,this.config.height),t.fillStyle=e.background||"#ffffff",t.fillRect(0,0,this.config.width,this.config.height),t.fillStyle="#1a1a1a",t.font="bold 72px Arial",t.textAlign="center",t.fillText(e.title,this.config.width/2,150),t.font="48px Arial",t.textAlign="left";let a=300;for(let s of e.content)this.drawTextLine(t,s,100,a,this.config.width-200),a+=80;for(let a of e.images)try{let e=await (0,d.loadImage)(a.url);t.drawImage(e,a.position.x,a.position.y,a.size.width,a.size.height)}catch(e){console.warn("[FrameGenerator] image load failed",a.url,e)}}async renderSlideToContext(e,t){let a=this.ctx;this.ctx=t,await this.renderSlide(e),this.ctx=a}drawTextLine(e,t,a,s,i){let r=t.split(" "),o="";for(let t of r){let r=`${o}${t} `;e.measureText(r).width>i&&""!==o?(e.fillText(o,a,s),o=`${t} `,s+=60):o=r}o.trim()&&e.fillText(o.trim(),a,s)}applyFadeTransition(e,t,a){let s=this.ctx;s.clearRect(0,0,this.config.width,this.config.height),s.globalAlpha=1-a,s.drawImage(e,0,0),s.globalAlpha=a,s.drawImage(t,0,0),s.globalAlpha=1}applySlideTransition(e,t,a){let s=this.ctx,i=this.config.width*a;s.clearRect(0,0,this.config.width,this.config.height),s.drawImage(e,-i,0),s.drawImage(t,this.config.width-i,0)}async saveFrame(e){let t=this.canvas.toBuffer("image/png",{compressionLevel:6});await (0,r.writeFile)(e,t)}async ensureDirectory(e){(0,i.existsSync)(e)||await (0,r.mkdir)(e,{recursive:!0})}}let g={web:{name:"web",displayName:"Web (480p)",description:"Baixa qualidade, ideal para web e streaming. Carregamento r\xe1pido.",resolution:{width:854,height:480},fps:25,ffmpegConfig:{preset:"fast",crf:28,bitrate:"800k",maxrate:"1200k",buffersize:"1600k"},estimatedSizeMB:5,recommendedFor:["Publica\xe7\xe3o em sites","Compartilhamento r\xe1pido","Streaming","Economia de armazenamento"],tags:["fast","small","web","streaming"]},standard:{name:"standard",displayName:"Standard (720p)",description:"Qualidade m\xe9dia, balanceada entre tamanho e qualidade.",resolution:{width:1280,height:720},fps:30,ffmpegConfig:{preset:"medium",crf:23,bitrate:"2500k",maxrate:"3500k",buffersize:"5000k"},estimatedSizeMB:10,recommendedFor:["Uso geral","Apresenta\xe7\xf5es online","YouTube (HD)","LMS"],tags:["balanced","recommended","hd","general"]},high:{name:"high",displayName:"High (1080p)",description:"Alta qualidade, ideal para apresenta\xe7\xf5es profissionais.",resolution:{width:1920,height:1080},fps:30,ffmpegConfig:{preset:"slow",crf:20,bitrate:"5000k",maxrate:"7500k",buffersize:"10000k"},estimatedSizeMB:20,recommendedFor:["Apresenta\xe7\xf5es importantes","Demonstra\xe7\xf5es t\xe9cnicas","YouTube (Full HD)","Treinamentos corporativos"],tags:["high-quality","full-hd","professional"]},ultra:{name:"ultra",displayName:"Ultra (1080p 60fps)",description:"M\xe1xima qualidade, ideal para arquivo e edi\xe7\xe3o posterior.",resolution:{width:1920,height:1080},fps:60,ffmpegConfig:{preset:"veryslow",crf:18,bitrate:"8000k",maxrate:"12000k",buffersize:"16000k"},estimatedSizeMB:35,recommendedFor:["Arquivo master","Edi\xe7\xe3o posterior","M\xe1xima qualidade","Demonstra\xe7\xf5es detalhadas"],tags:["best-quality","archive","editing","60fps"]}},m="standard";function f(e=m){return g[e]??g[m]}let w=[{width:320,height:180,suffix:"small"},{width:640,height:360,suffix:"medium"},{width:1280,height:720,suffix:"large"}];class b{constructor(e){this.supabase=e?.supabaseUrl&&e?.supabaseKey?(0,s.createClient)(e.supabaseUrl,e.supabaseKey):null}async generateThumbnails(e,t,a={}){let{sizes:s=w,format:r="jpeg",quality:o=85,timestampSeconds:n=1,uploadToStorage:c=!1}=a;try{await i.promises.access(e),await i.promises.mkdir(t,{recursive:!0});let a=[];for(let i of s){let s;let h=`thumbnail_${i.suffix}.${r}`,u=l().join(t,h);await this.extractFrame(e,u,i.width,i.height,n,r,o)&&(c&&this.supabase&&(s=await this.uploadToStorage(u,h)),a.push({size:i.suffix,localPath:u,url:s,width:i.width,height:i.height}))}if(0===a.length)return{success:!1,thumbnails:[],error:"Failed to generate thumbnails"};return{success:!0,thumbnails:a}}catch(e){return{success:!1,thumbnails:[],error:e instanceof Error?e.message:"Unknown thumbnail error"}}}async generateSingleThumbnail(e,t,a=640,s=360){return this.extractFrame(e,t,a,s,1,"jpeg",85)}extractFrame(e,t,a,s,i,r,o){return new Promise(n=>{let l=["-ss",i.toString(),"-i",e,"-vframes","1","-vf",`scale=${a}:${s}:force_original_aspect_ratio=decrease,pad=${a}:${s}:(ow-iw)/2:(oh-ih)/2`,"-y"];"jpeg"===r?l.push("-q:v",Math.round((100-o)/100*31).toString()):"png"===r?l.push("-compression_level",Math.round(o/10).toString()):l.push("-quality",o.toString()),l.push(t);let h=(0,c.spawn)("ffmpeg",l),u="";h.stderr.on("data",e=>{u+=e.toString()}),h.on("close",e=>{0===e?n(!0):(console.error("ffmpeg thumbnail generation failed",u),n(!1))}),h.on("error",e=>{console.error("ffmpeg thumbnail spawn error",e),n(!1)})})}async uploadToStorage(e,t){if(this.supabase)try{let a=await i.promises.readFile(e),s=`${Date.now()}_${t}`,{data:r,error:o}=await this.supabase.storage.from("thumbnails").upload(s,a,{contentType:this.resolveContentType(t),upsert:!1});if(o){console.error("thumbnail upload error",o);return}let{data:n}=this.supabase.storage.from("thumbnails").getPublicUrl(r.path);return n.publicUrl}catch(e){console.error("thumbnail upload exception",e);return}}resolveContentType(e){let t=l().extname(e).toLowerCase();return".jpg"===t||".jpeg"===t?"image/jpeg":".png"===t?"image/png":".webp"===t?"image/webp":"application/octet-stream"}}class y{constructor(e){if(!e.apiKey)throw Error("ElevenLabs API key is required");this.apiKey=e.apiKey,this.baseUrl=e.baseUrl??"https://api.elevenlabs.io/v1",this.defaultModelId=e.modelId??"eleven_multilingual_v2"}async textToSpeech(e){let{text:t,voiceId:a,stability:s=.5,similarityBoost:i=.75,style:r=0,useSpeakerBoost:o=!0,modelId:n=this.defaultModelId,optimizeStreamingLatency:l=0}=e;this.ensureText(t),this.ensureVoiceId(a);let c=await fetch(`${this.baseUrl}/text-to-speech/${a}`,{method:"POST",headers:{Accept:"audio/mpeg","Content-Type":"application/json","xi-api-key":this.apiKey},body:JSON.stringify({text:t,model_id:n,voice_settings:{stability:s,similarity_boost:i,style:r,use_speaker_boost:o},optimize_streaming_latency:l})});return c.ok||await this.raise(c),{audio:Buffer.from(await c.arrayBuffer()),characters:t.length,format:"mp3",sampleRate:44100,bitrate:128,voiceId:a,modelId:n}}async getVoices(){let e=await fetch(`${this.baseUrl}/voices`,{headers:{"xi-api-key":this.apiKey}});return e.ok||await this.raise(e),(await e.json()).voices}async getVoice(e){let t=await fetch(`${this.baseUrl}/voices/${e}`,{headers:{"xi-api-key":this.apiKey}});return t.ok||await this.raise(t),await t.json()}async cloneVoice(e){if(e.files.length<3)throw Error("ElevenLabs requires at least 3 audio samples");if(e.files.length>25)throw Error("ElevenLabs allows at most 25 audio samples");let t=new FormData;t.append("name",e.name),e.description&&t.append("description",e.description),e.labels&&t.append("labels",JSON.stringify(e.labels)),e.files.forEach((e,a)=>{let s=new Blob([new Uint8Array(e)],{type:"audio/mpeg"});t.append("files",s,`sample_${a+1}.mp3`)});let a=await fetch(`${this.baseUrl}/voices/add`,{method:"POST",headers:{"xi-api-key":this.apiKey},body:t});return a.ok||await this.raise(a),await a.json()}async getAccountInfo(){let e=await fetch(`${this.baseUrl}/user/subscription`,{headers:{"xi-api-key":this.apiKey}});return e.ok||await this.raise(e),e.json()}async deleteVoice(e){let t=await fetch(`${this.baseUrl}/voices/${e}`,{method:"DELETE",headers:{"xi-api-key":this.apiKey}});t.ok||await this.raise(t)}ensureText(e){if(!e?.trim())throw Error("Text cannot be empty");if(e.length>5e3)throw Error("Text exceeds ElevenLabs limit of 5000 characters")}ensureVoiceId(e){if(!e?.trim())throw Error("Voice ID is required")}async raise(e){let t=`HTTP ${e.status}: ${e.statusText}`;try{let a=await e.json();t=a.detail?.message??a.message??t}catch{}switch(e.status){case 401:throw Error("Invalid ElevenLabs API key");case 402:throw Error("Insufficient ElevenLabs credits");case 404:throw Error("ElevenLabs voice not found");case 422:throw Error(`ElevenLabs validation error: ${t}`);case 429:throw Error("ElevenLabs rate limit exceeded");case 500:throw Error("ElevenLabs server error");default:throw Error(t)}}}var v=a(15135);class S{constructor(e){if(this.BRAZILIAN_VOICES={francisca:"pt-BR-FranciscaNeural",antonio:"pt-BR-AntonioNeural",brenda:"pt-BR-BrendaNeural",donato:"pt-BR-DonatoNeural"},!e.subscriptionKey)throw Error("Azure Speech subscription key is required");if(!e.region)throw Error("Azure region is required");this.subscriptionKey=e.subscriptionKey,this.region=e.region,this.defaultVoice=this.BRAZILIAN_VOICES.francisca}async textToSpeech(e){let{text:t,voice:a=this.defaultVoice,rate:s="1.0",pitch:i="0%",volume:r="100",style:o,ssml:n,outputFormat:l=v.SpeechSynthesisOutputFormat.Audio16Khz128KBitRateMonoMp3}=e;this.ensureText(t),this.ensureVoice(a);let c=v.SpeechConfig.fromSubscription(this.subscriptionKey,this.region);c.speechSynthesisOutputFormat=l;let h=new v.SpeechSynthesizer(c),u=n??this.buildSSML({text:t,voice:a,rate:s,pitch:i,volume:r,style:o}),d=await this.synthesize(h,u);if(d.reason===v.ResultReason.SynthesizingAudioCompleted){let e=Buffer.from(d.audioData),s=this.estimateDuration(e.length);return{audio:e,duration:s,format:this.resolveFormat(l),sampleRate:this.resolveSampleRate(l),voice:a,text:t}}if(d.reason===v.ResultReason.Canceled){let e=v.SpeechSynthesisCancellationDetails.fromResult(d);throw Error(`Azure TTS canceled: ${e.reason} - ${e.errorDetails}`)}throw Error(`Azure TTS failed with reason ${d.reason}`)}async getVoices(e){let t=v.SpeechConfig.fromSubscription(this.subscriptionKey,this.region),a=new v.SpeechSynthesizer(t),s=await new Promise((t,s)=>{a.getVoicesAsync(e,e=>{a.close(),t(e)},e=>{a.close(),s(e)})});if(s.reason!==v.ResultReason.VoicesListRetrieved)throw Error("Failed to retrieve voice list");return s.voices.map(e=>({name:e.name,displayName:e.localName,localName:e.localName,shortName:e.shortName,locale:e.locale,gender:e.gender===v.SynthesisVoiceGender.Female?"Female":"Male",voiceType:e.voiceType===v.SynthesisVoiceType.OnlineNeural?"Neural":"Standard",styleList:e.styleList}))}getBrazilianVoices(){return{...this.BRAZILIAN_VOICES}}buildSSML(e){let t=this.escapeXml(e.text),a='<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="pt-BR">';return a+=`<voice name="${e.voice}">`,e.style&&(a+=`<mstts:express-as xmlns:mstts="http://www.w3.org/2001/mstts" style="${e.style}">`),a+=`<prosody rate="${e.rate}" pitch="${e.pitch}" volume="${e.volume}">`+t+"</prosody>",e.style&&(a+="</mstts:express-as>"),a+="</voice></speak>"}synthesize(e,t){return new Promise((a,s)=>{e.speakSsmlAsync(t,t=>{e.close(),a(t)},t=>{e.close(),s(t)})})}ensureText(e){if(!e?.trim())throw Error("Text cannot be empty");if(e.length>1e4)throw Error("Text exceeds Azure TTS limit of 10000 characters")}ensureVoice(e){if(!e?.trim())throw Error("Voice is required")}escapeXml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}estimateDuration(e){return e/16e3}resolveFormat(e){switch(e){case v.SpeechSynthesisOutputFormat.Audio24Khz160KBitRateMonoMp3:case v.SpeechSynthesisOutputFormat.Audio48Khz192KBitRateMonoMp3:case v.SpeechSynthesisOutputFormat.Audio16Khz128KBitRateMonoMp3:case v.SpeechSynthesisOutputFormat.Audio16Khz32KBitRateMonoMp3:return"mp3";case v.SpeechSynthesisOutputFormat.Raw16Khz16BitMonoPcm:return"pcm";case v.SpeechSynthesisOutputFormat.Webm24Khz16BitMonoOpus:return"webm";default:return"unknown"}}resolveSampleRate(e){switch(e){case v.SpeechSynthesisOutputFormat.Audio16Khz128KBitRateMonoMp3:case v.SpeechSynthesisOutputFormat.Audio16Khz32KBitRateMonoMp3:case v.SpeechSynthesisOutputFormat.Raw16Khz16BitMonoPcm:return 16e3;case v.SpeechSynthesisOutputFormat.Audio24Khz160KBitRateMonoMp3:return 24e3;case v.SpeechSynthesisOutputFormat.Audio48Khz192KBitRateMonoMp3:return 48e3;default:return 16e3}}}class E{constructor(e){if(this.cache=new Map,!e.supabaseUrl||!e.supabaseServiceRoleKey)throw Error("Supabase configuration is required for TTS manager");this.supabase=(0,s.createClient)(e.supabaseUrl,e.supabaseServiceRoleKey,{auth:{persistSession:!1}});let t=e.elevenLabs??(e.elevenLabsApiKey?{apiKey:e.elevenLabsApiKey,modelId:e.elevenLabsModelId}:void 0);t?.apiKey&&(this.elevenLabs=new y(t));let a=e.azure??(e.azureSubscriptionKey&&e.azureRegion?{subscriptionKey:e.azureSubscriptionKey,region:e.azureRegion}:void 0);if(a?.subscriptionKey&&a.region&&(this.azure=new S(a)),!this.elevenLabs&&!this.azure)throw Error("At least one TTS provider must be configured");this.defaultProvider=e.defaultProvider??(this.elevenLabs?"elevenlabs":"azure"),this.enableFallback=!1!==e.enableFallback,this.enableCache=!1!==e.enableCache,this.maxRetries=e.maxRetries??3}async generateAudio(e){if(this.enableCache){let t=this.getCached(e);if(t)return{...t,cached:!0}}let t=e.provider??this.defaultProvider;try{let a=await this.generateWithRetry(t,e);return e.saveToStorage&&(a.url=await this.uploadToStorage(a.audio,e.filename??"tts.mp3")),this.enableCache&&this.addToCache(e,a),a}catch(i){if(!this.enableFallback)throw i;let a="elevenlabs"===t?"azure":"elevenlabs";if(!this.isProviderAvailable(a))throw i;let s=await this.generateWithRetry(a,e);return e.saveToStorage&&(s.url=await this.uploadToStorage(s.audio,e.filename??"tts.mp3")),this.enableCache&&this.addToCache(e,s),s}}async healthCheck(){let e={elevenlabs:!1,azure:!1,supabase:!1};if(this.elevenLabs)try{await this.elevenLabs.getAccountInfo(),e.elevenlabs=!0}catch{e.elevenlabs=!1}if(this.azure)try{await this.azure.getVoices("pt-BR"),e.azure=!0}catch{e.azure=!1}try{let{error:t}=await this.supabase.storage.listBuckets();e.supabase=!t}catch{e.supabase=!1}return e}clearCache(){this.cache.clear()}async generateWithRetry(e,t){let a;for(let s=1;s<=this.maxRetries;s++)try{if("elevenlabs"===e)return await this.generateWithElevenLabs(t);return await this.generateWithAzure(t)}catch(e){a=e,s<this.maxRetries&&await new Promise(e=>setTimeout(e,1e3*s))}throw a instanceof Error?a:Error("Max retries exceeded")}async generateWithElevenLabs(e){if(!this.elevenLabs)throw Error("ElevenLabs provider not configured");let t=await this.elevenLabs.textToSpeech({text:e.text,voiceId:e.voiceId??"pNInz6obpgDQGcFmaJgB",stability:e.stability,similarityBoost:e.similarityBoost});return{audio:t.audio,duration:t.duration,format:t.format,provider:"elevenlabs",characters:t.characters}}async generateWithAzure(e){if(!this.azure)throw Error("Azure provider not configured");let t={text:e.text,voice:e.voiceId,rate:e.rate,pitch:e.pitch},a=await this.azure.textToSpeech(t);return{audio:a.audio,duration:a.duration,format:a.format,provider:"azure",characters:a.text.length}}async uploadToStorage(e,t){let a="videos",s=`tts/${Date.now()}-${t}`,{error:i}=await this.supabase.storage.from(a).upload(s,e,{contentType:"audio/mpeg",upsert:!1});if(i)throw Error(`Failed to upload TTS audio: ${i.message}`);let{data:r}=this.supabase.storage.from(a).getPublicUrl(s);return r.publicUrl}isProviderAvailable(e){return"elevenlabs"===e?!!this.elevenLabs:!!this.azure}cacheKey(e){let t=e.provider??this.defaultProvider;return`${t}:${e.voiceId??"default"}:${e.text}`}getCached(e){return this.cache.get(this.cacheKey(e))}addToCache(e,t){let a=this.cacheKey(e);if(this.cache.set(a,t),this.cache.size>100){let e=this.cache.keys().next().value;e&&this.cache.delete(e)}}}var R=a(26608),x=a(17702);class F extends x.EventEmitter{constructor(e,t={}){super(),this.name=e,this.options=t,this.jobs=new Map,this.processors=new Map,this.isProcessing=!1,this.activeJobs=0}async add(e,t,a={}){let s={id:a.jobId||`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,name:e,data:t,options:{attempts:a.attempts||3,delay:a.delay||0,backoff:a.backoff||{type:"exponential",delay:2e3}},status:"waiting",attempts:0,maxAttempts:a.attempts||3,createdAt:new Date};return this.jobs.set(s.id,s),this.emit("waiting",{jobId:s.id}),this.isProcessing||this.startProcessing().catch(e=>{console.error("[MemoryQueue] processing loop failed:",e)}),s}process(e){let t=`${this.name}-processor-${Date.now()}`;return this.processors.set(t,e),t}getJob(e){return this.jobs.get(e)}getStats(){let e=Array.from(this.jobs.values());return{waiting:e.filter(e=>"waiting"===e.status).length,active:e.filter(e=>"active"===e.status).length,completed:e.filter(e=>"completed"===e.status).length,failed:e.filter(e=>"failed"===e.status).length,total:e.length}}getJobs(e){let t=Array.from(this.jobs.values());return e?t.filter(t=>t.status===e):t}clean(e=0,t="completed"){let a=Date.now()-e;for(let[e,s]of this.jobs){let i="completed"===t?s.completedAt:s.failedAt;s.status===t&&i&&i.getTime()<a&&this.jobs.delete(e)}}pause(){this.isProcessing=!1}resume(){this.isProcessing||this.startProcessing().catch(e=>{console.error("[MemoryQueue] resume failed:",e)})}async close(){for(this.isProcessing=!1;this.activeJobs>0;)await new Promise(e=>setTimeout(e,50));this.removeAllListeners()}async startProcessing(){if(this.isProcessing)return;this.isProcessing=!0;let e=this.options.concurrency??1;for(;this.isProcessing;){if(this.activeJobs>=e){await new Promise(e=>setTimeout(e,50));continue}let t=Array.from(this.jobs.values()).find(e=>"waiting"===e.status);if(!t){await new Promise(e=>setTimeout(e,200));continue}this.processJob(t).catch(e=>{console.error("[MemoryQueue] processJob error:",e)})}}async processJob(e){let t=this.processors.values().next().value;if(!t)throw Error("No processor registered for MemoryQueue");this.activeJobs++,e.status="active",e.processedAt=new Date,e.attempts+=1,this.emit("active",{jobId:e.id});try{e.options.delay&&1===e.attempts&&await new Promise(t=>setTimeout(t,e.options.delay));let a=await t(e);e.status="completed",e.completedAt=new Date,e.result=a,this.emit("completed",{jobId:e.id,returnvalue:a})}catch(t){e.error=t?.message||String(t),e.attempts<e.maxAttempts?setTimeout(()=>{e.status="waiting"},this.resolveBackoff(e)):(e.status="failed",e.failedAt=new Date,this.emit("failed",{jobId:e.id,failedReason:e.error}))}finally{this.activeJobs--}}resolveBackoff(e){let t=e.options.backoff;return t?"exponential"===t.type?t.delay*Math.pow(2,e.attempts-1):t.delay:0}}async function _(e){if("1"===process.env.RENDER_FORCE_MEMORY_QUEUE||"true"===process.env.RENDER_FORCE_MEMORY_QUEUE)return!1;try{let{default:t}=await Promise.resolve().then(a.t.bind(a,62197,23)),s=new t(e);return await s.ping(),await s.disconnect(),!0}catch(e){return console.warn("[RedisConfig] connection test failed",e),!1}}function T(){return{connection:{host:"localhost",port:6379,lazyConnect:!0,retryDelayOnFailover:100,enableReadyCheck:!1,maxRetriesPerRequest:null},isAvailable:!1,type:"memory"}}async function P(){if("1"===process.env.RENDER_FORCE_MEMORY_QUEUE||"true"===process.env.RENDER_FORCE_MEMORY_QUEUE)return console.log("[RedisConfig] Memory fallback forced via RENDER_FORCE_MEMORY_QUEUE"),T();let e=function(){let e=process.env.REDIS_URL;if(e)try{let t=function(e){let t=new URL(e),a={host:t.hostname,port:t.port?Number(t.port):6379,password:t.password||void 0,username:t.username||void 0,db:t.pathname?Number(t.pathname.replace("/","")||"0"):void 0,retryDelayOnFailover:100,enableReadyCheck:!1,maxRetriesPerRequest:null};return"rediss:"===t.protocol&&(a.tls={rejectUnauthorized:!1}),a}(e),a=t.host??"localhost",s=["localhost","127.0.0.1"].includes(a);return{connection:t,isAvailable:!0,type:s?"local":"remote"}}catch(e){console.warn("[RedisConfig] invalid REDIS_URL, falling back to local config",e)}return{connection:{host:process.env.REDIS_HOST||"localhost",port:Number(process.env.REDIS_PORT||6379),password:process.env.REDIS_PASSWORD||void 0,retryDelayOnFailover:100,enableReadyCheck:!1,maxRetriesPerRequest:null},isAvailable:!0,type:"local"}}();return await _(e.connection)?e:(console.log("[RedisConfig] Redis connection failed, using memory fallback"),T())}class C{async initialize(){this.initialized||(this.redisConfig=await P(),this.redisConfig.isAvailable?console.log(`[QueueManager] Using Redis (${this.redisConfig.type})`):(this.useMemoryFallback=!0,console.log("[QueueManager] Using memory fallback (Redis unavailable)")),this.initialized=!0)}async createQueue(e){this.initialized||await this.initialize();let{name:t,concurrency:a=1,processor:s}=e;if(this.useMemoryFallback||!this.redisConfig?.isAvailable){let e=new F(t,{concurrency:a});if(s){let a=async e=>s({id:e.id,data:e.data,progress:e.progress??0,updateProgress:async t=>{e.progress=t},log:async a=>{console.log(`[${t}:${e.id}] ${a}`)}});e.process(a)}return this.queues.set(t,e),e}let i=this.redisConfig.connection,r=new R.ci(t,{connection:i,defaultJobOptions:{removeOnComplete:50,removeOnFail:100,attempts:3,backoff:{type:"exponential",delay:2e3}}});if(this.queues.set(t,r),s){let e=new R.Cc(t,s,{connection:i,concurrency:a});this.workers.set(t,e)}let o=new R.Ji(t,{connection:i});return this.events.set(t,o),r}getQueue(e){return this.queues.get(e)}async addJob(e,t,a,s){let i=this.getQueue(e);if(!i)throw Error(`Queue '${e}' not found`);return i.add(t,a,s)}async getQueueStats(e){let t=this.getQueue(e);if(!t)throw Error(`Queue '${e}' not found`);if(t instanceof F)return t.getStats();let[a,s,i,r,o]=await Promise.all([t.getWaiting(),t.getActive(),t.getCompleted(),t.getFailed(),t.getDelayed()]);return{waiting:a.length,active:s.length,completed:i.length,failed:r.length,delayed:o.length,total:a.length+s.length+i.length+r.length+o.length}}async shutdown(){for(let e of this.workers.values())await e.close();for(let e of this.events.values())await e.close();for(let e of this.queues.values())await e.close();this.queues.clear(),this.workers.clear(),this.events.clear(),this.initialized=!1}constructor(){this.redisConfig=null,this.queues=new Map,this.workers=new Map,this.events=new Map,this.initialized=!1,this.useMemoryFallback=!1}}let A=new C;process.on("SIGTERM",async()=>{await A.shutdown(),process.exit(0)}),process.on("SIGINT",async()=>{await A.shutdown(),process.exit(0)});class z{constructor(){this.supabase=(()=>{try{let e=process.env.NEXT_PUBLIC_SUPABASE_URL||"",t=process.env.SUPABASE_SERVICE_ROLE_KEY||"";if(e&&t)return(0,s.createClient)(e,t)}catch(e){console.warn("[RenderQueue] supabase init falhou",e)}return null})(),this.progressCbs=new Map,this.initialized=!1;let e=null;try{let t=process.env.NEXT_PUBLIC_SUPABASE_URL||"",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"";t&&a&&(e=new E({supabaseUrl:t,supabaseServiceRoleKey:a,elevenLabsApiKey:process.env.ELEVENLABS_API_KEY,azureSubscriptionKey:process.env.AZURE_SPEECH_KEY,azureRegion:process.env.AZURE_SPEECH_REGION,defaultProvider:"elevenlabs",enableFallback:!0,enableCache:!0,maxRetries:3}))}catch(e){console.warn("[RenderQueue] TTS indispon\xedvel, ativando fallback silencioso",e)}this.tts=e}async initialize(){if(this.initialized)return;await A.initialize();let e="1"===process.env.RENDER_FORCE_MEMORY_QUEUE||"true"===process.env.RENDER_FORCE_MEMORY_QUEUE;await A.createQueue({name:"render-jobs",concurrency:Number(process.env.RENDER_CONCURRENCY||1),processor:async e=>this.processJob(e)}),console.log(`[RenderQueue] Initialized ${e?"(memory fallback)":""}`),this.initialized=!0}async addJob(e){this.initialized||await this.initialize(),await this.ensureJobRecord(e);let t=await A.addJob("render-jobs","render-video",e,{jobId:e.jobId,attempts:3,backoff:{type:"exponential",delay:5e3}});return await this.updateJobStatus(e.jobId,"queued",0),t.id}onProgress(e,t){let a=this.progressCbs.get(e)??new Set;return a.add(t),this.progressCbs.set(e,a),()=>{let a=this.progressCbs.get(e);a&&(a.delete(t),a.size||this.progressCbs.delete(e))}}async getJobStatus(e){try{if(this.supabase){let{data:t}=await this.supabase.from("render_jobs").select("status, progress, output_url, error_message").eq("id",e).maybeSingle();if(t)return{status:this.mapDbStatus(t.status),progress:t.progress??0,videoUrl:t.output_url??void 0,error:t.error_message??void 0}}}catch(e){console.warn("[RenderQueue] status supabase falhou",e)}let{fallbackStorage:t}=await a.e(2152).then(a.bind(a,42152)),s=t.getRenderJob(e);return s?{status:"pending"===s.status?"queued":s.status,progress:s.progress,videoUrl:s.videoUrl,error:s.error}:null}async processJob(e){let{jobId:t,projectId:a,userId:s,slides:l,config:c}=e.data,h=null;try{h=await (0,r.mkdtemp)((0,n.join)((0,o.tmpdir)(),"render-")),await this.updateJobStatus(t,"processing",0),await this.updateProject(a,{status:"processing"}),await this.emitProgress({jobId:t,phase:"generating_audio",progress:0,totalSlides:l.length});let e=await this.generateAudio(l,h,c);await this.emitProgress({jobId:t,phase:"generating_frames",progress:20,totalSlides:l.length});let i=(0,n.join)(h,"frames"),u=await this.generateFrames(l,i,c);await this.emitProgress({jobId:t,phase:"rendering_video",progress:50,totalSlides:l.length,totalFrames:u});let d=(0,n.join)(h,"output.mp4");await this.renderVideo(i,e,d,c,u,t),await this.emitProgress({jobId:t,phase:"uploading",progress:90,totalSlides:l.length});let p=await this.uploadVideo(d,a,s);await this.emitProgress({jobId:t,phase:"generating_thumbnails",progress:92,totalSlides:l.length}),await this.generateThumbnails(d,a,s),await this.updateJobStatus(t,"completed",100,p),await this.updateProject(a,{status:"completed",videoUrl:p}),await this.emitProgress({jobId:t,phase:"completed",progress:100,totalSlides:l.length})}catch(s){throw await this.updateJobStatus(t,"failed",0,void 0,s?.message),await this.updateProject(a,{status:"failed"}),await this.emitProgress({jobId:t,phase:"failed",progress:0,totalSlides:e.data.slides.length,error:s?.message}),s}finally{h&&(0,i.existsSync)(h)&&await (0,r.rm)(h,{recursive:!0,force:!0}).catch(()=>void 0)}}async ensureJobRecord(e){let t={id:e.jobId,project_id:e.projectId,user_id:e.userId,status:"pending",progress:0,settings:e.config??{},created_at:new Date().toISOString(),updated_at:new Date().toISOString()};try{if(!this.supabase)throw Error("Supabase not configured");let{error:e}=await this.supabase.from("render_jobs").insert(t);if(e)throw e}catch(s){let{fallbackStorage:t}=await a.e(2152).then(a.bind(a,42152));t.createRenderJob({id:e.jobId,status:"pending",progress:0,videoUrl:void 0,error:void 0,projectId:e.projectId,userId:e.userId,settings:e.config})}}async generateAudio(e,t,a){if(!this.tts)return"";let s=(0,n.join)(t,"combined-audio.mp3"),i=[];for(let t of e){let e=[t.title,...t.content.map(e=>e.text)].filter(Boolean).join(". ");if(!e)continue;let s=await this.tts.generateAudio({text:e,provider:a.audioProvider,voiceId:a.voiceId,saveToStorage:!1}),r=s.audio||s.audioBuffer;r&&r instanceof Buffer&&i.push(r)}return i.length?(await (0,r.writeFile)(s,Buffer.concat(i)),s):""}async generateFrames(e,t,a){let s=f(a.quality||"standard"),i=a.fps||s.fps,r=a.resolution||s.resolution,o=new p({width:r.width,height:r.height,fps:i,quality:.9,outputDir:t,tempDir:t}),n=e.map((e,t)=>({id:e.id,title:e.title,content:e.content.map(e=>e.text),images:[],background:"#ffffff",duration:e.duration||5,order:t})),l="none"!==a.transition?{type:a.transition,duration:1}:void 0;return(await o.generateFrames(n,l)).totalFrames}async renderVideo(e,t,a,s,r,o){let n=f(s.quality||"standard"),l=s.fps||n.fps,c=s.resolution||n.resolution,d=new h({preset:n.ffmpegConfig.preset,crf:n.ffmpegConfig.crf,codec:"h264",pixelFormat:"yuv420p",audioCodec:"aac",audioBitrate:"192k"}),p={framesDir:e,audioPath:t&&(0,i.existsSync)(t)?t:void 0,outputPath:a,fps:l,width:c.width,height:c.height,onProgress:e=>this.emitProgress({jobId:o,phase:"rendering_video",progress:50+e.percent/100*40,totalSlides:0,fps:e.currentFps,frame:e.currentFrame,totalFrames:r})};await d.render(p),await u(e)}async uploadVideo(e,t,a){let s=await (0,r.readFile)(e),i=`${t}_${Date.now()}.mp4`;if(this.supabase)try{let e=`${a}/${i}`,{error:t}=await this.supabase.storage.from("videos").upload(e,s,{contentType:"video/mp4",upsert:!0});if(t)throw Error(t.message);let{data:r}=this.supabase.storage.from("videos").getPublicUrl(e);return r.publicUrl}catch(e){console.warn("[RenderQueue] upload supabase falhou, fallback local",e)}let o=(0,n.join)(process.cwd(),"public","videos");return await (0,r.mkdir)(o,{recursive:!0}),await (0,r.writeFile)((0,n.join)(o,i),s),`/videos/${i}`}async generateThumbnails(e,t,a){try{let a=new b({supabaseUrl:process.env.NEXT_PUBLIC_SUPABASE_URL||"",supabaseKey:process.env.SUPABASE_SERVICE_ROLE_KEY||""}),s=await (0,r.mkdtemp)((0,n.join)((0,o.tmpdir)(),"thumbs-"));try{let i=await a.generateThumbnails(e,s,{uploadToStorage:!0,format:"jpeg",quality:85});if(i.success&&i.thumbnails.length&&this.supabase){let e={};i.thumbnails.forEach(t=>{t.url&&(e[t.size]=t.url)}),Object.keys(e).length&&await this.supabase.from("projects").update({thumbnail_urls:e}).eq("id",t).throwOnError()}}finally{await (0,r.rm)(s,{recursive:!0,force:!0}).catch(()=>void 0)}}catch(e){console.warn("[RenderQueue] thumbnails skipped",e)}}async updateJobStatus(e,t,s,i,r){let o={status:t,progress:s,updated_at:new Date().toISOString()};i&&(o.output_url=i),r&&(o.error_message=r),"completed"===t&&(o.completed_at=new Date().toISOString()),"processing"===t&&(o.started_at=new Date().toISOString());try{if(!this.supabase)throw Error("Supabase not configured");let{error:t}=await this.supabase.from("render_jobs").update(o).eq("id",e);if(t)throw t}catch(n){let{fallbackStorage:o}=await a.e(2152).then(a.bind(a,42152));o.updateRenderJob(e,{status:t,progress:s,videoUrl:i,error:r})}}async emitProgress(e){let t=this.progressCbs.get(e.jobId);if(t)for(let a of t)try{a(e)}catch(e){console.warn("[RenderQueue] progress cb erro",e)}let{fallbackStorage:s}=await a.e(2152).then(a.bind(a,42152));s.updateRenderJob(e.jobId,{status:"failed"===e.phase?"failed":"completed"===e.phase?"completed":"processing",progress:Math.min(100,Math.max(0,Math.round(e.progress))),error:e.error})}mapDbStatus(e){return"processing"===e?"processing":"completed"===e?"completed":"failed"===e?"failed":"queued"}async updateProject(e,t){let s={updated_at:new Date().toISOString()};t.status&&(s.status=t.status),void 0!==t.videoUrl&&(s.video_url=t.videoUrl);try{if(!this.supabase)throw Error("Supabase not configured");let{error:t}=await this.supabase.from("projects").update(s).eq("id",e);if(t)throw t}catch(i){let{fallbackStorage:s}=await a.e(2152).then(a.bind(a,42152));s.updateProject(e,{status:t.status,video_url:t.videoUrl??void 0})}}}let M=null;function k(){return M||(M=new z),M}}};