name: Nightly Health Check

on:
  schedule:
    - cron: '0 */4 * * *'  # A cada 4 horas
  workflow_dispatch:       # Permite trigger manual

jobs:
  health-check:
    name: Monitor Production Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Production Health
        id: healthcheck
        run: |
          RESPONSE=$(curl -s -o /tmp/health.json -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/health)
          
          echo "status_code=$RESPONSE" >> $GITHUB_OUTPUT
          
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… Health check passed"
            cat /tmp/health.json | jq .
          else
            echo "âŒ Health check failed with status $RESPONSE"
            cat /tmp/health.json | jq . || echo "No JSON response"
            exit 1
          fi
      
      - name: Parse Health Status
        if: always()
        run: |
          if [ -f /tmp/health.json ]; then
            STATUS=$(cat /tmp/health.json | jq -r '.status')
            DB_STATUS=$(cat /tmp/health.json | jq -r '.checks.database.status')
            DB_LATENCY=$(cat /tmp/health.json | jq -r '.checks.database.latency_ms')
            REDIS_STATUS=$(cat /tmp/health.json | jq -r '.checks.redis.status')
            REDIS_LATENCY=$(cat /tmp/health.json | jq -r '.checks.redis.latency_ms')
            
            echo "Overall Status: $STATUS"
            echo "Database: $DB_STATUS (${DB_LATENCY}ms)"
            echo "Redis: $REDIS_STATUS (${REDIS_LATENCY}ms)"
            
            # Criar badge dinÃ¢mico
            if [ "$STATUS" = "healthy" ]; then
              echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
              echo "BADGE_MESSAGE=healthy" >> $GITHUB_ENV
            else
              echo "BADGE_COLOR=red" >> $GITHUB_ENV
              echo "BADGE_MESSAGE=unhealthy" >> $GITHUB_ENV
            fi
          fi
      
      - name: Alert on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ Production health check failed",
              attachments: [{
                color: 'danger',
                text: `Status Code: ${{ steps.healthcheck.outputs.status_code }}\nCheck details at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Create Health Report Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Production Health Check Failed',
              body: `## Health Check Failure\n\n**Status Code:** ${{ steps.healthcheck.outputs.status_code }}\n**Timestamp:** ${new Date().toISOString()}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n### Action Required\nInvestigate production health issues immediately.`,
              labels: ['alert', 'production', 'health-check']
            })
            console.log('Created issue:', response.data.html_url)
      
      - name: Update Health Status Badge
        if: always()
        run: |
          # Opcional: atualizar badge dinÃ¢mico via shields.io endpoint
          echo "Health status: ${BADGE_MESSAGE}"
