name: Nightly

on:
  schedule:
    - cron: '0 5 * * *' # 05:00 UTC (~02:00 BRT)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Nightly Quality (typecheck/lint/any)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Type-check
        run: npm run type-check
      - name: Lint
        run: npm run lint
      - name: Any audit (fail on findings)
        run: npm run quality:any
      - name: Upload any-report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-any-report
          path: evidencias/fase-1/any-report.json
          if-no-files-found: warn
      - name: Collect BullMQ metrics snapshot
        run: npx ts-node scripts/collect-queue-metrics.ts > nightly-bullmq-metrics.json || echo "bullmq metrics failed"
      - name: Upload BullMQ metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-bullmq-metrics
          path: nightly-bullmq-metrics.json
          if-no-files-found: warn
      - name: Export Supabase dashboard snapshot
        run: npx ts-node scripts/export-supabase-dashboard.ts || echo "supabase export failed"
      - name: Upload Supabase dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-supabase-dashboard
          path: evidencias/fase-2/supabase-dashboard.json
          if-no-files-found: warn

  tests:
    name: Nightly Tests (matrix)
    runs-on: ubuntu-latest
    needs: [quality]
    strategy:
      fail-fast: false
      matrix:
        suite: [contract, pptx, bullmq, e2e]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root dependencies
        run: npm ci
      - name: Run API Contract tests
        if: matrix.suite == 'contract'
        run: npm run test:contract
        env:
          CI: true
      - name: Upload contract suite evidence
        if: always() && matrix.suite == 'contract'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-contract-suite-result
          path: |
            evidencias/fase-2/contract-suite-result.json
            evidencias/fase-2/contract-report.md
          if-no-files-found: warn
      - name: Install app dependencies (Jest)
        if: matrix.suite == 'pptx'
        run: npm ci --prefix ./estudio_ia_videos/app
      - name: Run PPTX Jest suite
        if: matrix.suite == 'pptx'
        run: npm run test:suite:pptx
        env:
          CI: true
      - name: Run BullMQ metrics polling test
        if: matrix.suite == 'bullmq'
        run: npx jest __tests__/lib/services/bullmq-metrics.test.ts --no-coverage
        env:
          CI: true
      - name: Upload BullMQ test evidence
        if: always() && matrix.suite == 'bullmq'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-bullmq-metrics-test-log
          path: jest*.log
          if-no-files-found: ignore
      - name: Run Playwright E2E smoke
        if: matrix.suite == 'e2e'
        run: |
          npm ci --prefix ./estudio_ia_videos
          npx playwright test --config=playwright.config.ts --reporter=list
        env:
          CI: true
          E2E_BASE_URL: 'http://localhost:3000'
      - name: Upload Playwright report (nightly)
        if: always() && matrix.suite == 'e2e'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-playwright-report
          path: evidencias/fase-2/playwright-report
          if-no-files-found: warn
  bullmq-alerts:
    name: Nightly BullMQ Alerts
    runs-on: ubuntu-latest
    needs: [tests]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run alert check (non-fail)
        run: npx ts-node scripts/alerts/bullmq-alerts.ts || echo "alert script completed with issues"
