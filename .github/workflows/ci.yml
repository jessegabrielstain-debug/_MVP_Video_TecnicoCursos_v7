name: CI/CD Pipeline

on:
  push:
    branches: [ main, consolidation/modules ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality (TypeCheck + Lint + Any Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Type Check
        run: npm run type-check
      - name: Strict Type Check (non-blocking)
        run: npm run ci:strict
      - name: Lint
        run: npm run lint
      - name: Audit any
        run: npm run quality:any
      - name: Upload any report artifact
        uses: actions/upload-artifact@v4
        with:
          name: any-report
          path: evidencias/fase-1/any-report.json
          if-no-files-found: warn
      - name: Env validation (non-blocking)
        run: npm run validate:env || echo "validate:env warnings"
      - name: RLS audit (non-blocking)
        run: npm run audit:rls || echo "rls-audit warnings"
      - name: Collect BullMQ metrics snapshot
        run: npx ts-node scripts/collect-queue-metrics.ts > bullmq-metrics.json || echo "bullmq metrics collection failed"
      - name: Upload BullMQ metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: bullmq-metrics
          path: bullmq-metrics.json
          if-no-files-found: warn
      - name: Export Supabase dashboard snapshot
        run: npx ts-node scripts/export-supabase-dashboard.ts || echo "supabase export failed"
      - name: Upload Supabase dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-dashboard
          path: evidencias/fase-2/supabase-dashboard.json
          if-no-files-found: warn

  tests:
    name: Tests (matrix)
    runs-on: ubuntu-latest
    needs: [quality]
    strategy:
      fail-fast: false
      matrix:
        suite: [contract, pptx, bullmq, e2e]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root dependencies
        run: npm ci
      - name: Run API Contract tests
        if: matrix.suite == 'contract'
        run: npm run test:contract
        env:
          CI: true
      - name: Upload contract suite evidence
        if: always() && matrix.suite == 'contract'
        uses: actions/upload-artifact@v4
        with:
          name: contract-suite-result
          path: |
            evidencias/fase-2/contract-suite-result.json
            evidencias/fase-2/contract-report.md
          if-no-files-found: warn
      - name: Install app dependencies (Jest)
        if: matrix.suite == 'pptx'
        run: npm ci --prefix ./estudio_ia_videos/app
      - name: Run PPTX Jest suite
        if: matrix.suite == 'pptx'
        run: npm run test:suite:pptx
        env:
          CI: true
      - name: Run BullMQ metrics polling test
        if: matrix.suite == 'bullmq'
        run: npx jest __tests__/lib/services/bullmq-metrics.test.ts --no-coverage
        env:
          CI: true
      - name: Upload BullMQ test evidence
        if: always() && matrix.suite == 'bullmq'
        uses: actions/upload-artifact@v4
        with:
          name: bullmq-metrics-test-log
          path: jest*.log
          if-no-files-found: ignore
      - name: Upload PPTX suite evidence
        if: always() && matrix.suite == 'pptx'
        uses: actions/upload-artifact@v4
        with:
          name: pptx-suite-result
          path: |
            evidencias/fase-2/pptx-suite-result.json
            evidencias/fase-2/pptx-tests-results.md
            evidencias/fase-2/cobertura.md
          if-no-files-found: warn
      - name: Upload coverage (app)
        if: always() && matrix.suite == 'pptx'
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-app
          path: estudio_ia_videos/app/coverage
          if-no-files-found: warn
      - name: Run Playwright E2E smoke
        if: matrix.suite == 'e2e'
        run: |
          npm ci --prefix ./estudio_ia_videos
          npx playwright test --config=playwright.config.ts --reporter=list
        env:
          CI: true
          E2E_BASE_URL: 'http://localhost:3000'
      - name: Upload Playwright report (e2e)
        if: always() && matrix.suite == 'e2e'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: evidencias/fase-2/playwright-report
          if-no-files-found: warn

  security:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
