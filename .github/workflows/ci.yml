name: CI/CD Pipeline

on:
  push:
    branches: [ main, consolidation/modules ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality (TypeCheck + Lint + Any Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Type Check
        run: npm run type-check
      - name: Strict Type Check (non-blocking)
        run: npm run ci:strict
      - name: Lint
        run: npm run lint
      - name: Audit any
        run: npm run quality:any
      - name: Upload any report artifact
        uses: actions/upload-artifact@v4
        with:
          name: any-report
          path: evidencias/fase-1/any-report.json
          if-no-files-found: warn
      - name: Env validation (non-blocking)
        run: npm run validate:env || echo "validate:env warnings"
      - name: RLS audit (non-blocking)
        run: npm run audit:rls || echo "rls-audit warnings"
      - name: Collect BullMQ metrics snapshot
        run: npx ts-node scripts/collect-queue-metrics.ts > bullmq-metrics.json || echo "bullmq metrics collection failed"
      - name: Upload BullMQ metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: bullmq-metrics
          path: bullmq-metrics.json
          if-no-files-found: warn
      - name: Export Supabase dashboard snapshot
        run: npx ts-node scripts/export-supabase-dashboard.ts || echo "supabase export failed"
      - name: Upload Supabase dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-dashboard
          path: evidencias/fase-2/supabase-dashboard.json
          if-no-files-found: warn

  tests:
    name: Tests (matrix)
    runs-on: ubuntu-latest
    needs: [quality]
    strategy:
      fail-fast: false
      matrix:
        suite: [contract, pptx, services, rbac-unit, e2e-smoke, e2e-rbac]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root dependencies
        run: npm ci
      
      # Contract tests
      - name: Run API Contract tests
        if: matrix.suite == 'contract'
        run: npm run test:contract
        env:
          CI: true
      - name: Upload contract suite evidence
        if: always() && matrix.suite == 'contract'
        uses: actions/upload-artifact@v4
        with:
          name: contract-suite-result
          path: |
            evidencias/fase-2/contract-suite-result.json
            evidencias/fase-2/contract-report.md
          if-no-files-found: warn
      
      # PPTX system tests
      - name: Install app dependencies (Jest)
        if: matrix.suite == 'pptx'
        run: npm ci --prefix ./estudio_ia_videos/app
      - name: Run PPTX Jest suite
        if: matrix.suite == 'pptx'
        run: npm run test:suite:pptx
        env:
          CI: true
      - name: Upload PPTX suite evidence
        if: always() && matrix.suite == 'pptx'
        uses: actions/upload-artifact@v4
        with:
          name: pptx-suite-result
          path: |
            evidencias/fase-2/pptx-suite-result.json
            evidencias/fase-2/pptx-tests-results.md
            evidencias/fase-2/cobertura.md
          if-no-files-found: warn
      - name: Upload coverage (app)
        if: always() && matrix.suite == 'pptx'
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-app
          path: estudio_ia_videos/app/coverage
          if-no-files-found: warn
      
      # Services unit tests (Redis, Queue, Logger)
      - name: Run Services Unit Tests
        if: matrix.suite == 'services'
        run: npm run test:services
        env:
          CI: true
      - name: Upload services test evidence
        if: always() && matrix.suite == 'services'
        uses: actions/upload-artifact@v4
        with:
          name: services-test-results
          path: |
            evidencias/fase-2/services-test-*.json
            coverage/
          if-no-files-found: warn
      
      # RBAC unit tests
      - name: Run RBAC Unit Tests
        if: matrix.suite == 'rbac-unit'
        run: npm run test:rbac
        env:
          CI: true
      - name: Upload RBAC unit test evidence
        if: always() && matrix.suite == 'rbac-unit'
        uses: actions/upload-artifact@v4
        with:
          name: rbac-unit-test-results
          path: |
            evidencias/fase-5/rbac-unit-*.json
            coverage/
          if-no-files-found: warn
      
      # E2E smoke tests
      - name: Install Playwright
        if: matrix.suite == 'e2e-smoke'
        run: npx playwright install --with-deps chromium
      - name: Run Playwright E2E smoke
        if: matrix.suite == 'e2e-smoke'
        run: npx playwright test tests/e2e/video-flow.spec.ts --reporter=list
        env:
          CI: true
          E2E_BASE_URL: 'http://localhost:3000'
          E2E_SKIP_SERVER: 'true'
      - name: Upload Playwright smoke report
        if: always() && matrix.suite == 'e2e-smoke'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: evidencias/fase-2/playwright-report
          if-no-files-found: warn
      
      # E2E RBAC tests
      - name: Install Playwright
        if: matrix.suite == 'e2e-rbac'
        run: npx playwright install --with-deps chromium
      - name: Run Playwright E2E RBAC
        if: matrix.suite == 'e2e-rbac'
        run: npx playwright test tests/e2e/rbac-complete.spec.ts --reporter=list
        env:
          CI: true
          E2E_BASE_URL: 'http://localhost:3000'
          E2E_SKIP_SERVER: 'true'
      - name: Upload Playwright RBAC report
        if: always() && matrix.suite == 'e2e-rbac'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-rbac-report
          path: evidencias/fase-5/playwright-rbac-report
          if-no-files-found: warn

  security:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
